!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){(function(t,n,i){var o;o=function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)},o=function(){return(o=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function s(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function a(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var c,u,d,l=1,h={nextValue:function(){return(l=(9301*l+49297)%233280)/233280},seed:function(e){l=e}},p="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function f(){d=!1}function m(e){if(e){if(e!==c){if(e.length!==p.length)throw new Error("Custom alphabet for shortid must be "+p.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,r){return t!==r.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+p.length+" unique characters. These characters were not unique: "+t.join(", "));c=e,f()}}else c!==p&&(c=p,f())}function g(){return d||(d=function(){c||m(p);for(var e,t=c.split(""),r=[],n=h.nextValue();t.length>0;)n=h.nextValue(),e=Math.floor(n*t.length),r.push(t.splice(e,1)[0]);return r.join("")}())}var v,y,w={get:function(){return c||p},characters:function(e){return m(e),c},seed:function(e){h.seed(e),u!==e&&(f(),u=e)},lookup:function(e){return g()[e]},shuffled:g},b="object"==typeof window&&(window.crypto||window.msCrypto),I=b&&b.getRandomValues?function(e){return b.getRandomValues(new Uint8Array(e))}:function(e){for(var t=[],r=0;r<e;r++)t.push(Math.floor(256*Math.random()));return t},k=function(e,t,r){for(var n=(2<<Math.log(t.length-1)/Math.LN2)-1,i=-~(1.6*n*r/t.length),o="";;)for(var s=e(i),a=i;a--;)if((o+=t[s[a]&n]||"").length===+r)return o},S=function(e){for(var t,r=0,n="";!t;)n+=k(I,w.get(),1),t=e<Math.pow(16,r+1),r++;return n},x=function(e){var t="",r=Math.floor(.001*(Date.now()-1567752802062));return r===y?v++:(v=0,y=r),t+=S(7),t+=S(e),v>0&&(t+=S(v)),t+=S(r)},W=function(e){return!(!e||"string"!=typeof e||e.length<6||new RegExp("[^"+w.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(e))},C=function(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}((function(e){var t=0;function r(){return x(t)}e.exports=r,e.exports.generate=r,e.exports.seed=function(t){return w.seed(t),e.exports},e.exports.worker=function(r){return t=r,e.exports},e.exports.characters=function(e){return void 0!==e&&w.characters(e),w.shuffled()},e.exports.isValid=W})),T=function(){function e(e,t,r,n){this.id=e,this.name=t,this.control=r,this.windows=n}return e.prototype.getURL=function(){var e;return s(this,void 0,void 0,(function(){var t;return a(this,(function(r){switch(r.label){case 0:return[4,this.callControl("getURL",{})];case 1:return t=r.sent(),[2,null===(e=null==t?void 0:t.returned)||void 0===e?void 0:e._value]}}))}))},e.prototype.moveResize=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,this.callControl("moveResize",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.close=function(){return s(this,void 0,void 0,(function(){var e=this;return a(this,(function(t){return[2,new Promise((function(t,r){var n=function(){o&&clearTimeout(o),i&&i()},i=e.windows.onWindowRemoved((function(r){r.id===e.id&&(t(e),n())})),o=setTimeout((function(){r("can not close window - probably not opened by your window"),n()}),1e3);e.callControl("close",{},!0).catch((function(){}))}))]}))}))},e.prototype.setTitle=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return"string"==typeof e&&(e={title:e}),[4,this.callControl("setTitle",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.resizeTo=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return[4,this.callControl("moveResize",{width:e,height:t},!0)];case 1:return r.sent(),[2,this]}}))}))},e.prototype.moveTo=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return[4,this.callControl("moveResize",{top:e,left:t},!0)];case 1:return r.sent(),[2,this]}}))}))},e.prototype.getBounds=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,e.sent().returned]}}))}))},e.prototype.getContext=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,e.sent().returned]}}))}))},e.prototype.getTitle=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,e.sent().returned._value]}}))}))},e.prototype.onContextUpdated=function(e){throw new Error("Method not implemented.")},e.prototype.updateContext=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,this.callControl("updateContext",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.setContext=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,this.callControl("setContext",e,!0)];case 1:return t.sent(),[2,this]}}))}))},e.prototype.callControl=function(e,t,r){return void 0===r&&(r=!1),s(this,void 0,void 0,(function(){return a(this,(function(n){switch(n.label){case 0:return[4,this.control.send({command:e,domain:"windows",args:t,skipResult:r},{windowId:this.id})];case 1:return[2,n.sent()]}}))}))},e}();function E(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t){var n=r[e];return n||(n=[],r[e]=n),n.push(t),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}E.default=E;var _=E,M=function(){function e(){this.callbacks={},this.registry=_()}return e.prototype.start=function(t,r){return s(this,void 0,void 0,(function(){var n=this;return a(this,(function(i){switch(i.label){case 0:return this.interop=t,this.logger=r,[4,this.interop.register(e.CONTROL_METHOD,(function(e){return s(n,void 0,void 0,(function(){var t,n,i;return a(this,(function(o){return t=e,r.trace("received control command "+JSON.stringify(t)),"windows"===t.domain?this.myWindow?(n=this.myWindow[t.command].call(this.myWindow,t.args),t.skipResult?[2,{}]:[2,n]):[2]:"appManager"===t.domain?this.myInstance?(n=this.myInstance[t.command].call(this.myInstance,t.args),t.skipResult?[2,{}]:[2,n]):[2]:("layouts"===t.domain&&(i=this.callbacks[t.domain])&&i(t),[2])}))}))}))];case 1:return i.sent(),this.registry.execute("started"),[2]}}))}))},e.prototype.send=function(t,r){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(t)+" to "+JSON.stringify(r)+"}"),this.interop.invoke(e.CONTROL_METHOD,t,r)},e.prototype.subscribe=function(e,t){this.callbacks[e]=t},e.prototype.setLocalWindow=function(e){this.myWindow=e},e.prototype.setLocalInstance=function(e){this.myInstance=e},e.prototype.onStart=function(e){return this.registry.add("started",e)},e.CONTROL_METHOD="GC.Control",e}(),A=function(){function e(e,t,r,n,i){this.id=e,this.name=t,this.window=r,this.control=n,this.interop=i,this.context={},this.registry=_(),n.setLocalWindow(this)}return e.prototype.getURL=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){return[2,this.window.location.href]}))}))},e.prototype.moveResize=function(e){var t=e.left,r=e.top,n=e.width,i=e.height;return s(this,void 0,void 0,(function(){return a(this,(function(e){return t=null!=t?t:window.screenLeft,r=null!=r?r:window.screenTop,n=null!=n?n:window.outerWidth,i=null!=i?i:window.outerHeight,window.moveTo(t,r),window.resizeTo(n,i),[2,this]}))}))},e.prototype.close=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(e){console.log("what")}return[2,this]}))}))},e.prototype.setTitle=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){return"object"==typeof e&&null!==e&&(e=e.title),document.title=e,[2,this]}))}))},e.prototype.resizeTo=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return[4,this.moveResize({width:e,height:t})];case 1:return r.sent(),[2,this]}}))}))},e.prototype.moveTo=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return[4,this.moveResize({top:e,left:t})];case 1:return r.sent(),[2,this]}}))}))},e.prototype.getBounds=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){return[2,this.getBoundsSync()]}))}))},e.prototype.getContext=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){return[2,this.getContextSync()]}))}))},e.prototype.getContextSync=function(){return this.context},e.prototype.getTitle=function(){return s(this,void 0,void 0,(function(){return a(this,(function(e){return[2,this.window.document.title]}))}))},e.prototype.onContextUpdated=function(e){return this.registry.add("context-updated",e)},e.prototype.updateContext=function(e){var t=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",e,t),Promise.resolve(this)},e.prototype.setContext=function(e){return s(this,void 0,void 0,(function(){var t;return a(this,(function(r){return t=this.context,this.context=Object.assign({},e),this.registry.execute("context-updated",e,t),[2,Promise.resolve(this)]}))}))},e.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},e}(),P=function(t){function r(e,r,n,i,o){var s=t.call(this,r,n,i,o)||this;return s.window=e,s.id=r,s.name=n,s}return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}(r,t),r}(T),L=function(e){return'"GC.Wnd."'+e},D=function(){function e(e,t){this.interop=e,this.control=t,this.registry=_(),this.childWindows=[];var r=e.instance.windowId,n="document.title ("+C()+")";this.myWindow=new A(r,n,window,this.control,this.interop),this.trackWindowsLifetime()}return e.prototype.list=function(){var e=this,t=this.interop.methods({name:M.CONTROL_METHOD})[0];return t?(t.getServers?t.getServers():[]).reduce((function(t,r){var n=e.remoteFromServer(r);return n&&t.push(n),t}),[]):[]},e.prototype.findById=function(e){return this.list().find((function(t){return t.id===e}))},e.prototype.my=function(){return this.myWindow},e.prototype.open=function(e,t,r){var n,i,o,c,u;return s(this,void 0,void 0,(function(){var s,d,l,h,p,f,m,g,v,y,w,b,I;return a(this,(function(a){switch(a.label){case 0:return s=null!==(n=null==r?void 0:r.width)&&void 0!==n?n:400,d=null!==(i=null==r?void 0:r.height)&&void 0!==i?i:400,l=null!==(o=null==r?void 0:r.left)&&void 0!==o?o:window.screen.availWidth-window.screenLeft,h=null!==(c=null==r?void 0:r.top)&&void 0!==c?c:0,p=C(),function(e,t,r,n,i){var o,s=L(r),a={context:null!==(o=null==i?void 0:i.context)&&void 0!==o?o:{},name:n,parent:t};e.register(s,(function(){return a}))}(this.interop,this.my().id,p,e,r),(null==r?void 0:r.relativeTo)?(f=r.relativeTo,(m=this.list().find((function(e){return e.id===f})))?[4,m.getBounds()]:[3,2]):[3,2];case 1:g=a.sent(),v=null!==(u=r.relativeDirection)&&void 0!==u?u:"right",y=this.getRelativeBounds({width:s,height:d,left:l,top:h},g,v),s=y.width,d=y.height,l=y.left,h=y.top,a.label=2;case 2:if(w="width="+s+",height="+d+",left="+l+",top="+h+",scrollbars=none,location=no,status=no,menubar=no",!(b=window.open(t,p,w)))throw new Error("failed to open a window with url="+t+" and options="+w);return b.moveTo(l,h),b.resizeTo(s,d),I=new P(b,p,e,this.control,this),this.childWindows.push(I),[2,I]}}))}))},e.prototype.onWindowAdded=function(e){return this.registry.add("window-added",e)},e.prototype.onWindowRemoved=function(e){return this.registry.add("window-removed",e)},e.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(e){return!e.window.closed})),this.childWindows},e.prototype.remoteFromServer=function(e){var t;if(e.windowId)return new T(e.windowId,null!==(t=e.application)&&void 0!==t?t:"",this.control,this)},e.prototype.getRelativeBounds=function(e,t,r){switch(r){case"bottom":return{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height};case"top":return{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height};case"right":return{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height};case"left":return{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height}}throw new Error("invalid relativeDirection")},e.prototype.trackWindowsLifetime=function(){var e=this;this.interop.serverMethodAdded((function(t){var r=t.server;if(t.method.name===M.CONTROL_METHOD){var n=e.remoteFromServer(r);n&&e.registry.execute("window-added",n)}})),this.interop.serverRemoved((function(t){var r=e.remoteFromServer(t);r&&e.registry.execute("window-removed",r)}))},e}(),j=function(e){return{ok:!0,result:e}},O=function(e){return{ok:!1,error:e}},R=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},F=function(e,t){return!0===t.ok?t.result:e},N=function(e){if(!0===e.ok)return e.result;throw e.error},B=function(e,t){return!0===t.ok?j(e(t.result)):t},U=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:j(e(t.result,r.result))},z=function(e,t){return!0===t.ok?t:O(e(t.error))},G=function(e,t){return!0===t.ok?e(t.result):t},q=(Object.freeze({ok:j,isOk:function(e){return!0===e.ok},err:O,isErr:function(e){return!1===e.ok},asPromise:R,withDefault:F,withException:N,successes:function(e){return e.reduce((function(e,t){return!0===t.ok?e.concat(t.result):e}),[])},map:B,map2:U,mapError:z,andThen:G}),function(){return(q=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)}),H=function(e){return Array.isArray(e)},J=function(e){return"object"==typeof e&&null!==e&&!H(e)},K=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},$=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},Y=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return q({at:e+(r||"")},n)},V=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return z((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return R(r.run(e))},this.runWithException=function(e){return N(r.run(e))},this.map=function(t){return new e((function(e){return B(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return G((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?j(e):O({message:K("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?j(e):O({message:K("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?j(e):O({message:K("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return function e(t,r){if(t===r)return!0;if(null===t&&null===r)return!0;if(typeof t!=typeof r)return!1;if("object"==typeof t){if(Array.isArray(t)){if(!Array.isArray(r))return!1;if(t.length!==r.length)return!1;for(var n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1;return!0}var i=Object.keys(t);if(i.length!==Object.keys(r).length)return!1;for(n=0;n<i.length;n++){if(!r.hasOwnProperty(i[n]))return!1;if(!e(t[i[n]],r[i[n]]))return!1}return!0}}(e,t)?j(t):O({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(J(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?O({message:"the key '"+n+"' is required but was not present"}):O(Y("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return j(r)}return J(e)?j(e):O({message:K("an object",e)})}))},e.array=function(t){return new e((function(e){return H(e)&&t?e.reduce((function(e,r,n){return U((function(e,t){return e.concat([t])}),e,function(e,r){return z((function(e){return Y("["+r+"]",e)}),t.decode(e))}(r,n))}),j([])):H(e)?j(e):O({message:K("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(H(e)){if(e.length!==t.length)return O({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return O(Y("["+n+"]",i.error));r[n]=i.result}return j(r)}return O({message:K("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return U(Object.assign,t,r.decode(e))}),j({}))}))},e.anyJson=function(){return new e((function(e){return j(e)}))},e.unknownJson=function(){return new e((function(e){return j(e)}))},e.dict=function(t){return new e((function(e){if(J(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return O(Y("."+n,i.error));r[n]=i.result}return j(r)}return O({message:K("an object",e)})}))},e.optional=function(t){return new e((function(e){return void 0===e?j(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return O({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return j(F(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return O({at:$(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!J(n))return O({at:$(t.slice(0,i+1)),message:K("an object",n)});if("number"==typeof t[i]&&!H(n))return O({at:$(t.slice(0,i+1)),message:K("an array",n)});n=n[t[i]]}return z((function(e){return void 0===n?{at:$(t),message:"path does not exist"}:Y($(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return j(t)}))},e.fail=function(t){return new e((function(e){return O({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),X=V.string,Z=V.number,Q=V.boolean,ee=V.anyJson,te=V.constant,re=V.object,ne=V.array,ie=V.optional,oe=V.oneOf,se=V.lazy,ae=X().where((function(e){return e.length>0}),"Expected a non-empty string"),ce=re({type:te("window"),config:re({appName:ae,url:ie(ae)})}),ue=re({type:te("group"),config:ee(),children:ne(oe(ce))}),de=re({type:te("column"),config:ee(),children:ne(oe(ue,ce,se((function(){return de})),se((function(){return le}))))}),le=re({type:te("row"),config:ee(),children:ne(oe(de,ue,ce,se((function(){return le}))))}),he=re({type:te("Workspace"),state:re({config:ee(),children:ne(oe(le,de,ue,ce))})}),pe=re({type:te("window"),componentType:te("application"),state:re({name:ee(),context:ee(),url:ae,bounds:ee(),id:ae,parentId:ie(ae),main:Q()})}),fe=oe(te("Global"),te("Workspace")),me=re({name:ae,context:ie(ee()),metadata:ie(ee())}),ge=re({name:ae,context:ie(ee()),closeRunningInstance:ie(Q())}),ve=re({name:ae,type:fe,context:ie(ee()),metadata:ie(ee()),components:ne(oe(he,pe))}),ye=function(){function e(e){this.controller=e}return e.prototype.getAll=function(e){return fe.runWithException(e),this.controller.getAll(e)},e.prototype.get=function(e,t){return ae.runWithException(e),fe.runWithException(t),this.controller.get(e,t)},e.prototype.export=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){return e&&fe.runWithException(e),[2,this.controller.export(e)]}))}))},e.prototype.import=function(e){return e.forEach((function(e){return ve.runWithException(e)})),this.controller.import(e)},e.prototype.save=function(e){return me.runWithException(e),this.controller.save(e)},e.prototype.restore=function(e){return ge.runWithException(e),this.controller.restore(e)},e.prototype.remove=function(e,t){return ae.runWithException(t),fe.runWithException(e),this.controller.remove(e,t)},e}(),we=function(){function e(e){this.contexts=e}return e.prototype.subscribe=function(e){this.callback=e},e.prototype.subscribeFor=function(e,t){if(!this.isChannel(e))return Promise.reject(new Error("Channel with name: "+e+" doesn't exist!"));var r=this.createContextName(e);return this.contexts.subscribe(r,(function(e,r,n,i,o){t(e.data,e,null==o?void 0:o.updaterId)}))},e.prototype.switchChannel=function(e){return s(this,void 0,void 0,(function(){var t,r,n=this;return a(this,(function(i){switch(i.label){case 0:return this.unsubscribe(),t=this.createContextName(e),r=this,[4,this.contexts.subscribe(t,(function(e,t,r,i,o){n.callback&&n.callback(e.data,e,null==o?void 0:o.updaterId)}))];case 1:return r.unsubscribeFunc=i.sent(),[2]}}))}))},e.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},e.prototype.add=function(e,t){var r=this.createContextName(e);return this.contexts.set(r,t)},e.prototype.all=function(){return this.contexts.all().filter((function(e){return e.startsWith("___channel___")})).map((function(e){return e.substr("___channel___".length)}))},e.prototype.getContextData=function(e){var t=this;return new Promise((function(r,n){if(!t.isChannel(e))return n(new Error("A channel with name: "+e+" doesn't exist!"));var i=t.createContextName(e);t.contexts.subscribe(i,(function(e){r(e)})).then((function(e){return e()}))}))},e.prototype.update=function(e,t){var r=this.createContextName(e);return this.contexts.update(r,t)},e.prototype.createContextName=function(e){return"___channel___"+e},e.prototype.isChannel=function(e){return this.all().some((function(t){return t===e}))},e}(),be=function(){function e(e,t){var r=this;this.subsKey="subs",this.changedKey="changed",this.registry=_(),this.shared=new we(e),this.shared.subscribe(this.handler.bind(this)),this.readyPromise=Promise.resolve(null==t?void 0:t.reduce((function(e,t){return e.then((function(){return r.add(t)}))}),Promise.resolve({})))}return e.prototype.subscribe=function(e){if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,e)},e.prototype.subscribeFor=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:if("string"!=typeof e)throw new Error("Please provide the name as a string!");if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(e,t)];case 1:return[2,r.sent()]}}))}))},e.prototype.publish=function(e,t){return s(this,void 0,void 0,(function(){var r;return a(this,(function(n){switch(n.label){case 0:if("object"!=typeof e)throw new Error("Please provide the data as an object!");if(!t)return[3,2];if("string"!=typeof t)throw new Error("Please provide the name as a string!");return[4,this.get(t)];case 1:return r=n.sent(),[2,this.shared.update(r.name,{data:e})];case 2:if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.update(this.currentContext,{data:e})]}}))}))},e.prototype.all=function(){var e=this.shared.all();return Promise.resolve(e)},e.prototype.list=function(){return s(this,void 0,void 0,(function(){var e,t=this;return a(this,(function(r){switch(r.label){case 0:return[4,this.all()];case 1:return e=r.sent(),[4,Promise.all(e.map((function(e){return t.get(e)})))];case 2:return[2,r.sent()]}}))}))},e.prototype.get=function(e){return"string"!=typeof e?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(e)},e.prototype.join=function(e){return s(this,void 0,void 0,(function(){var t,r=this;return a(this,(function(n){switch(n.label){case 0:if("string"!=typeof e)throw new Error("Please provide the channel name as a string!");return(t=function(e){return r.shared.all().includes(e)})(e)?[3,2]:[4,new Promise((function(r,n){var i,o=setInterval((function(){t(e)&&(clearTimeout(i),clearInterval(o),r())}),100);i=setTimeout((function(){return clearInterval(o),n(new Error("A channel with name: "+e+" doesn't exist!"))}),3e3)}))];case 1:n.sent(),n.label=2;case 2:return[4,this.shared.switchChannel(e)];case 3:return n.sent(),this.currentContext=e,this.registry.execute(this.changedKey,e),[2]}}))}))},e.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),Promise.resolve()},e.prototype.current=function(){return this.currentContext},e.prototype.my=function(){return this.current()},e.prototype.changed=function(e){if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,e)},e.prototype.onChanged=function(e){return this.changed(e)},e.prototype.add=function(e){return s(this,void 0,void 0,(function(){var t;return a(this,(function(r){switch(r.label){case 0:if("object"!=typeof e)throw new Error("Please provide the info as an object!");if(void 0===e.name)throw new Error("info.name is missing!");if("string"!=typeof e.name)throw new Error("Please provide the info.name as a string!");if(void 0===e.meta)throw new Error("info.meta is missing!");if("object"!=typeof e.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===e.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof e.meta.color)throw new Error("Please provide the info.meta.color as a string!");return t={name:e.name,meta:e.meta||{},data:e.data||{}},[4,this.shared.update(e.name,t)];case 1:return r.sent(),[2,t]}}))}))},e.prototype.ready=function(){return this.readyPromise},e.prototype.handler=function(e,t,r){this.registry.execute(this.subsKey,e,t,r)},e}(),Ie=function(e,t){return void 0===t&&(t=1e3),new Promise((function(r,n){var i=!1,o=setTimeout((function(){i=!0,n(new Error("Fetch request for: "+e+" timed out at: "+t+" milliseconds"))}),t);fetch(e).then((function(e){i||(clearTimeout(o),r(e))})).catch((function(e){i||(clearTimeout(o),n(e))}))}))},ke=function(){function e(e,t,r){var n,i,o=this;this._appManager=e,this._props=t,this._windows=r,this._registry=_();var s=void 0!==(null===(n=null==t?void 0:t.userProperties)||void 0===n?void 0:n.manifest)?JSON.parse(null==t?void 0:t.userProperties.manifest).url:null===(i=null==t?void 0:t.userProperties)||void 0===i?void 0:i.details.url;this._url=s,e.onInstanceStarted((function(e){e.application.name===o.name&&o._registry.execute("instanceStarted",e)})),e.onInstanceStopped((function(e){e.application.name===o.name&&o._registry.execute("instanceStopped",e)}))}return Object.defineProperty(e.prototype,"name",{get:function(){return this._props.name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"title",{get:function(){return this._props.title||""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this._props.version||""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userProperties",{get:function(){return this._props.userProperties||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instances",{get:function(){var e=this;return this._appManager.instances().filter((function(t){return t.application.name===e.name}))},enumerable:!0,configurable:!0}),e.prototype.start=function(e,t){var r=this;return new Promise((function(n,i){var s,a,c,u=setTimeout((function(){c(),i('Application "'+r.name+'" start timeout!')}),3e3);c=r._appManager.onInstanceStarted((function(e){e.application.name===r.name&&(clearTimeout(u),c(),n(e))}));var d=o(o(o({},null===(a=null===(s=r._props)||void 0===s?void 0:s.userProperties)||void 0===a?void 0:a.details),t),{context:e||(null==t?void 0:t.context)});if(!r._url)throw new Error("Application "+r.name+" doesn't have a URL.");r._windows.open(r.name,r._url,d)}))},e.prototype.onInstanceStarted=function(e){this._registry.add("instanceStarted",e)},e.prototype.onInstanceStopped=function(e){this._registry.add("instanceStopped",e)},e.prototype.updateFromProps=function(e){var t,r,n=this,i=void 0!==(null===(t=null==e?void 0:e.userProperties)||void 0===t?void 0:t.manifest)?JSON.parse(null==e?void 0:e.userProperties.manifest).url:null===(r=null==e?void 0:e.userProperties)||void 0===r?void 0:r.details.url;this._url=i,Object.keys(e).forEach((function(t){n._props[t]=e[t]}))},e}(),Se=function(){function e(e,t,r,n,i){this.id=e,this.application=t,this.control=r,this.context=n,this.agm=i,this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND="Peer has left while waiting for result"}return e.prototype.stop=function(){return s(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.callControl("stop",{},!1)];case 1:return t.sent(),[3,3];case 2:if((e=t.sent()).message!==this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND)throw new Error(e);return[3,3];case 3:return[2]}}))}))},e.prototype.callControl=function(e,t,r){return void 0===r&&(r=!1),this.control.send({command:e,domain:"appManager",args:t,skipResult:r},{instance:this.id})},e}(),xe=function(){function e(e,t,r,n){this.id=e,this.control=t,this._appManager=r,this.agm=n,this.context={},this.startedByScript=!1,this.application=void 0,t.setLocalInstance(this)}return e.prototype.stop=function(){var e=this;return new Promise((function(t,r){if(e.startedByScript){var n=e._appManager.onInstanceStopped((function(r){r.id===e.id&&(n(),t())}));window.close()}else r("Can't close a window that wasn't started by a script.")}))},e}(),We=X().where((function(e){return e.length>0}),"Expected a non-empty string"),Ce=re({url:ie(We)}),Te=re({icon:ie(We)}),Ee=re({name:We,displayName:ie(X()),contexts:ie(ne(X())),customConfig:ie(re())}),_e=re({url:We,top:ie(Z()),left:ie(Z()),width:ie(Z()),height:ie(Z()),context:ie(ee()),relativeTo:ie(We),relativeDirection:ie(oe(te("top"),te("left"),te("right"),te("bottom")))}),Me=re({name:We,title:ie(X()),version:ie(X()),appId:We,manifest:We,manifestType:We,tooltip:ie(X()),description:ie(X()),contactEmail:ie(X()),supportEmail:ie(X()),publisher:ie(X()),images:ie(ne(Ce)),icons:ie(ne(Te)),customConfig:ie(re()),intents:ie(ne(Ee))}),Ae=re({name:We,title:ie(X()),version:ie(X()),details:_e,customProperties:ie(re())}),Pe=function(){function e(e,t,r,n,i){var o=this;this.windows=e,this.interop=t,this.control=r,this.config=n,this.appName=i,this._apps={},this._instances=[],this.registry=_(),this.DEFAULT_POLLING_INTERVAL=3e3,this.OKAY_MESSAGE="OK",this.LOCAL_SOURCE="LOCAL_SOURCE";var s=t.instance.instance;if(this._myInstance=new xe(s,this.control,this,this.interop.instance),(null==n?void 0:n.remoteSources)&&this.subscribeForRemoteApplications(n.remoteSources),null==n?void 0:n.localApplications){var a=this.getValidatedApplications(n.localApplications);this.addApplications(a)}r.onStart((function(){o.trackInstanceLifetime()}))}return Object.defineProperty(e.prototype,"myInstance",{get:function(){return this.appName||console.warn("application wasn't provided to the GlueWeb factory function!"),this._myInstance||console.warn("The application isn't defined in any of the local/remote application sources!"),this._myInstance},enumerable:!0,configurable:!0}),e.prototype.application=function(e){return this._apps[e].application},e.prototype.applications=function(){var e=this;return Object.keys(this._apps).map((function(t){return e._apps[t].application}))},e.prototype.instances=function(){return this._instances},e.prototype.onAppAdded=function(e){var t=this,r=Object.keys(this._apps).map((function(e){return t._apps[e].application}));return this.replay(r,e),this.registry.add("appAdded",e)},e.prototype.onAppRemoved=function(e){return this.registry.add("appRemoved",e)},e.prototype.onAppChanged=function(e){return this.registry.add("appChanged",e)},e.prototype.onInstanceStarted=function(e){return this.registry.add("instanceStarted",e)},e.prototype.onInstanceStopped=function(e){return this.registry.add("instanceStopped",e)},e.prototype.getValidatedApplications=function(e){return e.filter((function(e){var t;return(t=void 0!==e.manifest?Me.run(e).ok:Ae.run(e).ok)||console.warn('Validation failed for application "'+e.name+'"!'),t}))},e.prototype.subscribeForRemoteApplications=function(e){for(var t=this,r=function(e){var r=e.url,i=function(){Ie(r).then((function(e){return e.json()})).then((function(e){if(e.message===t.OKAY_MESSAGE){var n=t.getValidatedApplications(e.applications);t.addApplications(n,r)}})).catch((function(e){console.warn(e)}))};i(),setInterval(i,e.pollingInterval||n.DEFAULT_POLLING_INTERVAL)},n=this,i=0,o=e;i<o.length;i++)r(o[i])},e.prototype.getAppProps=function(e){var t=["name","title","version"],r=Object.fromEntries(Object.entries(e).filter((function(e){var r=e[0];return!t.includes(r)})));return{name:e.name,title:e.title,version:e.version,userProperties:r}},e.prototype.handleAppsChanged=function(e,t){for(var r=this,n=function(e){var n=Object.keys(i._apps).find((function(n){return n===e.name&&r._apps[n].source===t})),o=Object.keys(i._apps).find((function(n){return n===e.name&&r._apps[n].source!==t}));if(n){var s=i._apps[n],a=i.getAppProps(e);if(JSON.stringify(s.appProps)!==JSON.stringify(a)){var c=new ke(i,a,i.windows);i.registry.execute("appChanged",c),i._apps[e.name]={source:s.source,application:c,appProps:a}}}else o&&console.warn('Application "'+e.name+'" already defined by source "'+i._apps[o].source+'". Skipping application definition from source '+t+".")},i=this,o=0,s=e;o<s.length;o++)n(s[o])},e.prototype.handleAppsAdded=function(e,t){for(var r=Object.keys(this._apps),n=0,i=e.filter((function(e){return!r.includes(e.name)}));n<i.length;n++){var o=i[n],s=this.getAppProps(o),a=new ke(this,s,this.windows);this.registry.execute("appAdded",a),this._apps[o.name]={source:t||this.LOCAL_SOURCE,application:a,appProps:s}}},e.prototype.handleAppsRemoved=function(e,t){for(var r=this,n=Object.keys(this._apps).filter((function(e){return r._apps[e].source===t})).map((function(e){return r._apps[e].application})),i=e.map((function(e){return e.name})),o=0,s=n.filter((function(e){return!i.includes(e.name)}));o<s.length;o++){var a=s[o];this.registry.execute("appRemoved",a),delete this._apps[a.name]}},e.prototype.tryPopulateMyInstanceApplication=function(){var e,t=this;if(this.appName){var r=null===(e=Object.values(this._apps).find((function(e){return e.application.name===t.appName})))||void 0===e?void 0:e.application;r&&(r.title&&(document.title=r.title),this._myInstance.application=r)}},e.prototype.addApplications=function(e,t){this.handleAppsChanged(e,t),this.handleAppsAdded(e,t),this.handleAppsRemoved(e,t),this._myInstance.application||this.tryPopulateMyInstanceApplication()},e.prototype.replay=function(e,t){(Array.isArray(e)?e:Object.values(e)).forEach((function(e){return t(e)}))},e.prototype.remoteFromServer=function(e){return s(this,void 0,void 0,(function(){var t,r,n,i,o;return a(this,(function(s){switch(s.label){case 0:return t=e.application,e.instance&&t&&this._apps[t]?(r=e.instance,n=this._apps[t].application,[4,null==(i=this.windows.list().find((function(t){return t.id===e.windowId})))?void 0:i.getContext()]):[2,void 0];case 1:return o=s.sent(),[2,new Se(r,n,this.control,o,e)]}}))}))},e.prototype.trackInstanceLifetime=function(){var e=this;this.interop.serverMethodAdded((function(t){var r=t.server,n=t.method;return s(e,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return n.name!==M.CONTROL_METHOD?[2]:[4,this.remoteFromServer(r)];case 1:return(e=t.sent())&&(this._instances.push(e),this.registry.execute("instanceStarted",e)),[2]}}))}))})),this.interop.serverRemoved((function(t){return s(e,void 0,void 0,(function(){var e;return a(this,(function(r){switch(r.label){case 0:return[4,this.remoteFromServer(t)];case 1:return(e=r.sent())&&(this._instances=this._instances.filter((function(t){return t.id!==e.id})),this.registry.execute("instanceStopped",e)),[2]}}))}))}))},e}(),Le=function(){function e(e){this.interop=e}return e.prototype.raise=function(e){return s(this,void 0,void 0,(function(){var t,r,n=this;return a(this,(function(i){switch(i.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return i.sent(),t=this.raiseUsingWebApi(e),e.clickInterop&&(r=e.clickInterop,t.onclick=function(){var e,t;n.interop.invoke(r.method,null!==(e=null==r?void 0:r.arguments)&&void 0!==e?e:{},null!==(t=null==r?void 0:r.target)&&void 0!==t?t:"best")}),[2,t]}}))}))},e.prototype.raiseUsingWebApi=function(e){return new Notification(e.title,e)},e}(),De={worker:"/glue/worker.js",extends:"/glue/glue.config.json",layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error"},je=function(e){return s(void 0,void 0,void 0,(function(){var t,r,n,i,o;return a(this,(function(s){switch(s.label){case 0:if(!1===(t=null!==(o=null!==(i=e.extends)&&void 0!==i?i:De.extends)&&void 0!==o?o:"/glue/glue.config.json"))return[2,{}];s.label=1;case 1:return s.trys.push([1,4,,5]),[4,Ie(t)];case 2:return(r=s.sent()).ok?[4,r.json()]:[2,{}];case 3:return[2,null!=(n=s.sent())?n:{}];case 4:return s.sent(),[2,{}];case 5:return[2]}}))}))},Oe=function(){function e(e,t,r,n,i){var o,s;this.storage=e,this.windows=t,this.control=r,this.interop=n,this.autoSaveContext=null!==(s=null===(o=null==i?void 0:i.layouts)||void 0===o?void 0:o.autoSaveWindowContext)&&void 0!==s&&s,this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.registerRequestMethods()}return e.prototype.export=function(e){return s(this,void 0,void 0,(function(){var t,r,n;return a(this,(function(i){switch(i.label){case 0:return e?[2,this.storage.getAll(e)]:[4,Promise.all([this.storage.getAll("Global"),this.storage.getAll("Workspace")])];case 1:return t=i.sent(),r=t[0],n=t[1],[2,r.concat(n)]}}))}))},e.prototype.import=function(e){return s(this,void 0,void 0,(function(){var t=this;return a(this,(function(r){switch(r.label){case 0:return[4,Promise.all(e.map((function(e){return t.storage.store(e,e.type)})))];case 1:return r.sent(),[2]}}))}))},e.prototype.save=function(e,t){return void 0===t&&(t=!1),s(this,void 0,void 0,(function(){var r,n,i;return a(this,(function(o){switch(o.label){case 0:return r=this.windows.getChildWindows().map((function(e){return e.id})),[4,this.getRemoteWindowsInfo(r)];case 1:return(n=o.sent()).push(this.getLocalLayoutComponent(e.context,!0)),i={type:"Global",name:e.name,components:n,context:e.context||{},metadata:e.metadata||{}},t?(this.storage.storeAutoLayout(i),[3,4]):[3,2];case 2:return[4,this.storage.store(i,"Global")];case 3:o.sent(),o.label=4;case 4:return[2,i]}}))}))},e.prototype.autoSave=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){return[2,this.save(e,!0)]}))}))},e.prototype.restore=function(e){return s(this,void 0,void 0,(function(){var t;return a(this,(function(r){switch(r.label){case 0:return[4,this.storage.get(e.name,"Global")];case 1:if(!(t=r.sent()))throw new Error("can not find layout with name "+e.name);return this.restoreComponents(t),[2]}}))}))},e.prototype.restoreAutoSavedLayout=function(){return s(this,void 0,void 0,(function(){var e,t,r,n;return a(this,(function(i){switch(i.label){case 0:return e="_auto_"+document.location.href,[4,this.storage.getAutoLayout(e)];case 1:if(!(t=i.sent()))return[2,Promise.resolve()];if((r=this.windows.my()).parent)return[2];n=t.components.find((function(e){return e.state.main})),r.setContext(null==n?void 0:n.state.context);try{this.restoreComponents(t)}catch(e){return[2]}return[2]}}))}))},e.prototype.remove=function(e,t){return this.storage.remove(t,e)},e.prototype.getAll=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return[4,this.storage.getAll(e)];case 1:return[2,t.sent().map((function(e){return{name:e.name,type:e.type,context:e.context,metadata:e.metadata}}))]}}))}))},e.prototype.get=function(e,t){return this.storage.get(e,t)},e.prototype.getLocalLayoutComponent=function(e,t){var r;void 0===t&&(t=!1);var n=this.windows.my();try{this.autoSaveContext&&(r={windowContext:n.getContextSync()})}catch(e){}return{type:"window",componentType:"application",state:{name:n.name,context:(null==r?void 0:r.windowContext)||{},bounds:n.getBoundsSync(),url:window.document.location.href,id:n.id,parentId:n.parent,main:t}}},e.prototype.restoreComponents=function(e){var t=this;e.components.forEach((function(e){if("window"===e.type){var r=e.state;if(r.main)return;var n=o(o({},r.bounds),{context:r.context});t.windows.open(r.name,r.url,n)}}))},e.prototype.getRemoteWindowsInfo=function(e){return s(this,void 0,void 0,(function(){var t,r,n,i,o,s;return a(this,(function(a){switch(a.label){case 0:for(t=[],r=function(e){var r=n.interop.servers().find((function(t){return t.windowId===e}));if(!r||!r.getMethods)return"continue";if(r.getMethods().find((function(e){return"T42.HC.GetSaveContext"===e.name})))try{t.push(n.interop.invoke("T42.HC.GetSaveContext",{},{windowId:e}))}catch(e){}},n=this,i=0,o=e;i<o.length;i++)s=o[i],r(s);return[4,Promise.all(t)];case 1:return[2,a.sent().map((function(e){return e.returned}))]}}))}))},e.prototype.registerRequestMethods=function(){var e=this;this.interop.register("T42.HC.GetSaveContext",(function(t){return e.getLocalLayoutComponent(t)}))},e.prototype.handleControlMessage=function(e){return s(this,void 0,void 0,(function(){var t,r,n,i=this;return a(this,(function(o){switch(o.label){case 0:return"saveLayoutAndClose"!==(t=e).command?[3,3]:(r=t.args,[4,this.getRemoteWindowsInfo(r.childWindows)]);case 1:return(n=o.sent()).push(r.parentInfo),[4,this.storage.storeAutoLayout({type:"Global",name:r.layoutName,components:n,context:r.context||{},metadata:r.metadata||{}})];case 2:o.sent(),r.childWindows.forEach((function(e){var t;null===(t=i.windows.findById(e))||void 0===t||t.close()})),o.label=3;case 3:return[2]}}))}))},e}(),Re=function(){function e(e,t,r){this.localStore=e,this.autoStore=t,this.remoteStore=r}return e.prototype.get=function(e,t){var r;return s(this,void 0,void 0,(function(){var n,i;return a(this,(function(o){switch(o.label){case 0:return[4,null===(r=this.remoteStore)||void 0===r?void 0:r.get(e,t)];case 1:return n=o.sent(),[4,this.localStore.get(e,t)];case 2:return i=o.sent(),n&&i?[2,n]:[2,n||i]}}))}))},e.prototype.getAll=function(e){return s(this,void 0,void 0,(function(){var t,r,n,i,o=this;return a(this,(function(s){switch(s.label){case 0:return[4,Promise.all([this.localStore.getAll(e),new Promise((function(t){if(o.remoteStore)return o.remoteStore.getAll(e).then(t);t([])}))])];case 1:return t=s.sent(),r=t[0],n=t[1],i=r.filter((function(e){return!n.some((function(t){return t.name===e.name}))})),[2,n.concat(i)]}}))}))},e.prototype.store=function(e,t){var r;return s(this,void 0,void 0,(function(){return a(this,(function(n){switch(n.label){case 0:return[4,null===(r=this.remoteStore)||void 0===r?void 0:r.get(e.name,t)];case 1:if(n.sent())throw new Error("Cannot save layout with name: "+e.name+" and type: "+t+", because it is present in the remote store and is treated as readonly");return e.metadata?e.metadata.allowSave=!0:e.metadata={allowSave:!0},[4,this.localStore.store(e,t)];case 2:return n.sent(),[2]}}))}))},e.prototype.remove=function(e,t){var r;return s(this,void 0,void 0,(function(){return a(this,(function(n){switch(n.label){case 0:return[4,null===(r=this.remoteStore)||void 0===r?void 0:r.get(e,t)];case 1:if(n.sent())throw new Error("Cannot remove layout with name: "+e+" and type: "+t+", because it is present in the remote store and is treated as readonly");return[4,this.localStore.delete(e,t)];case 2:return n.sent(),[2]}}))}))},e.prototype.getAutoLayout=function(e){return this.autoStore.get(e,"Global")},e.prototype.storeAutoLayout=function(e){this.autoStore.save(e)},e}();let Fe,Ne;const Be=new WeakMap,Ue=new WeakMap,ze=new WeakMap,Ge=new WeakMap,qe=new WeakMap;let He={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return Ue.get(e);if("objectStoreNames"===t)return e.objectStoreNames||ze.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return $e(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Je(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Ne||(Ne=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(Ye(this),t),$e(Be.get(this))}:function(...t){return $e(e.apply(Ye(this),t))}:function(t,...r){const n=e.call(Ye(this),t,...r);return ze.set(n,t.sort?t.sort():[t]),$e(n)}}function Ke(e){return"function"==typeof e?Je(e):(e instanceof IDBTransaction&&function(e){if(Ue.has(e))return;const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),n()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});Ue.set(e,t)}(e),((e,t)=>t.some(t=>e instanceof t))(e,Fe||(Fe=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,He):e)}function $e(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t($e(e.result)),n()},o=()=>{r(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",o)});return t.then(t=>{t instanceof IDBCursor&&Be.set(t,e)}).catch(()=>{}),qe.set(t,e),t}(e);if(Ge.has(e))return Ge.get(e);const t=Ke(e);return t!==e&&(Ge.set(e,t),qe.set(t,e)),t}const Ye=e=>qe.get(e),Ve=["get","getKey","getAll","getAllKeys","count"],Xe=["put","add","delete","clear"],Ze=new Map;function Qe(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Ze.get(t))return Ze.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,i=Xe.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!Ve.includes(r))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let s=o.store;n&&(s=s.index(t.shift()));const a=await s[r](...t);return i&&await o.done,a};return Ze.set(t,o),o}var et;et=He,He={...et,get:(e,t,r)=>Qe(e,t)||et.get(e,t,r),has:(e,t)=>!!Qe(e,t)||et.has(e,t)};var tt=function(){function e(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDb is not supported")}return Object.defineProperty(e.prototype,"database",{get:function(){var e=this;return this._database?Promise.resolve(this._database):new Promise((function(t){(function(e,t,{blocked:r,upgrade:n,blocking:i,terminated:o}={}){const s=indexedDB.open(e,t),a=$e(s);return n&&s.addEventListener("upgradeneeded",e=>{n($e(s.result),e.oldVersion,e.newVersion,$e(s.transaction))}),r&&s.addEventListener("blocked",()=>r()),a.then(e=>{o&&e.addEventListener("close",()=>o()),i&&e.addEventListener("versionchange",()=>i())}).catch(()=>{}),a})("glue42core",1,{upgrade:e.setUpDb.bind(e)}).then((function(r){e._database=r,t(e._database)}))}))},enumerable:!0,configurable:!0}),e.prototype.getAll=function(e){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,t.sent().getAll("workspaceLayouts")];case 3:return[4,this.database];case 4:return[2,t.sent().getAll("globalLayouts")];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},e.prototype.delete=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,r.sent().delete("workspaceLayouts",e)];case 3:return[4,this.database];case 4:return[2,r.sent().delete("globalLayouts",e)];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},e.prototype.get=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,r.sent().get("workspaceLayouts",e)];case 3:return[4,this.database];case 4:return[2,r.sent().get("globalLayouts",e)];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},e.prototype.store=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:switch(ve.runWithException(e),fe.runWithException(t),t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,r.sent().put("workspaceLayouts",e,e.name)];case 3:return[4,this.database];case 4:return[2,r.sent().put("globalLayouts",e,e.name)];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},e.prototype.setUpDb=function(e){e.objectStoreNames.contains("workspaceLayouts")||e.createObjectStore("workspaceLayouts"),e.objectStoreNames.contains("globalLayouts")||e.createObjectStore("globalLayouts")},e}(),rt=function(){function e(e){this.storeBaseUrl=e}return e.prototype.getAll=function(e){return s(this,void 0,void 0,(function(){var t,r,n;return a(this,(function(i){switch(i.label){case 0:return fe.runWithException(e),t=this.storeBaseUrl+"/glue.layouts.json",[4,this.fetchTimeout(t)];case 1:if(!(r=i.sent()).ok)return[2,[]];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.json()];case 3:return n=i.sent(),[3,5];case 4:return i.sent(),[2,[]];case 5:return n?[2,(n["Global"===e?"globals":"workspaces"]||[]).filter((function(e){var t=ve.run(e);return t.ok||console.warn("Fetched layout: "+e.name+" is discarded, because it failed the validation: "+JSON.stringify(t)),t.ok}))]:[2,[]]}}))}))},e.prototype.get=function(e,t){return s(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return[4,this.getAll(t)];case 1:return[2,r.sent().find((function(t){return t.name===e}))]}}))}))},e.prototype.fetchTimeout=function(e,t){return void 0===t&&(t=1e3),new Promise((function(r,n){var i=!1,o=setTimeout((function(){i=!0,n(new Error("Fetch request for: "+e+" timed out at: "+t+" milliseconds"))}),t);fetch(e).then((function(e){i||(clearTimeout(o),r(e))})).catch((function(e){i||(clearTimeout(o),n(e))}))}))},e}(),nt=function(){function e(){}return e.prototype.get=function(e,t){return this.getObjectFromLocalStorage()[this.getKey(e,t)]},e.prototype.save=function(e){var t=this.getObjectFromLocalStorage();return t[this.getKey(e.name,e.type)]=e,this.setObjectToLocalStorage(t),e},e.prototype.remove=function(e,t){delete this.getObjectFromLocalStorage()[this.getKey(e,t)]},e.prototype.getObjectFromLocalStorage=function(){var t=window.localStorage.getItem(e.KEY);return t?JSON.parse(t):{}},e.prototype.setObjectToLocalStorage=function(t){window.localStorage.setItem(e.KEY,JSON.stringify(t))},e.prototype.getKey=function(e,t){return t+"_"+e},e.KEY="G0_layouts",e}(),it=function(e,t,r,n){var i=!1;window.addEventListener("beforeunload",(function(){s(void 0,void 0,void 0,(function(){var o,s,c,u,d;return a(this,(function(a){return i||(i=!0,(null===(d=null==t?void 0:t.layouts)||void 0===d?void 0:d.autoRestore)&&(o=e.windows.getChildWindows().map((function(e){return e.id})),s=o[0],c="_auto_"+document.location.href,o.length>0?(u={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:o,closeEveryone:!0,layoutName:c,context:{},metadata:{},parentInfo:null==n?void 0:n.getLocalLayoutComponent({},!0)}},r.send(u,{windowId:s})):null==n||n.autoSave({name:c})),e.done()),[2]}))}))}))},ot=function(e,t){return(ot=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function st(e,t){function r(){this.constructor=e}ot(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var at=function(){return(at=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function ct(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function ut(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function dt(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)n[i]=o[s];return n}var lt=1,ht=2,pt=3,ft=4;function mt(e){return e.type===pt?"timestamp":e.type===ht?"number":e.type===lt?"string":e.type===ft?"object":"unknown"}function gt(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function vt(e){var t={},r=mt(e);if("object"===r){var n=Object.keys(e.value).reduce((function(t,r){var n=gt(e.value[r]);if("object"===n){var i=function e(t){return Object.keys(t).reduce((function(r,n){var i=gt(t[n]);return r[n]="object"===i?{type:"object",description:"",context:{},composite:e(t[n])}:{type:i,description:"",context:{}},r}),{})}(e.value[r]);t[r]={type:"object",description:"",context:{},composite:i}}else t[r]={type:n,description:"",context:{}};return t}),{});t.composite=n}return t.name=yt(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function yt(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function wt(e){return"timestamp"===mt(e)?Date.now():function e(t){return"object"!=typeof t?t:Object.keys(t).reduce((function(r,n){var i=t[n];return"object"==typeof i&&i.constructor!==Date?r[n]=e(i):i.constructor===Date?r[n]=new Date(i).getTime():i.constructor===Boolean?r[n]=i.toString():r[n]=i,r}),{})}(e.value)}function bt(e){var t=function e(t){return t.reduce((function(t,r){return t.concat(Array.isArray(r)?e(r):r)}),[])}(e.root.getAggregateState()),r=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0];return{description:function(e){var t="";return e.forEach((function(e,r,n){var i=e.path.join(".");r===n.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:r.state}}var It=function(e,t,r){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")},kt=function(){function e(e,t,r,n,i){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=i,this.path=[],It(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){this.value=e,this.transport.updateMetric(this)},e}(),St=function(e){function t(t,r,n,i){return e.call(this,t,r,n,i,ht)||this}return st(t,e),t.prototype.incrementBy=function(e){this.update(this.value+e)},t.prototype.increment=function(){this.incrementBy(1)},t.prototype.decrement=function(){this.incrementBy(-1)},t.prototype.decrementBy=function(e){this.incrementBy(-1*e)},t}(kt),xt=function(e){function t(t,r,n,i){return e.call(this,t,r,n,i,ft)||this}return st(t,e),t.prototype.update=function(e){this.mergeValues(e),this.transport.updateMetric(this)},t.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(r){void 0!==e[r]&&(t.value[r]=e[r])}))},t}(kt),Wt=function(e){function t(t,r,n,i){return e.call(this,t,r,n,i,lt)||this}return st(t,e),t}(kt),Ct=function(e){function t(t,r,n,i){return e.call(this,t,r,n,i,pt)||this}return st(t,e),t.prototype.now=function(){this.update(new Date)},t}(kt),Tt=function(){function e(e,t){t.init(this),this.root=function e(t,r,n,i,o){if(!r)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var s,a,c=n,u=t,d=o||"",l=r,h=i,p=function e(t){if(!t||!t.parent)return[];var r=e(t.parent);return r.push(t.name),r}(i),f={},m=(a="/",((s=p)&&s.length>0?s.join(a):"")+t),g=r.root,v=[],y=[];function w(e,t,r,n){var i={name:""};i="string"==typeof e?{name:e}:e;var o=y.filter((function(e){return e.name===i.name}));if(o.length>0){var s=o[0];if(s.type!==t)throw new Error("A metric named "+i.name+" is already defined with different type.");return void 0!==r&&s.update(r),s}var a=n(i);return y.push(a),a}var b={get name(){return u},get description(){return d},get repo(){return l},get parent(){return h},path:p,id:m,root:g,get subSystems(){return v},get metrics(){return y},subSystem:function(t,r){if(!t||0===t.length)throw new Error("name is required");var n=v.filter((function(e){return e.name===t}));if(n.length>0)return n[0];var i=e(t,l,c,b,r);return v.push(i),i},getState:function(){return f},setState:function(e,t){f={state:e,description:t},c.updateSystem(b,f)},stringMetric:function(e,t){return w(e,lt,t,(function(e){return new Wt(e,b,c,t)}))},timestampMetric:function(e,t){return w(e,pt,t,(function(e){return new Ct(e,b,c,t)}))},objectMetric:function(e,t){return w(e,ft,t,(function(e){return new xt(e,b,c,t)}))},numberMetric:function(e,t){return w(e,ht,t,(function(e){return new St(e,b,c,t)}))},getAggregateState:function(){var e=[];return Object.keys(f).length>0&&e.push({name:u,path:p,state:f.state,description:f.description}),v.forEach((function(t){var r=t.getAggregateState();r.length>0&&e.push.apply(e,r)})),e}};return c.createSystem(b),b}("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var r=e.subSystem("ClickStream"),n=function(e){if(e.target){var t=e.target;r.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:e.target?t.className:"",id:t.id,type:"<"+t.tagName.toLowerCase()+">",href:t.href||""}})}};r.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",n):document.attachEvent("onclick",n)}e.stringMetric("StartTime",(new Date).toString());var i=e.stringMetric("StartURL",""),o=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;i.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},e}(),Et=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){},e.prototype.updateSystem=function(e,t){},e.prototype.createMetric=function(e){},e.prototype.updateMetric=function(e){},e}(),_t=function(e){var t;return t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var r,n,i=function(e){o(e.root)},o=function(e){s(e),e.metrics.forEach((function(e){a(e)})),e.subSystems.forEach((function(e){o(e)}))},s=function(e){void 0!==e.parent&&r.then((function(){var t={type:"define",metrics:[{name:yt(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)}))},a=function(e){var t=u(e);r.then((function(){var e={type:"define",metrics:[vt(t)]};n.send(e),void 0!==t.value&&c(t)}))},c=function(e){if(d()){var t=wt(e),r={type:"publish",values:[{name:yt(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};n.send(r)}},u=function(e){var t=at({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=at({},e.value)),t},d=function(){var e;try{return(null!==(e=t.canUpdateMetric)&&void 0!==e?e:function(){return!0})()}catch(e){return!0}};return{init:function(o){var s;r=new Promise((function(e){s=e})),(n=e.domain("metrics")).onJoined((function(e){!e&&s&&(s(),s=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&i(o)})),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:s,updateSystem:function(t,i){r.then((function(){var r={type:"publish",values:[{name:yt(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};n.send(r);var o=bt(t),s={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};n.send(s)}))},createMetric:a,updateMetric:function(e){var t=u(e);r.then((function(){return c(t)}))}}}(e.connection,e):new Et,new Tt(e,t).root};function Mt(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t){var n=r[e];return n||(n=[],r[e]=n),n.push(t),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}Mt.default=Mt;var At,Pt,Lt,Dt=Mt,jt=function(){function e(e,t){var r=this;this.registry=Dt(),this.gw=e.facade,this.gw.connect((function(e,t){r.messageHandler(t)})).then((function(e){r.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),Ot=function(){function e(e,t){var r=this;this.logger=t,this.registry=Dt(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){r.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),Rt=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(t.process)}catch(t){e._isNode=!1}return e._isNode},e}(),Ft=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,r){e.resolve=function(r){e.resolved=!0,t(r)},e.reject=function(t){e.rejected=!0,r(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),Nt=Rt.isNode()?r(8):window.WebSocket,Bt=function(){function e(e,t){if(this._running=!0,this._registry=Dt(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var r=this;return new Promise((function(t,n){r.waitForSocketConnection((function(){var i;try{null===(i=r.ws)||void 0===i||i.send(e),t()}catch(e){n(e)}}),n)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,r){e.waitForSocketConnection(t,r)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return"ws "+this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new Ft;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var r;t=null!=t?t:function(){},this._running?1!==(null===(r=this.ws)||void 0===r?void 0:r.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return ct(this,void 0,void 0,(function(){var r=this;return ut(this,(function(n){switch(n.label){case 0:if(void 0===e&&(e=this.settings.reconnectInterval),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return n.sent(),this.notifyForSocketState(),[3,4];case 3:return n.sent(),setTimeout((function(){var n=void 0===t?void 0:t-1;r.openSocket(e,n)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new Ft;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new Nt(this.settings.ws||""),this.ws.onerror=function(r){var n="";try{n=JSON.stringify(r)}catch(e){var i=new WeakSet;n=JSON.stringify(r,(function(e,t){if("object"==typeof t&&null!==t){if(i.has(t))return;i.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,n)},this.ws.onclose=function(r){e.logger.info("ws closed "+r),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var r;e.logger.info("ws opened "+(null===(r=e.settings.identity)||void 0===r?void 0:r.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}(),Ut=1,zt={nextValue:function(){return(Ut=(9301*Ut+49297)%233280)/233280},seed:function(e){Ut=e}},Gt="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function qt(){Lt=!1}function Ht(e){if(e){if(e!==At){if(e.length!==Gt.length)throw new Error("Custom alphabet for shortid must be "+Gt.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,r){return t!==r.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+Gt.length+" unique characters. These characters were not unique: "+t.join(", "));At=e,qt()}}else At!==Gt&&(At=Gt,qt())}function Jt(){return Lt||(Lt=function(){At||Ht(Gt);for(var e,t=At.split(""),r=[],n=zt.nextValue();t.length>0;)n=zt.nextValue(),e=Math.floor(n*t.length),r.push(t.splice(e,1)[0]);return r.join("")}())}var Kt={characters:function(e){return Ht(e),At},seed:function(e){zt.seed(e),Pt!==e&&(qt(),Pt=e)},lookup:function(e){return Jt()[e]},shuffled:Jt},$t="object"==typeof window&&(window.crypto||window.msCrypto),Yt=function(){if(!$t||!$t.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return $t.getRandomValues(e),48&e[0]},Vt=function(e,t){for(var r,n=0,i="";!r;)i+=e(t>>4*n&15|Yt()),r=t<Math.pow(16,n+1),n++;return i},Xt=function(e){var t=Kt.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}},Zt=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=Kt.characters(),r=e.length,n=0;n<r;n++)if(-1===t.indexOf(e[n]))return!1;return!0},Qt=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,r,n=0;function i(){var e="",i=Math.floor(.001*(Date.now()-1459707606518));return i===r?t++:(t=0,r=i),e+=Vt(Kt.lookup,6),e+=Vt(Kt.lookup,n),t>0&&(e+=Vt(Kt.lookup,t)),e+=Vt(Kt.lookup,i)}e.exports=i,e.exports.generate=i,e.exports.seed=function(t){return Kt.seed(t),e.exports},e.exports.worker=function(t){return n=t,e.exports},e.exports.characters=function(e){return void 0!==e&&Kt.characters(e),Kt.shuffled()},e.exports.decode=Xt,e.exports.isValid=Zt})),er=(Qt.generate,Qt.seed,Qt.worker,Qt.characters,Qt.decode,Qt.isValid,Qt);function tr(e,t,r,n,i){null==e&&(e="global"),n=n||["success"],i=i||["error"];var o,s=!1,a=!1,c=!1,u=Dt();t.disconnected((function(){c=!1,r.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),l(o))})),t.on("success",(function(e){return p(e)})),t.on("error",(function(e){return h(e)})),t.on("result",(function(e){return p(e)})),n&&n.forEach((function(e){t.on(e,(function(e){return p(e)}))})),i&&i.forEach((function(e){t.on(e,(function(e){return h(e)}))}));var d={};function l(t){return o=t,new Promise((function(n,i){var o;s?n():("global"===e?o=c?Promise.resolve({}):Promise.reject("not connected to gateway"):(r.debug("joining domain "+e),o=m({type:"join",destination:e,domain:"global",options:t})),o.then((function(){!function(){r.debug("did join "+e),s=!0;var t=a;a=!1,u.execute("onJoined",t)}(),n()})).catch((function(t){r.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)})))}))}function h(t){if(e===t.domain){var r=t.request_id;if(r){var n=d[r];n&&n.error(t)}}}function p(t){if(t.domain===e){var r=t.request_id;if(r){var n=d[r];n&&n.success(t)}}}function f(){return er()}function m(n,i,o){o=o||{},n.request_id=n.request_id||f(),n.domain=n.domain||e,o.skipPeerId||(n.peer_id=t.peerId);var s=n.request_id;return new Promise((function(e,a){d[s]={success:function(t){delete d[s],t._tag=i,e(t)},error:function(e){r.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(n)),delete d[s],e._tag=i,a(e)}},t.send(n,o).catch((function(e){d[s].error({err:e})}))}))}return{join:l,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,m({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),u.add("onJoined",e)},onLeft:function(e){return s||e(),u.add("onLeft",e)},send:m,sendFireAndForget:function(r){r.request_id=r.request_id?r.request_id:f(),r.domain=r.domain||e,r.peer_id=t.peerId,t.send(r)},on:function(n,i){t.on(n,(function(t){if(t.domain===e)try{i(t)}catch(e){r.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var rr=function(){function e(e,t,r){var n=this;this.connection=e,this.settings=t,this.logger=r,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=Dt(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){n.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,r=JSON.parse(e,(function(e,r){if("string"!=typeof r)return r;if(r.length<t.dateMinLen)return r;if(r[0]!==t.datePrefixFirstChar)return r;if(r.substring(0,t.datePrefixLen)!==t.datePrefix)return r;try{var n=parseInt(r.substring(t.datePrefixLen,r.length),10);return isNaN(n)?r:new Date(n)}catch(e){return r}}));return{msg:r,msgType:r.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var r=this.datePrefix;return Date.prototype.toJSON=function(){return r+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return ct(this,void 0,void 0,(function(){var r,i,o,s,a,c,u,d,l,h;return ut(this,(function(p){switch(p.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,r={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];p.label=1;case 1:return p.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=p.sent(),e.gatewayToken=d,[3,4];case 3:return i=p.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return r.method="gateway-token",r.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(r.provider="win",r.method="access-token",e.flowCallback&&e.sessionId?(o=r,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return o.token=p.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)r.method="access-token",r.token=e.token;else{if(!e.username)throw new Error("invalid auth message"+JSON.stringify(e));r.method="secret",r.login=e.username,r.secret=e.password}p.label=10;case 10:s={type:"hello",identity:this.settings.identity,authentication:r},e.sessionId&&(s.request_id=e.sessionId),this.globalDomain=tr("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),a={skipPeerId:!0},this.initialLogin&&(a.retryInterval=this.settings.reconnectInterval,a.maxRetries=this.settings.reconnectAttempts),p.label=11;case 11:p.trys.push([11,19,20,21]),c=void 0,p.label=12;case 12:return[4,this.globalDomain.send(s,void 0,a)];case 13:return"authentication-request"!==(u=p.sent()).type?[3,16]:(d=n.from(u.authentication.token,"base64"),e.flowCallback&&e.sessionId?(l=s.authentication,[4,e.flowCallback(e.sessionId,d)]):[3,15]);case 14:l.token=p.sent().data.toString("base64"),p.label=15;case 15:return s.request_id=e.sessionId,[3,12];case 16:if("welcome"===u.type)return c=u,[3,18];throw"error"===u.type?new Error("Authentication failed: "+u.reason):new Error("Unexpected message type during authentication: "+u.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+c.peer_id),this.connection.peerId=c.peer_id,this.connection.resolvedIdentity=c.resolved_identity,this.connection.availableDomains=c.available_domains,c.options&&(this.connection.token=c.options.access_token,this.connection.info=c.options.info),this.setLoggedIn(!0),[2,c.resolved_identity];case 19:throw h=p.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return ct(this,void 0,void 0,(function(){var e;return ut(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,r,n){var i=this.sessions.filter((function(t){return t.domain===e}))[0];return i||(i=tr(e,this.connection,t,r,n),this.sessions.push(i)),i},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected,1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),nr=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,r=e;t<r.length;t++){var n=r[t];this.specs[n.name]=n,this.specsNames.push(n.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var r=0,n=this.specsNames;r<n.length;r++)for(var i=n[r],o=function(r){var n=s.subsRefCount[r];if(n||(n=0),n+=1,s.subsRefCount[r]=n,n>1)return"continue";var i=e.on(r,(function(e){return t.processMessage(r,e)}));s.subs[r]=i},s=this,a=0,c=this.specs[i].types;a<c.length;a++)o(c[a])},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var r=0,n=this.specsNames;r<n.length;r++){var i=n[r];if(-1!==this.specs[i].types.indexOf(e)){var o=this.messages[i]||[];this.messages[i]=o,o.push(t)}}},e.prototype.drain=function(e,t){var r;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var n=0,i=this.specs[e].types;n<i.length;n++){var o=i[n];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(r=this.connection)||void 0===r||r.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),ir=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=Dt(),this._connected=!1,this.isTrace=!1,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new jt(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new Ot(e.sharedWorker,t.subLogger("shared-worker"));else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new Bt(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.info("starting with "+this.transport.name()+" transport"),this.protocol=new rr(this,e,t.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),e.replaySpecs&&e.replaySpecs.length&&(this.replayer=new nr(e.replaySpecs),this.replayer.init(this))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var r=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(r)),this.transport.sendObject(r,t)}var n=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+n),this.transport.send(n,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){e(t.settings.ws||t.settings.sharedWorker||"")}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return ct(this,void 0,void 0,(function(){return ut(this,(function(r){switch(r.label){case 0:return[4,this.transport.open()];case 1:return r.sent(),[2,this.protocol.login(e,t)]}}))}))},e.prototype.logout=function(){return ct(this,void 0,void 0,(function(){return ut(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,r){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,r)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var r=this,n=this.messageHandlers[t.toLowerCase()];void 0!==n&&Object.keys(n).forEach((function(t){var i=n[t];if(void 0!==i)try{i(e)}catch(e){r.logger.error("Message handler failed with "+e.stack,e)}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}(),or=["trace","debug","info","warn","error","off"],sr=function(){function e(e,t,r){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var r=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==r)return r;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var n=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(n),n},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,r){this.publishMessage(t||"info",e,r)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return or.indexOf(e)>=or.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,r,n){var i,o,s=this.loggerFullName;if("error"===t&&!n){var a=new Error;a.stack&&(r=r+"\n"+a.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())&&(null===(i=e.Interop)||void 0===i?void 0:i.methods({name:e.InteropMethodName}).length)>0&&(null===(o=e.Interop)||void 0===o||o.invoke(e.InteropMethodName,{msg:""+r,logger:s,level:t})),this.canPublish(t)){var c="";if(this.includeTimeAndLevel){var u=new Date;c="["+u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+":"+u.getMilliseconds()+"] ["+t+"] "}var d=""+c+s+": "+r;switch(t){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,n)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),ar={get name(){return"context"},get types(){return["create-context","created","destroyed","context-created","context-added","subscribe-context","subscribed-context","unsubscribe-context","destroy-context","context-destroyed","update-context","context-updated","joined"]}};function cr(e,t,r){var n,o,s,a,c;if(Rt.isNode()){var u=i.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(e){}}var d=function(){var n,o,s,a,u,d,l,h,p,f=e.gateway,m=null!==(n=null==f?void 0:f.protocolVersion)&&void 0!==n?n:3,g=null==f?void 0:f.reconnectInterval,v=null==f?void 0:f.reconnectAttempts,y=null==f?void 0:f.ws,w=null==f?void 0:f.sharedWorker,b=null==f?void 0:f.inproc;r&&(y=r.gwURL),Rt.isNode()&&c&&c.gwURL&&(y=c.gwURL),y||w||b||(y="ws://localhost:8385");var I=function(){if(e.application)return e.application;if(r)return r.applicationName;var t=er();return Rt.isNode()?c?c.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+t+")":t}(),k=I;void 0!==r?(d=r.windowId,l=r.pid,r.env&&(h=r.env.env,p=r.env.region),k=null!==(o=r.application)&&void 0!==o?o:"glue-app",u=r.appInstanceId):Rt.isNode()?(l=i.pid,c&&(h=c.env,p=c.region,u=c.instanceId)):d=window.name||er();var S=null!==(a=null===(s=e.gateway)||void 0===s?void 0:s.replaySpecs)&&void 0!==a?a:[];return S.push(ar),{identity:{application:k,applicationName:I,windowId:d,instance:u,process:l,region:p,environment:h,api:t.version||"5.0.7"},reconnectInterval:g,ws:y,sharedWorker:w,inproc:b,protocolVersion:m,reconnectAttempts:v,replaySpecs:S}}();return{bus:null!==(n=e.bus)&&void 0!==n&&n,auth:function(){var t,r;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Rt.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.inproc)||(null===(r=e.gateway)||void 0===r?void 0:r.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,r,n=e.logger;return n||(n="error"),"string"==typeof n?{console:n,publish:"error"}:{console:null!==(t=n.console)&&void 0!==t?t:"error",publish:null!==(r=n.publish)&&void 0!==r?r:"error"}}(),connection:d,metrics:null===(o=e.metrics)||void 0===o||o,contexts:null===(s=e.contexts)||void 0===s||s,version:t.version||"5.0.7",libs:null!==(a=t.libs)&&void 0!==a?a:[],customLogger:e.customLogger}}function ur(){function e(){return(new Date).getTime()}var t,r,n=e();return{get startTime(){return n},get endTime(){return t},get period(){return r},stop:function(){return t=e(),r=e()-n}}}var dr=function(){function e(e,t,r,n){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function lr(e,t){if(t){if(t.reset)return e=at({},t.reset);e=hr(e,void 0);var r=t.added,n=t.updated,i=t.removed;r&&Object.keys(r).forEach((function(t){e[t]=r[t]})),n&&Object.keys(n).forEach((function(t){pr(t,e,n)})),i&&i.forEach((function(t){delete e[t]}))}return e}function hr(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var r=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,r),Object.assign.apply(Object,dt([r],Object.keys(e).map((function(r){var n;return(n={})[r]=hr(e[r],t),n}))))}var pr=function(e,t,r){var n=r[e];if(void 0===n)return t;var i=t[e];return i&&n?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(i)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},i,n),t):(t[e]=n,t)};function fr(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!fr(e[r],t[r]))return!1}}for(var r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}var mr,gr=function(){function e(e){var t,r=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",["context-created","subscribed-context","context-destroyed","context-updated"]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(ar.name,(function(e){var t=e.type;t&&("context-created"===t||"context-added"===t||"created"===t?r.handleContextCreatedMessage(e):"subscribed-context"===t||"context-updated"===t||"joined"===t?r.handleContextUpdatedMessage(e):"context-destroyed"!==t&&"destroyed"!==t||r.handleContextDestroyedMessage(e))}))}return e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var r=t[e];this._connection.off(r)}for(var n in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(n)&&delete this._contextNameToData[n]},e.prototype.createContext=function(e,t){var r=this;return this._gw3Session.send({type:"create-context",domain:"global",name:e,data:t,lifetime:"retained"}).then((function(n){if(r._contextNameToId[e]=n.context_id,!r._contextIdToName[n.context_id]){r._contextIdToName[n.context_id]=e;var i=r._contextNameToData[e]||new dr(n.context_id,e,!0,void 0);return i.isAnnounced=!0,i.name=e,i.contextId=n.context_id,r._contextNameToData[e]=i,i.context=n.data,i.sentExplicitSubscription=!0,i.context&&r.invokeUpdateCallbacks(i,i.context,void 0),r.update(e,t).then((function(){return n.context_id}))}return n.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){return ct(this,void 0,void 0,(function(){var r,n,i,o=this;return ut(this,(function(s){switch(s.label){case 0:return(r=this._contextNameToData[e])&&r.isAnnounced?(n=r.context,r.hasCallbacks()?[3,2]:[4,this.get(r.name,!1)]):[2,this.createContext(e,t)];case 1:n=s.sent(),s.label=2;case 2:return i=this.calculateContextDelta(n,t),Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:r.contextId,delta:i},{},{skipPeerId:!1}).then((function(e){o.handleUpdated(r,i,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var r=this,n=this._contextNameToData[e];return n&&n.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){r.handleUpdated(n,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.get=function(e,t){var r=this;void 0===t&&(t=!0);var n=this._contextNameToData[e];return n&&n.isAnnounced&&n.hasCallbacks()||t?Promise.resolve(n&&n.context):new Promise((function(t,n){return ct(r,void 0,void 0,(function(){var r=this;return ut(this,(function(n){return this.subscribe(e,(function(e,n,i,o){r.unsubscribe(o),t(e)})),[2]}))}))}))},e.prototype.subscribe=function(e,t){var r=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var n=this._contextNameToData[e];if(!n||!n.isAnnounced)return n=n||new dr(void 0,e,!1,void 0),this._contextNameToData[e]=n,n.updateCallbacks[r]=t,Promise.resolve(r);var i=n.hasCallbacks();return n.updateCallbacks[r]=t,i||n.joinedActivity||n.context&&n.sentExplicitSubscription?(t(n.context,n.context,[],r),Promise.resolve(r)):this.sendSubscribe(n).then((function(){return r}))},e.prototype.unsubscribe=function(e){for(var t=0,r=Object.keys(this._contextNameToData);t<r.length;t++){var n=r[t],i=(this._contextNameToId[n],this._contextNameToData[n]);if(!i)return;var o=i.hasCallbacks();delete i.updateCallbacks[e],i.isAnnounced&&o&&!i.hasCallbacks()&&i.sentExplicitSubscription&&this.sendUnsubscribe(i),i.isAnnounced||i.hasCallbacks()||delete this._contextNameToData[n]}},e.prototype.handleUpdated=function(e,t,r){var n=e.context;e.context=lr(e.context,t),this._contextNameToData[e.name]!==e||fr(n,e.context)||this.invokeUpdateCallbacks(e,e.context,t,r)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=["context-added","context-created","created"];e<t.length;e++){var r=t[e],n=this._connection.on(r,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(n)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;"created"===t?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):"context-added"===t&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);var n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new dr(e.context_id,r,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=["context-updated","subscribed-context","joined"];e<t.length;e++){var r=t[e],n=this._connection.on(r,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(n)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,r=e.context_id,n=this._contextNameToData[this._contextIdToName[r]],i=!n||!n.isAnnounced;if("joined"===t)n?(n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id):(n=new dr(r,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r),n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void("subscribed-context"===t?((n=n||new dr(r,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error("Received 'update' for unknown context: "+r));var o=n.context;if("subscribed-context"===t)n.context=e.data||{};else if("joined"===t)n.context=e.context_snapshot||{};else{if("context-updated"!==t)throw new Error("Unrecognized context update message "+t);n.context=lr(n.context,e.delta)}!i&&fr(n.context,o)&&"subscribed-context"!==t||this.invokeUpdateCallbacks(n,n.context,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,r,n){for(var i in r=r||{added:{},updated:{},reset:{},removed:[]},e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(i))try{(0,e.updateCallbacks[i])(hr(t),Object.assign({},r.added||{},r.updated||{},r.reset||{}),r.removed,parseInt(i,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=["context-destroyed","destroyed"];e<t.length;e++){var r=t[e],n=this._connection.on(r,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(n)}},e.prototype.handleContextDestroyedMessage=function(e){var t,r;if("destroyed"===e.type){if(r=e.activity_id,!(t=this._contextNameToId[r]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(r=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[r];var n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDelta=function(e,t){var r={added:{},updated:{},removed:[],reset:void 0};if(e)for(var n=0,i=Object.keys(e);n<i.length;n++){var o=i[n];-1===Object.keys(t).indexOf(o)||null===t[o]||fr(e[o],t[o])||(r.updated[o]=t[o])}for(var s=0,a=Object.keys(t);s<a.length;s++)o=a[s],e&&-1!==Object.keys(e).indexOf(o)?null===t[o]&&r.removed.push(o):null!==t[o]&&(r.added[o]=t[o]);return r},e}(),vr=function(){function e(e){this._bridge=new gr(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this._bridge.set(e,t)},e.prototype.subscribe=function(e,t){var r=this;return this.checkName(e),this._bridge.subscribe(e,(function(e,n,i,o,s){return t(e,n,i,(function(){return r._bridge.unsubscribe(o)}),s)})).then((function(e){return function(){r._bridge.unsubscribe(e)}}))},e.prototype.get=function(e,t){return void 0===t&&(t=!0),this._bridge.get(e,t)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("'name' must be non-empty string, got '"+e+"'")},e}();function yr(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=function(){}:"function"!=typeof r&&(r=function(){}),e.then(t,r))}function wr(e,t){return void 0===e&&(e=0),new Promise((function(r,n){return setTimeout((function(){return n(t)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(mr||(mr={}));var br=function(){function e(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}return e.prototype.subscribe=function(e,t,r,n,i){var o=this,s=function(e,r,n,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,o.protocol.client.subscribe(r,t,e,n,s,i)};return yr(new Promise((function(r,n){var i,a=function(e){r(e)},c=function(e){n(e)};if(e)if((i="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var u=t.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,l=o.getServerMethodsByFilterAndTarget(i,u);if(l.length>0)s(l,l[0].methods[0],a,c);else{var h=function(){if(u&&t.waitTimeoutMs)if(d+=500,(l=o.getServerMethodsByFilterAndTarget(i,u)).length>0){var r=l[0].methods[0];s(l,r,a,c)}else d>=t.waitTimeoutMs?s(l,"string"==typeof e?{name:e}:e,a,c):setTimeout(h,500)};setTimeout(h,500)}}else n(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),r,n)},e.prototype.servers=function(e){var t=void 0===e?void 0:at({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){return e="string"==typeof e?{name:e}:at({},e),this.getMethods(e)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,r){e(t,r)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,r){e({server:t,method:r})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,r){e({server:t,method:r})}))},e.prototype.invoke=function(e,t,r,n,i,o){return ct(this,void 0,void 0,(function(){var s=this;return ut(this,(function(a){return[2,yr(ct(s,void 0,void 0,(function(){var i,o,s,a,c,u,d,l,h,p,f=this;return ut(this,(function(m){switch(m.label){case 0:if(!(i="string"==typeof e?{name:e}:at({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(t||(t={}),r||(r="best"),"string"==typeof r&&"all"!==r&&"best"!==r&&"skipMine"!==r)return[2,Promise.reject(new Error('"'+r+'" is not a valid target. Valid targets are "all" and "best".'))];if(n||(n={}),void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==n.waitTimeoutMs&&"number"!=typeof n.waitTimeoutMs)return[2,Promise.reject(new Error('"'+n.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+i.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(i,r)).length)return[3,4];m.label=1;case 1:return m.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(i,r,n)];case 2:return o=m.sent(),[3,4];case 3:return m.sent(),s=at(at({},i),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(p=i.objectTypes)&&void 0!==p?p:[]}),a={method:s,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(r),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=n.methodResponseTimeoutMs,u=n,d=o.map((function(e){var r=er(),n=f.protocol.client.invoke(r,e.methods[0],t,e.server,u);return Promise.race([n,wr(c,{invocationId:r,message:"Invocation timeout ("+c+" ms) reached",status:mr.Error})])})),[4,Promise.all(d)];case 5:return l=m.sent(),h=this.getInvocationResultObj(l,i,t),l.every((function(e){return e.status===mr.Error}))?[2,Promise.reject(h)]:[2,h]}}))})),i,o)]}))}))},e.prototype.getInvocationResultObj=function(e,t,r){var n=e.filter((function(e){return e.status===mr.Success})).reduce((function(e,n){return e=dt(e,[{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}])}),[]),i=e.filter((function(e){return e.status===mr.Error})).reduce((function(e,n){return e=dt(e,[{executed_by:n.instance,called_with:r,name:t.name,message:n.message}])}),[]),o=e[0];return{method:t,called_with:r,returned:o.result,executed_by:o.instance,all_return_values:n,all_errors:i,message:o.message,status:o.status}},e.prototype.tryToAwaitForMethods=function(e,t,r){var n=this;return new Promise((function(i,o){if(0!==r.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=n.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),i(c);else if(s>=(r.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},e.prototype.filterByTarget=function(e,t){var r=this;if("string"!=typeof e)return(Array.isArray(e)?e:[e]).reduce((function(e,n){var i=t.filter((function(e){return r.instanceMatch(n,e.server.instance)}));return e.concat(i)}),[]);if("all"===e)return dt(t);if("best"===e){var n=t.find((function(e){return e.server.instance.isLocal}));if(n)return[n];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==r.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).reduce((function(r,n){var i,o,s=e[n],a=t[n];return"objectTypes"===n?(s.length>a.length||!1===(i=a,o=s.reduce((function(e,t){return e[t]=!1,e}),{}),i.forEach((function(e){void 0!==o[e]&&(o[e]=!0)})),Object.keys(o).reduce((function(e,t){return o[t]||(e=!1),e}),!0)))&&(r=!1):String(s).toLowerCase()!==String(a).toLowerCase()&&(r=!1),r}),!0)},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((function(r){return t.methodMatch(e,r)}))},e.prototype.getMethodsForInstance=function(e){var t=this,r=this.repo.getServers().filter((function(r){return t.instanceMatch(e,r.instance)}));if(0===r.length)return[];var n={};return 1===r.length?n=r[0].methods:r.forEach((function(e){Object.keys(e.methods).forEach((function(t){var r=e.methods[t];n[r.identifier]=r}))})),Object.keys(n).map((function(e){return n[e]}))},e.prototype.getServers=function(e){var t=this,r=this.repo.getServers();return void 0===e?r.map((function(e){return{server:e,methods:[]}})):r.reduce((function(r,n){var i=t.repo.getServerMethodsById(n.id).filter((function(r){return t.methodMatch(e,r)}));return i.length>0&&r.push({server:n,methods:i}),r}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var r=this.getServers(e);return this.filterByTarget(t,r)},e}(),Ir=function(){function e(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),kr=function(){function e(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),Sr=function(){function e(e,t){var r=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return r.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return r.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return r.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var r=new kr(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var r=new Ir(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var r=new Ir(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}},e}(),xr=function(){function e(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Ir(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),Wr=function(){function e(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,r=this._protocol.server.getBranchList(this._repoMethod);return e?r.indexOf(e)>-1?new xr(e,this._protocol,this._repoMethod):void 0:r.map((function(e){return new xr(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Ir(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Cr=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Sr(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,r,n,i){var o=this;return yr(new Promise((function(r,n){if(e){var s;if(!(s="string"==typeof e?{name:""+e}:at({},e)).name)return n("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(e){return e.definition.name===s.name})))return n('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});o.protocol.server.createStream(a).then((function(){var e;i?(e=i,i.updateRepoMethod(a)):e=new Wr(o.protocol,a,o),a.stream=e,r(e)})).catch((function(e){a.repoId&&o.serverRepository.remove(a.repoId),n(e)}))}else n("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),r,n)},e.prototype.register=function(e,t){var r=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){return ct(r,void 0,void 0,(function(){var r,i,o;return ut(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(r=t(e.args,e.instance))&&"function"==typeof r.then?[4,r]:[3,2];case 1:return i=s.sent(),n(void 0,i),[3,3];case 2:n(void 0,r),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),n(o,o),[3,5];case 5:return[2]}}))}))};return n.userCallback=t,this.registerCore(e,n)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var r=function(e,r){try{var n=!1,i=function(e){n||r(void 0,e),n=!0},o=function(e){n||(e||(e=""),r(e,e)),n=!0},s=t(e.args,e.instance,i,o);s&&"function"==typeof s.then&&s.then(i).catch(o)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),ct(this,void 0,void 0,(function(){var r,n;return ut(this,(function(i){switch(i.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return i.sent(),[2];case 2:return void 0===(r="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(n=this.serverRepository.getList().find((function(e){return e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([n])]:[2,Promise.reject('Method with a name "'+r.name+'" does not exist or is not registered by your application!')];case 3:return i.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return ct(this,void 0,void 0,(function(){var r;return ut(this,(function(n){switch(n.label){case 0:return(r=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==r.length?[4,this.removeMethodsOrStreams(r)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return n.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,r=[];return e.forEach((function(e){var n=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));r.push(n),t.addAsCurrentlyUnregistering(e.definition.name,n)})),Promise.all(r)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return ct(this,void 0,void 0,(function(){var r,n=this;return ut(this,(function(i){return r=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,r]).then((function(){delete n.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return ct(this,void 0,void 0,(function(){var r,n,i,o=this;return ut(this,(function(s){switch(s.label){case 0:return(r="string"==typeof e?{name:""+e}:at({},e)).name?(n=this.currentlyUnregistering[r.name])?[4,n]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(e))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===r.name}))?[2,Promise.reject('A method with the name "'+r.name+'" already exists! Please, provide a unique name for the method.')]:r.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+r.name+" to be a stream, please use the glue.interop.createStream() method.")]:(i=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(i).catch((function(e){throw(null==i?void 0:i.repoId)&&o.serverRepository.remove(i.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,r){var n=this;e&&e.theFunction&&e.theFunction(r,(function(r,i){if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(r)}i?("object"!=typeof i||Array.isArray(i))&&(i={_value:i}):i={},n.protocol.server.methodInvocationResult(e,t,r,i)}))},e}(),Tr=function(){function e(e,t){var r=this;this.wrapped={getMethods:Er,getStreams:_r},e&&this.refreshWrappedObject(e),t&&(t.loggedIn((function(){r.refresh(t)})),this.refresh(t))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,r=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(r)}},e.prototype.refreshWrappedObject=function(e){var t,r,n;this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:er(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(n=null!==(r=e.pid)&&void 0!==r?r:e.process)&&void 0!==n?n:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}();function Er(){var e;return null===(e=Tr.API)||void 0===e?void 0:e.methodsForInstance(this)}function _r(){var e;return null===(e=Tr.API)||void 0===e?void 0:e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))}var Mr=function(){function e(e){this.logger=e,this.servers={},this.methodsCount={},this.callbacks=Dt()}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var r=this.servers[t];if(r)return r.id;var n=new Tr(e),i={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t},e.prototype.removeServerById=function(e,t){var r=this,n=this.servers[e];n?(this.logger.debug("removing server "+e),Object.keys(n.methods).forEach((function(t){r.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",n.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var r=this.servers[e];if(!r)throw new Error("server does not exists");if(!r.methods[t.id]){var n=this.createMethodIdentifier(t),i=this,o={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,getServers:function(){return i.getServersByMethod(n)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,r.methods[t.id]=o,this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,o),o}},e.prototype.removeServerMethod=function(e,t){var r=this.servers[e];if(!r)throw new Error("server does not exists");var n=r.methods[t];delete r.methods[t],this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",n),this.callbacks.execute("onServerMethodRemoved",r.instance,n)},e.prototype.getMethods=function(){var e=this,t={};return Object.keys(this.servers).forEach((function(r){var n=e.servers[r];Object.keys(n.methods).forEach((function(e){var r=n.methods[e];t[r.identifier]=r}))})),Object.keys(t).map((function(e){return t[e]}))},e.prototype.getServers=function(){var e=this,t=[];return Object.keys(this.servers).forEach((function(r){var n=e.servers[r];t.push(n)})),t},e.prototype.getServerMethodsById=function(e){var t=this.servers[e];return Object.keys(t.methods).map((function(e){return t.methods[e]}))},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),r=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,r,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),r=!1,n=this.getServers();return setTimeout((function(){n.forEach((function(t){var n=t.methods;Object.keys(n).forEach((function(i){r||e(t.instance,n[i])}))}))}),0),function(){r=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.servers[e]},e.prototype.reset=function(){var e=this;Object.keys(this.servers).forEach((function(t){e.removeServerById(t,"reset")})),this.servers={},this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t=void 0!==e.input_signature?e.input_signature:"",r=void 0!==e.result_signature?e.result_signature:"";return(e.name+t+r).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=this,r=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){i.methods[t].identifier===e&&r.push(i.instance)}))})),r},e.prototype.returnUnsubWithDelayedReplay=function(e,t,r){var n=!1;return setTimeout((function(){t.forEach((function(e){n||r(e)}))}),0),function(){n=!0,e()}},e}(),Ar=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),Pr=function(){function e(e,t,r){var n=this;this.session=e,this.repository=t,this.serverRepository=r,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=Dt(),this.nextStreamId=0,e.on("add-interest",(function(e){n.handleAddInterest(e)})),e.on("remove-interest",(function(e){n.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var n=this.getStreamId(t,r),i=e.msg.subscription_id,o={id:i,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:n}),this.callbacks.execute("onSubscriptionAdded",o,t)},e.prototype.rejectRequest=function(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)},e.prototype.pushData=function(e,t,r){var n=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!r||0===r.length||r.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var r={type:"publish",stream_id:e,data:t};n.session.sendFireAndForget(r)}))}},e.prototype.pushDataToSingle=function(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");var n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute("onSubscriptionRemoved",t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var r=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var n=e.protocolState.subscriptionsMap,i=Object.keys(n).map((function(e){return n[e]}));"string"==typeof t&&(i=i.filter((function(e){return e.branchKey===t}))),i.forEach((function(e){delete n[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};r.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var r=e.protocolState.subscriptionsMap,n=Object.keys(r).map((function(e){return r[e]}));return"string"!=typeof t?n:n.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,r=Object.keys(t).map((function(e){return t[e]})),n=[];return r.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)})),n},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute("onSubscriptionRemoved",r,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,r={msg:e,arguments:e.arguments_kv||{},instance:t},n=this.serverRepository.getById(e.method_id);if(void 0!==n)n.protocolState.subscriptionsMap&&n.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute("onSubscriptionRequest",r,n);else{var i="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(i,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var r=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n},e}(),Lr=function(){function e(e,t,r,n){var i=this;this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.callbacks=Dt(),this.streaming=new Pr(e,t,r),this.session.on("invoke",(function(e){return i.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var r=this,n=e.definition,i={streaming:t||!1},o={type:"register",methods:[{id:e.repoId,name:n.name,display_name:n.displayName,description:n.description,version:n.version,flags:i,object_types:n.objectTypes||n.object_types,input_signature:n.accepts,result_signature:n.returns,restrictions:void 0}]};return this.session.send(o,{methodId:e.repoId}).then((function(){r.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw r.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,r,n){var i;i=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(i)},e.prototype.unregister=function(e){return ct(this,void 0,void 0,(function(){var t;return ut(this,(function(r){switch(r.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return r.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,r){this.streaming.pushData(e,t,r)},e.prototype.pushDataToSingle=function(e,t,r){this.streaming.pushDataToSingle(e,t,r)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)},e.prototype.rejectRequest=function(e,t,r){this.streaming.rejectRequest(e,t,r)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,r=e.caller_id,n=e.method_id,i=e.arguments_kv,o=this.serverRepository.getList().filter((function(e){return e.repoId===n}))[0];if(void 0!==o){var s={args:i,instance:this.clientRepository.getServerById(r).instance};this.callbacks.execute("onInvoked",o,t,s)}},e}(),Dr=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),jr=function(){function e(e,t,r){var n=this;this.session=e,this.repository=t,this.logger=r,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,r=t.subLocalKey,i=n.subscriptionsList[r];if("object"==typeof i&&(i.trackedServers=i.trackedServers.filter((function(e){return e.serverId!==t.serverId})),i.trackedServers.length<=0)){if(clearTimeout(i.timeoutId),"awaitingAccept"===i.status){var o="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof i.params.arguments?JSON.stringify(i.params.arguments):"{}";i.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:i.params.arguments,method:i.method})}else"subscribed"===i.status&&n.callOnClosedHandlers(i);delete n.subscriptionsList[r]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,r=n.subscriptionsList[t];if("object"==typeof r){var i=e._tag.serverId,o=r.trackedServers.filter((function(e){return e.serverId===i}))[0];if("object"==typeof o){o.subscriptionId=e.subscription_id,n.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s="awaitingAccept"===r.status;if(r.status="subscribed",s){var a=!1,c=r.subscription;c?(c.setNewSubscription(r),r.success(c),a=!0):(c=new Dr(n.repository,r),r.subscription=c,r.success(c));for(var u=0,d=r.handlers.onConnected;u<d.length;u++){var l=d[u];try{l(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=n.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var r=n.subscriptionsList[t];if("object"==typeof r){var i=r.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===i.length){var o=e.oob,s=i[0].serverId,a=function(){return{data:e.data,server:n.repository.getServerById(s).instance,requestArguments:r.params.arguments,message:void 0,private:o}},c=r.handlers.onData,u=r.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=n.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var r=n.subscriptionsList[t];if("object"==typeof r){var i=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1)})),r.trackedServers.length===i&&(r.trackedServers.length<=0&&(clearTimeout(r.timeoutId),n.callOnClosedHandlers(r),delete n.subscriptionsList[t]),delete n.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,r,n,i,o){var s=this;if(0!==r.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,n,i,t.methodResponseTimeout||1e4,o);"object"==typeof c?r.forEach((function(r){var n=r.server.id,i=r.methods.find((function(t){return t.name===e.name}));if(i){c.trackedServers.push({serverId:n,subscriptionId:void 0});var o={type:"subscribe",server_id:n,method_id:i.gatewayId,arguments_kv:t.arguments};s.session.send(o,{serverId:n,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+r.server.id)})):i({method:e,called_with:t.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else i({method:e,called_with:t.arguments,message:"Subscription failed. No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,r,n,i,o,s){var a=this,c={localKey:e,status:"awaitingAccept",method:t,params:r,success:n,error:i,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(r.onData&&c.handlers.onData.push(r.onData),r.onClosed&&c.handlers.onClosed.push(r.onClosed),r.onConnected&&c.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var n=a.subscriptionsList[e];"awaitingAccept"===n.status?(i({method:t,called_with:r.arguments,message:"Subscription failed. Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[e]):"subscribed"===n.status&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete n.timeoutId,n.trackedServers.length<=0&&(a.callOnClosedHandlers(n),delete a.subscriptionsList[e]))}}),o),c},e.prototype.callOnClosedHandlers=function(e,t){var r,n=e.queued.closers.length,i=n>0?e.queued.closers[n-1]:null;void 0!==i&&"string"==typeof i&&(r=this.repository.getServerById(i).instance),e.handlers.onClosed.forEach((function(n){"function"==typeof n&&n({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:r,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,r=this.subscriptionsList[e];"object"==typeof r&&(r.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(r.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),r.trackedServers=[],this.callOnClosedHandlers(r,"ClientInitiated"),delete this.subscriptionsList[e])},e}(),Or=function(){function e(e,t,r){var n=this;this.session=e,this.repository=t,this.logger=r,e.on("peer-added",(function(e){return n.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return n.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return n.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return n.handleMethodsRemovedMessage(e)})),this.streaming=new jr(e,t,r)}return e.prototype.subscribe=function(e,t,r,n,i,o){this.streaming.subscribe(e,t,r,n,i,o)},e.prototype.invoke=function(e,t,r,n){var i=this,o=n.id,s={type:"call",server_id:o,method_id:t.gatewayId,arguments_kv:r};return this.session.send(s,{invocationId:e,serverId:o}).then((function(e){return i.handleResultMessage(e)})).catch((function(e){return i.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,i=Number(r.process),o={machine:r.machine,pid:isNaN(i)?r.process:i,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(o,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,r=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(r,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,r=e.server_id,n=e.methods,i=this.repository.getServerById(r);Object.keys(i.methods).forEach((function(e){var o=i.methods[e];n.indexOf(o.gatewayId)>-1&&t.repository.removeServerMethod(r,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,r=e.result,n=e._tag.serverId;return{invocationId:t,result:r,instance:this.repository.getServerById(n).instance,status:mr.Success,message:""}},e.prototype.handleInvocationError=function(e){if(this.logger.debug("handle invocation error "+JSON.stringify(e)),"_tag"in e){var t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),i=e.reason;return{invocationId:t,result:e.context,instance:n.instance,status:mr.Error,message:i}}return{invocationId:"",message:e.message,status:mr.Error,error:e}},e}();function Rr(e,t,r,n,i,o){var s,a=i.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),u=t.domain("agm",["subscribed"]),d=new Lr(u,r,n,a.subLogger("server")),l=new Or(u,r,a.subLogger("client"));return u.onJoined((function(i){r.addServer(e,t.peerId),i?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var e=0,t=l.drainSubscriptions();e<t.length;e++){var r=t[e],i=r.method,s=Object.assign({},r.params);a.info("trying to re-subscribe to method "+i.name),o.client.subscribe(i,s,void 0,void 0,r)}var c=n.getList();n.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],p=h.definition;a.info("re-publishing method "+p.name),h.stream?o.server.createStream(p,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(p,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(p,h.theFunction.userCallbackAsync)}}():s&&(s({client:l,server:d}),s=void 0)})),u.onLeft((function(){r.reset()})),u.join(),c}var Fr=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var r,n=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),Tr.API=this,this.instance=new Tr(void 0,n).unwrap(),this.clientRepository=new Mr(e.logger.subLogger("cRep")),this.serverRepository=new Ar,3!==n.protocolVersion)throw new Error("protocol "+n.protocolVersion+" not supported");r=Rr(this.instance,n,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then((function(r){return t.protocol=r,t.client=new br(t.protocol,t.clientRepository,t.instance,e),t.server=new Cr(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,r,n){return this.client.subscribe(e,t,r,n)},e.prototype.createStream=function(e,t,r,n){return this.server.createStream(e,t,r,n)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,r,n,i,o){return this.client.invoke(e,t,r,n,i,o)},e}(),Nr=["subscribed","success"],Br=function(){function e(e,t){var r=this;this.publish=function(e,t,n){var i=n||{},o=i.routingKey,s=i.target,a=r.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:r.peerId,routing_key:o,target_identity:s});r.session.send(a)},this.subscribe=function(e,t,n){return new Promise((function(i,o){var s=n||{},a=s.routingKey,c=s.target,u=r.removeEmptyValues({type:"subscribe",topic:e,peer_id:r.peerId,routing_key:a,source:c});r.session.send(u).then((function(n){var o=n.subscription_id;r.subscriptions.push({subscription_id:o,topic:e,callback:t,source:c}),i({unsubscribe:function(){return r.session.send({type:"unsubscribe",subscription_id:o,peer_id:r.peerId}),r.subscriptions=r.subscriptions.filter((function(e){return e.subscription_id!==o})),Promise.resolve()}})})).catch((function(e){return o(e)}))}))},this.watchOnEvent=function(){r.session.on("event",(function(e){var t=e.data,n=e.subscription_id,i=e["publisher-identity"],o=r.subscriptions.find((function(e){return e.subscription_id===n}));o&&(o.source?r.keysMatch(o.source,i)&&o.callback(t,o.topic,i):o.callback(t,o.topic,i))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",Nr),this.readyPromise=this.session.join(),this.readyPromise.then((function(){r.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(r){void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])})),t},e.prototype.keysMatch=function(e,t){var r=Object.keys(e),n=!0;return r.forEach((function(r){e[r]!==t[r]&&(n=!1)})),n},e}(),Ur=function(e,t){var r,n=Rt.getGDMajorVersion(),i=Promise.resolve();if(n){if(n<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");n>=3&&(r=window.glue42gd,i=window.gdPreloadPromise||i)}var o,s,a,c,u,d,l=ur(),h=cr(e=e||{},t=t||{},r),p={};function f(e,t,r){a.canPublish("trace")&&a.trace("registering "+e+" module");var n=function(){t.initTime=r.stop(),t.initEndTime=r.endTime,a.trace(e+" is ready")};t.initStartTime=r.startTime,t.ready?t.ready().then((function(){n()})):n(),Array.isArray(e)||(e=[e]),e.forEach((function(e){p[e]=t,Ur[e]=t}))}function m(){var e,t,n,i=ur(),s=h.metrics,u=null==r?void 0:r.getMetricsPublishingEnabled,d=h.connection.identity,l=u||function(){return!0},p=_t({connection:s?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:l,system:"Glue42",service:null!==(e=null==d?void 0:d.service)&&void 0!==e?e:"metrics-service",instance:null!==(n=null!==(t=null==d?void 0:d.instance)&&void 0!==t?t:null==d?void 0:d.windowId)&&void 0!==n?n:er()}),m=p;return m="boolean"!=typeof s&&s.disableAutoAppSystem?p:p.subSystem("App"),f("metrics",c=function(e){var t,r=e.subSystem("reporting"),n={name:"features"};return e.featureMetric=function(e,i,o){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");t?t.update({name:e,action:i,payload:o}):t=r.objectMetric(n,{name:e,action:i,payload:o})},e}(m),i),Promise.resolve()}function g(){var e=h.activities&&3===o.protocolVersion;if(h.contexts||e){var t=ur();return f("contexts",u=new vr({connection:o,logger:a.subLogger("contexts")}),t),u}var r=o.replayer;r&&r.drain(ar.name)}function v(){return ct(this,void 0,void 0,(function(){var e;return ut(this,(function(t){return h.bus?(e=ur(),f("bus",d=new Br(o,a.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function y(e){try{return e.forEach((function(e){!function(e,t){var r=ur(),n=t(p);n&&f(e,n,r)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return i.then((function(){var e,t=ur();return(a=new sr(""+(null===(e=h.connection.identity)||void 0===e?void 0:e.application),void 0,h.customLogger)).consoleLevel(h.logger.console),a.publishLevel(h.logger.publish),f("logger",a,t),Promise.resolve(void 0)})).then((function(){var e=ur();o=new ir(h.connection,a.subLogger("connection"));var t=Promise.resolve(h.auth);return h.connection&&!h.auth&&(r?(a.trace("trying to get gw token..."),t=r.getGWToken().then((function(e){return a.trace("got GW token "+(null==e?void 0:e.substring(e.length-10))),{gatewayToken:e}}))):t=Promise.reject("You need to provide auth information")),t.then((function(e){var t;if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return t=e,o.login(t)})).then((function(){return f("connection",o,e),h})).catch((function(e){throw o&&o.logout(),e}))})).then((function(){return Promise.all([m(),(e=ur(),t={connection:o,logger:a.subLogger("interop")},s=new Fr(t),sr.Interop=s,f(["interop","agm"],s,e),Promise.resolve()),g(),v()]);var e,t})).then((function(){return s.readyPromise})).then((function(){return y(h.libs||[])})).then((function(){var e=Object.keys(p).map((function(e){var t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var n={coreVersion:"5.0.7",version:h.version};l.stop();var i={feedback:function(e){s&&s.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:h.version,userConfig:e,done:function(){return null==a||a.info("done called by user..."),o.logout()}};return i.performance={get glueVer(){return h.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=Object.keys(i).filter((function(e){var t;return"initTimes"!==e&&"agm"!==e&&(null===(t=i[e])||void 0===t?void 0:t.initTime)})).map((function(e){return{name:e,time:i[e].initTime,startTime:i[e].initStartTime,endTime:i[e].initEndTime}}));return e.push({name:"glue",startTime:l.startTime,endTime:l.endTime,time:l.period}),e}},Object.keys(p).forEach((function(e){var t=p[e];i[e]=t})),i.config={},Object.keys(h).forEach((function(e){i.config[e]=h[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){i.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(i),r&&r.updatePerfData&&r.updatePerfData(i.performance),i})).catch((function(e){return Promise.reject({err:e,libs:p})}))};"undefined"!=typeof window&&(window.GlueCore=Ur),Ur.version="5.0.7",Ur.default=Ur;var zr,Gr=(zr=Ur,function(e){return s(void 0,void 0,void 0,(function(){var t,r,n,i,c,u,d,l,h,p,f,m,g,v,y,w,b,I,k,S,x,W,C,T,E,_,A,P;return a(this,(function(j){switch(j.label){case 0:return[4,(N=e,s(void 0,void 0,void 0,(function(){var e,t,r,n;return a(this,(function(i){switch(i.label){case 0:return[4,je(N=null!=N?N:{})];case 1:return e=i.sent(),(null==(t=o(o(o({},De),e.glue),N))?void 0:t.extends)&&(r=t.extends.lastIndexOf("/"),n=t.extends.substr(0,r+1)+"worker.js",t.worker=n),e.layouts||(e.layouts={remoteType:"json"}),[2,o(o({},e),{glue:t})]}}))})))];case 1:return t=j.sent(),r="undefined"!=typeof window,n=(null===(v=t.glue)||void 0===v?void 0:v.channels)||!1,i=(null===(y=t.glue)||void 0===y?void 0:y.appManager)||!1,r&&(null==(c=window)?void 0:c.glue42gd)&&(null==c?void 0:c.Glue)?[2,c.Glue({windows:!0,logger:null===(w=t.glue)||void 0===w?void 0:w.logger,channels:n,layouts:!0,appManager:i})]:(u=new M,h={libs:[{name:"notifications",create:function(e){return new Le(e.interop)}}],version:"1.2.1"},n&&(p={name:"channels",create:function(e){return new be(e.contexts,t.channels)}},null===(b=h.libs)||void 0===b||b.push(p)),r&&(null===(I=h.libs)||void 0===I||I.push({name:"windows",create:function(e){return d=new D(e.interop,u)}},{name:"layouts",create:function(e){var r,n;"json"===(null===(r=t.layouts)||void 0===r?void 0:r.remoteType)&&(n=new rt("/glue"));var i=new tt,o=new nt,s=new Re(i,o,n);return l=new Oe(s,d,u,e.interop,null==t?void 0:t.glue),new ye(l)}}),i&&(f={name:"appManager",create:function(e){var r;return new Pe(d,e.interop,u,t.appManager,null===(r=t.glue)||void 0===r?void 0:r.application)}},null===(k=h.libs)||void 0===k||k.push(f))),m={gateway:{sharedWorker:null!==(x=null===(S=t.glue)||void 0===S?void 0:S.worker)&&void 0!==x?x:"/glue/worker.js",inproc:null===(W=t.glue)||void 0===W?void 0:W.inproc},logger:null===(C=t.glue)||void 0===C?void 0:C.logger,application:null===(T=t.glue)||void 0===T?void 0:T.application},[4,zr(m,h)]);case 2:return g=j.sent(),(null==e?void 0:e.libraries)?[4,Promise.all(e.libraries.map((function(e){return e(g,null==t?void 0:t.glue)})))]:[3,4];case 3:j.sent(),j.label=4;case 4:return u.start(g.interop,g.logger.subLogger("control")),r?[4,(O=g.windows.my(),R=g.interop,F=null===(E=g.appManager)||void 0===E?void 0:E.myInstance,s(void 0,void 0,void 0,(function(){var e,t;return a(this,(function(r){switch(r.label){case 0:return e=L(O.id),R.methods().find((function(t){return t.name===e}))?[4,R.invoke(e)]:[3,2];case 1:t=r.sent(),O&&(O.setContext(t.returned.context),O.name=t.returned.name,O.parent=t.returned.parent,F&&(F.startedByScript=!0,F.context=t.returned.context)),r.label=2;case 2:return[2]}}))})))]:[3,9];case 5:return j.sent(),(null===(A=null===(_=t.glue)||void 0===_?void 0:_.layouts)||void 0===A?void 0:A.autoRestore)?[4,null==l?void 0:l.restoreAutoSavedLayout()]:[3,7];case 6:j.sent(),j.label=7;case 7:return[4,it(g,null!==(P=t.glue)&&void 0!==P?P:{},u,l)];case 8:j.sent(),j.label=9;case 9:return[2,g]}var O,R,F,N}))}))});if("undefined"!=typeof window){var qr=window;qr.GlueWeb=Gr,delete qr.GlueCore}return Gr.default=Gr,Gr.version="1.2.1",Gr},e.exports=o()}).call(this,r(1),r(3).Buffer,r(7))},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){r(10),r(0),e.exports=r(9)},function(e,t,r){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var n=r(4),i=r(5),o=r(6);function s(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,r){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return l(this,e)}return u(this,e,t,r)}function u(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,n){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n);c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=h(e,t);return e}(e,t,r,n):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!c.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|f(t,r),i=(e=a(e,n)).write(t,r);i!==n&&(e=e.slice(0,i));return e}(e,t,r):function(e,t){if(c.isBuffer(t)){var r=0|p(t.length);return 0===(e=a(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?a(e,0):h(e,t);if("Buffer"===t.type&&o(t.data))return h(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function d(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function l(e,t){if(d(t),e=a(e,t<0?0:0|p(t)),!c.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function h(e,t){var r=t.length<0?0:0|p(t.length);e=a(e,r);for(var n=0;n<r;n+=1)e[n]=255&t[n];return e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function f(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return B(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return U(e).length;default:if(n)return B(e).length;t=(""+t).toLowerCase(),n=!0}}function m(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return _(this,t,r);case"utf8":case"utf-8":return C(this,t,r);case"ascii":return T(this,t,r);case"latin1":case"binary":return E(this,t,r);case"base64":return W(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function g(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function v(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:y(e,t,r,n,i);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):y(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function y(e,t,r,n,i){var o,s=1,a=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,r/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var d=-1;for(o=r;o<a;o++)if(u(e,o)===u(t,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===c)return d*s}else-1!==d&&(o-=o-d),d=-1}else for(r+c>a&&(r=a-c),o=r;o>=0;o--){for(var l=!0,h=0;h<c;h++)if(u(e,o+h)!==u(t,h)){l=!1;break}if(l)return o}return-1}function w(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function b(e,t,r,n){return z(B(t,e.length-r),e,r,n)}function I(e,t,r,n){return z(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function k(e,t,r,n){return I(e,t,r,n)}function S(e,t,r,n){return z(U(t),e,r,n)}function x(e,t,r,n){return z(function(e,t){for(var r,n,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,i=r%256,o.push(i),o.push(n);return o}(t,e.length-r),e,r,n)}function W(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function C(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var o,s,a,c,u=e[i],d=null,l=u>239?4:u>223?3:u>191?2:1;if(i+l<=r)switch(l){case 1:u<128&&(d=u);break;case 2:128==(192&(o=e[i+1]))&&(c=(31&u)<<6|63&o)>127&&(d=c);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(c=(15&u)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(d=c);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(d=c)}null===d?(d=65533,l=1):d>65535&&(d-=65536,n.push(d>>>10&1023|55296),d=56320|1023&d),n.push(d),i+=l}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=4096));return r}(n)}t.Buffer=c,t.SlowBuffer=function(e){+e!=e&&(e=0);return c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,r){return u(null,e,t,r)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,r){return function(e,t,r,n){return d(t),t<=0?a(e,t):void 0!==r?"string"==typeof n?a(e,t).fill(r,n):a(e,t).fill(r):a(e,t)}(null,e,t,r)},c.allocUnsafe=function(e){return l(null,e)},c.allocUnsafeSlow=function(e){return l(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);i<o;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=c.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var s=e[r];if(!c.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(n,i),i+=s.length}return n},c.byteLength=f,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?C(this,0,e):m.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,r,n,i){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(n>>>=0),s=(r>>>=0)-(t>>>=0),a=Math.min(o,s),u=this.slice(n,i),d=e.slice(t,r),l=0;l<a;++l)if(u[l]!==d[l]){o=u[l],s=d[l];break}return o<s?-1:s<o?1:0},c.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return v(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return v(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return w(this,e,t,r);case"utf8":case"utf-8":return b(this,e,t,r);case"ascii":return I(this,e,t,r);case"latin1":case"binary":return k(this,e,t,r);case"base64":return S(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function T(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function E(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function _(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=t;o<r;++o)i+=N(e[o]);return i}function M(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function A(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,r,n,i,o){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function L(e,t,r,n){t<0&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-r,2);i<o;++i)e[r+i]=(t&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function D(e,t,r,n){t<0&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-r,4);i<o;++i)e[r+i]=t>>>8*(n?i:3-i)&255}function j(e,t,r,n,i,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function O(e,t,r,n,o){return o||j(e,0,r,4),i.write(e,t,r,n,23,4),r+4}function R(e,t,r,n,o){return o||j(e,0,r,8),i.write(e,t,r,n,52,8),r+8}c.prototype.slice=function(e,t){var r,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=c.prototype;else{var i=t-e;r=new c(i,void 0);for(var o=0;o<i;++o)r[o]=this[o+e]}return r},c.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},c.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},c.prototype.readUInt8=function(e,t){return t||A(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||A(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||A(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||A(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||A(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return t||A(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||A(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){t||A(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return t||A(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||A(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||A(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||A(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||A(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||A(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||P(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,o=0;for(this[t]=255&e;++o<r&&(i*=256);)this[t+o]=e/i&255;return t+r},c.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||P(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+r},c.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):D(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):D(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t|=0,!n){var i=Math.pow(2,8*r-1);P(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t|=0,!n){var i=Math.pow(2,8*r-1);P(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):D(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):D(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,r){return O(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return O(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return R(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return R(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i,o=n-r;if(this===e&&r<t&&t<n)for(i=o-1;i>=0;--i)e[i+t]=this[i+r];else if(o<1e3||!c.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var s=c.isBuffer(e)?e:B(new c(e,n).toString()),a=s.length;for(o=0;o<r-t;++o)this[o+t]=s[o%a]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function N(e){return e<16?"0"+e.toString(16):e.toString(16)}function B(e,t){var r;t=t||1/0;for(var n=e.length,i=null,o=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function U(e){return n.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function z(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}}).call(this,r(1))},function(e,t,r){"use strict";t.byteLength=function(e){var t=u(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,n=u(e),s=n[0],a=n[1],c=new o(function(e,t,r){return 3*(t+r)/4-r}(0,s,a)),d=0,l=a>0?s-4:s;for(r=0;r<l;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],c[d++]=t>>16&255,c[d++]=t>>8&255,c[d++]=255&t;2===a&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,c[d++]=255&t);1===a&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,c[d++]=t>>8&255,c[d++]=255&t);return c},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,o=[],s=0,a=r-i;s<a;s+=16383)o.push(d(e,s,s+16383>a?a:s+16383));1===i?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return o.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=s.length;a<c;++a)n[a]=s[a],i[s.charCodeAt(a)]=a;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function d(e,t,r){for(var i,o,s=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,r,n,i){var o,s,a=8*i-n-1,c=(1<<a)-1,u=c>>1,d=-7,l=r?i-1:0,h=r?-1:1,p=e[t+l];for(l+=h,o=p&(1<<-d)-1,p>>=-d,d+=a;d>0;o=256*o+e[t+l],l+=h,d-=8);for(s=o&(1<<-d)-1,o>>=-d,d+=n;d>0;s=256*s+e[t+l],l+=h,d-=8);if(0===o)o=1-u;else{if(o===c)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),o-=u}return(p?-1:1)*s*Math.pow(2,o-n)},t.write=function(e,t,r,n,i,o){var s,a,c,u=8*o-i-1,d=(1<<u)-1,l=d>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:o-1,f=n?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+l>=1?h/c:h*Math.pow(2,1-l))*c>=2&&(s++,c/=2),s+l>=d?(a=0,s=d):s+l>=1?(a=(t*c-1)*Math.pow(2,i),s+=l):(a=t*Math.pow(2,l-1)*Math.pow(2,i),s=0));i>=8;e[r+p]=255&a,p+=f,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[r+p]=255&s,p+=f,s/=256,u-=8);e[r+p-f]|=128*m}},function(e,t){var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t){var r,n,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===o||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:o}catch(e){r=o}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var c,u=[],d=!1,l=-1;function h(){d&&c&&(d=!1,c.length?u=c.concat(u):l=-1,u.length&&p())}function p(){if(!d){var e=a(h);d=!0;for(var t=u.length;t;){for(c=u,u=[];++l<t;)c&&c[l].run();l=-1,t=u.length}c=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new f(e,t)),1!==u.length||d||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,r){"use strict";e.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},function(e,t,r){e.exports=function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function e(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function t(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t){var n=r[e];return n||(n=[],r[e]=n),n.push(t),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}t.default=t;var r=t,n=function(e){return{ok:!0,result:e}},i=function(e){return{ok:!1,error:e}},o=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},s=function(e,t){return!0===t.ok?t.result:e},a=function(e){if(!0===e.ok)return e.result;throw e.error},c=function(e,t){return!0===t.ok?n(e(t.result)):t},u=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:n(e(t.result,r.result))},d=function(e,t){return!0===t.ok?t:i(e(t.error))},l=function(e,t){return!0===t.ok?e(t.result):t},h=(Object.freeze({ok:n,isOk:function(e){return!0===e.ok},err:i,isErr:function(e){return!1===e.ok},asPromise:o,withDefault:s,withException:a,successes:function(e){return e.reduce((function(e,t){return!0===t.ok?e.concat(t.result):e}),[])},map:c,map2:u,mapError:d,andThen:l}),function(){return(h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)}),p=function(e){return Array.isArray(e)},f=function(e){return"object"==typeof e&&null!==e&&!p(e)},m=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},g=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},v=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return h({at:e+(r||"")},n)},y=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return d((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return o(r.run(e))},this.runWithException=function(e){return a(r.run(e))},this.map=function(t){return new e((function(e){return c(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return l((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?n(e):i({message:m("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?n(e):i({message:m("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?n(e):i({message:m("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return function e(t,r){if(t===r)return!0;if(null===t&&null===r)return!0;if(typeof t!=typeof r)return!1;if("object"==typeof t){if(Array.isArray(t)){if(!Array.isArray(r))return!1;if(t.length!==r.length)return!1;for(var n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1;return!0}var i=Object.keys(t);if(i.length!==Object.keys(r).length)return!1;for(n=0;n<i.length;n++){if(!r.hasOwnProperty(i[n]))return!1;if(!e(t[i[n]],r[i[n]]))return!1}return!0}}(e,t)?n(t):i({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(f(e)&&t){var r={};for(var o in t)if(t.hasOwnProperty(o)){var s=t[o].decode(e[o]);if(!0!==s.ok)return void 0===e[o]?i({message:"the key '"+o+"' is required but was not present"}):i(v("."+o,s.error));void 0!==s.result&&(r[o]=s.result)}return n(r)}return f(e)?n(e):i({message:m("an object",e)})}))},e.array=function(t){return new e((function(e){return p(e)&&t?e.reduce((function(e,r,n){return u((function(e,t){return e.concat([t])}),e,function(e,r){return d((function(e){return v("["+r+"]",e)}),t.decode(e))}(r,n))}),n([])):p(e)?n(e):i({message:m("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(p(e)){if(e.length!==t.length)return i({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],o=0;o<t.length;o++){var s=t[o].decode(e[o]);if(!s.ok)return i(v("["+o+"]",s.error));r[o]=s.result}return n(r)}return i({message:m("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];return new e((function(e){return[t,r].concat(i).reduce((function(t,r){return u(Object.assign,t,r.decode(e))}),n({}))}))},e.anyJson=function(){return new e((function(e){return n(e)}))},e.unknownJson=function(){return new e((function(e){return n(e)}))},e.dict=function(t){return new e((function(e){if(f(e)){var r={};for(var o in e)if(e.hasOwnProperty(o)){var s=t.decode(e[o]);if(!0!==s.ok)return i(v("."+o,s.error));r[o]=s.result}return n(r)}return i({message:m("an object",e)})}))},e.optional=function(t){return new e((function(e){return void 0===e?n(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return i({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return n(s(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return i({at:g(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!f(n))return i({at:g(t.slice(0,o+1)),message:m("an object",n)});if("number"==typeof t[o]&&!p(n))return i({at:g(t.slice(0,o+1)),message:m("an array",n)});n=n[t[o]]}return d((function(e){return void 0===n?{at:g(t),message:"path does not exist"}:v(g(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return n(t)}))},e.fail=function(t){return new e((function(e){return i({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),w=y.string,b=y.number,I=y.boolean,k=y.anyJson,S=y.constant,x=y.object,W=y.array,C=y.optional,T=y.oneOf,E=y.intersection,_=y.lazy;const M=w().where(e=>e.length>0,"Expected a non-empty string"),A=b().where(e=>e>=0,"Expected a non-negative number"),P=x({inWorkspace:I()}),L=T(S("workspace"),S("row"),S("column"),S("group")),D=T(S("row"),S("column"),S("group")),j=(e,t)=>{const r=typeof e;if(t&&"function"!==r&&"undefined"!==r)throw new Error("Provided argument must be either undefined or of type function, provided: "+r);if(!t&&"function"!==r)throw new Error("Provided argument must be of type function, provided: "+r)},O=C(x({saveLayout:C(I())})),R=x({name:M}),F=x({type:C(S("window")),appName:C(M),windowId:C(M)}),N=C(x({type:C(D),children:C(_(()=>W(T(F,N))))})),B=x({type:D,children:C(_(()=>W(T(F,N))))}),U=(T(w().where(e=>"maximized"===e.toLowerCase(),"Expected a case insensitive variation of 'maximized'"),w().where(e=>"normal"===e.toLowerCase(),"Expected a case insensitive variation of 'normal'")),x({bounds:C(x({left:C(b()),top:C(b()),width:C(A),height:C(A)}))})),z=T(S("direct"),S("delayed"),S("lazy")),G=C(x({app:C(M),context:C(k()),restoreType:C(z),title:C(M),reuseWorkspaceId:C(M),frameId:C(M),lockdown:C(I()),activateFrame:C(I()),newFrame:C(T(U,I())),inMemoryLayout:C(I())})),q=x({name:M,restoreOptions:C(G)}),H=x({children:C(W(T(F,N))),context:C(k()),config:C(x({title:C(M),position:C(A),isFocused:C(I())})),frame:C(x({reuseFrameId:C(M),newFrame:C(T(I(),U))}))}),J=x({type:L,definition:T(H,N)}),K=E(H,x({saveConfig:C(x({saveLayout:C(I())}))})),$=x({itemId:M}),Y=x({id:M}),V=(x({id:M,frameId:M,positionIndex:b(),title:M,focused:I()}),x({type:D,id:M,frameId:M,workspaceId:M,positionIndex:b()}),x({id:C(M),frameId:M,workspaceId:M,positionIndex:b(),isMaximized:I(),title:C(w()),isLoaded:I(),focused:I(),type:S("window")}),x({type:T(S("frame"),S("workspace"),S("container"),S("window")),branch:M})),X=T(S("opened"),S("closing"),S("closed"),S("focus"),S("added"),S("loaded"),S("removed"),S("childrenUpdate"),S("containerChange")),Z=x({frameId:M,title:M,positionIndex:A,name:M}),Q=x({frameId:M,workspaceId:M,positionIndex:A}),ee=k(),te=E(Q,x({windowId:C(M),isMaximized:I(),isLoaded:I(),isFocused:I(),title:C(w())})),re=x({id:M,config:T(ee,te),children:C(_(()=>W(re))),type:T(S("window"),S("row"),S("column"),S("group"))}),ne=x({id:M,config:Z,children:W(re),frameSummary:Y}),ie=x({id:C(M),config:T(ee,te),children:C(_(()=>W(ie))),type:T(S("window"),S("row"),S("column"),S("group"))}),oe=(x({id:C(M),children:W(ie)}),x({type:S("window"),config:x({appName:M,url:C(M)})})),se=x({type:S("group"),config:k(),children:W(T(oe))}),ae=x({type:S("column"),config:k(),children:W(T(se,oe,_(()=>ae),_(()=>ce)))}),ce=x({type:S("row"),config:k(),children:W(T(ae,se,oe,_(()=>ce)))}),ue=x({name:M,type:S("Workspace"),metadata:C(k()),components:W(x({type:S("Workspace"),state:x({config:k(),children:W(T(ce,ae,se,oe))})}))}),de=x({layouts:W(ue)}),le=x({id:M}),he=x({summaries:W(le)}),pe=x({id:M,config:Z}),fe=x({summaries:W(pe)}),me=x({id:M,config:k(),workspaces:W(ne)}),ge=x({name:M}),ve=x({summaries:W(ge)}),ye=x({windowId:M}),we=k(),be=x({width:C(A),height:C(A),relative:C(I())}),Ie=x({top:C(b()),left:C(b()),relative:C(I())}),ke=x({itemId:M}),Se=x({itemId:M,title:M}),xe=x({itemId:M,containerId:M}),We=E(ke,be),Ce=E(ke,Ie),Te=(x({id:M,type:D}),x({definition:F,parentId:M,parentType:L})),Ee=x({definition:B,parentId:M,parentType:L}),_e=x({itemId:M,windowId:C(M)}),Me=x({type:T(S("row"),S("column")),workspaceId:M}),Ae=x({itemId:M,config:ee}),Pe=x({frameSummary:Y}),Le=x({workspaceSummary:pe,frameSummary:Y}),De=x({containerSummary:Ae}),je=x({windowSummary:x({itemId:M,parentId:M,config:te})}),Oe=x({name:M,workspaceId:M}),Re={control:{name:"T42.Workspaces.Control",isStream:!1},frameStream:{name:"T42.Workspaces.Stream.Frame",isStream:!0},workspaceStream:{name:"T42.Workspaces.Stream.Workspace",isStream:!0},containerStream:{name:"T42.Workspaces.Stream.Container",isStream:!0},windowStream:{name:"T42.Workspaces.Stream.Window",isStream:!0}},Fe={frame:{name:"T42.Workspaces.Stream.Frame",payloadDecoder:Pe},workspace:{name:"T42.Workspaces.Stream.Workspace",payloadDecoder:Le},container:{name:"T42.Workspaces.Stream.Container",payloadDecoder:De},window:{name:"T42.Workspaces.Stream.Window",payloadDecoder:je}},Ne={isWindowInWorkspace:{name:"isWindowInWorkspace",argsDecoder:ke,resultDecoder:P},createWorkspace:{name:"createWorkspace",resultDecoder:ne,argsDecoder:K},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:he},getFrameSummary:{name:"getFrameSummary",resultDecoder:Y,argsDecoder:$},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:fe},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",resultDecoder:ne,argsDecoder:ke},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:ve},openWorkspace:{name:"openWorkspace",argsDecoder:q,resultDecoder:ne},deleteLayout:{name:"deleteLayout",resultDecoder:we,argsDecoder:R},saveLayout:{name:"saveLayout",resultDecoder:ue,argsDecoder:Oe},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:de},restoreItem:{name:"restoreItem",argsDecoder:ke,resultDecoder:we},maximizeItem:{name:"maximizeItem",argsDecoder:ke,resultDecoder:we},focusItem:{name:"focusItem",argsDecoder:ke,resultDecoder:we},closeItem:{name:"closeItem",argsDecoder:ke,resultDecoder:we},resizeItem:{name:"resizeItem",argsDecoder:We,resultDecoder:we},moveFrame:{name:"moveFrame",argsDecoder:Ce,resultDecoder:we},getFrameSnapshot:{name:"getFrameSnapshot",argsDecoder:ke,resultDecoder:me},forceLoadWindow:{name:"forceLoadWindow",argsDecoder:ke,resultDecoder:ye},ejectWindow:{name:"ejectWindow",argsDecoder:ke,resultDecoder:we},setItemTitle:{name:"setItemTitle",argsDecoder:Se,resultDecoder:we},moveWindowTo:{name:"moveWindowTo",argsDecoder:xe,resultDecoder:we},addWindow:{name:"addWindow",argsDecoder:Te,resultDecoder:_e},addContainer:{name:"addContainer",argsDecoder:Ee,resultDecoder:_e},bundleWorkspace:{name:"bundleWorkspace",argsDecoder:Me,resultDecoder:we}};class Be{constructor(e,t){this.bridge=e,this.base=t}checkIsInSwimlane(t){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send(Ne.isWindowInWorkspace.name,{itemId:t})).inWorkspace}))}createWorkspace(t,r){return e(this,void 0,void 0,(function*(){const e=Object.assign({},t,{saveConfig:r});return yield this.base.createWorkspace(e)}))}restoreWorkspace(t,r){return e(this,void 0,void 0,(function*(){if(!(yield this.getLayoutSummaries()).some(e=>e.name===t))throw new Error(`This layout: ${t} cannot be restored, because it doesn't exist.`);if((null==r?void 0:r.frameId)&&!(yield this.bridge.send(Ne.getAllFramesSummaries.name)).summaries.some(e=>e.id===r.frameId))throw new Error(`Cannot reuse the frame with id: ${r.frameId}, because there is no frame with that ID found`);return yield this.base.restoreWorkspace(t,r)}))}add(t,r,n,i){return e(this,void 0,void 0,(function*(){return yield this.base.add(t,r,n,i)}))}processLocalSubscription(e,t){return e.levelId=e.levelId||t,this.bridge.subscribe(e)}processGlobalSubscription(e,t,r){const n={streamType:t,callback:e,action:r,level:"global"};return this.bridge.subscribe(n)}getFrame(t){return e(this,void 0,void 0,(function*(){if(t.windowId)return yield this.base.getFrame(t.windowId);if(t.predicate)return(yield this.getFrames(t.predicate))[0];throw new Error("The provided selector is not valid: "+JSON.stringify(t))}))}getFrames(t){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send(Ne.getAllFramesSummaries.name);return this.base.getFrames(e.summaries,t)}))}getWorkspace(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{t(r)&&(e=r,n())}),e}))}getWorkspaces(t){return e(this,void 0,void 0,(function*(){const e=[];return yield this.iterateWorkspaces(r=>{t&&!t(r)||e.push(r)}),e}))}getAllWorkspaceSummaries(){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send(Ne.getAllWorkspacesSummaries.name,{});return this.base.getAllWorkspaceSummaries(e)}))}getWindow(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{const i=r.getWindow(t);i&&(e=i,n())}),e}))}getParent(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{const i=r.getParent(t);i&&(e=i,n())}),e}))}getLayoutSummaries(){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send(Ne.getAllLayoutsSummaries.name)).summaries}))}deleteLayout(t){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.deleteLayout.name,{name:t})}))}exportLayout(t){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send(Ne.exportAllLayouts.name)).layouts.reduce((e,r)=>(t&&!t(r)||e.push(r),e),[])}))}saveLayout(t){return e(this,void 0,void 0,(function*(){return yield this.bridge.send(Ne.saveLayout.name,{name:t.name,workspaceId:t.workspaceId})}))}importLayout(t){return e(this,void 0,void 0,(function*(){yield Promise.all(t.map(e=>this.bridge.send(Ne.saveLayout.name,e)))}))}bundleTo(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.bundleTo(t,r)}))}restoreItem(t){return e(this,void 0,void 0,(function*(){return yield this.base.restoreItem(t)}))}maximizeItem(t){return e(this,void 0,void 0,(function*(){return yield this.base.maximizeItem(t)}))}focusItem(t){return e(this,void 0,void 0,(function*(){return yield this.base.focusItem(t)}))}closeItem(t){return e(this,void 0,void 0,(function*(){return yield this.base.closeItem(t)}))}resizeItem(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.resizeItem(t,r)}))}moveFrame(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.moveFrame(t,r)}))}getGDWindow(e){return this.base.getGDWindow(e)}forceLoadWindow(t){return e(this,void 0,void 0,(function*(){return yield this.base.forceLoadWindow(t)}))}ejectWindow(t){return e(this,void 0,void 0,(function*(){return yield this.base.ejectWindow(t)}))}moveWindowTo(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.moveWindowTo(t,r)}))}getSnapshot(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.getSnapshot(t,r)}))}setItemTitle(t,r){return e(this,void 0,void 0,(function*(){return yield this.base.setItemTitle(t,r)}))}refreshChildren(e){return this.base.refreshChildren(e)}iterateFindChild(e,t){return this.base.iterateFindChild(e,t)}iterateFilterChildren(e,t){return this.base.iterateFilterChildren(e,t)}iterateWorkspaces(t){return e(this,void 0,void 0,(function*(){let e=!1;const r=()=>{e=!0},n=yield this.getAllWorkspaceSummaries();for(const i of n){if(e)return;const n=yield this.base.fetchWorkspace(i.id);t(n,r)}}))}}class Ue{constructor(e,t){this.transport=e,this.registry=t,this.activeSubscriptions=[]}send(t,r,n){return e(this,void 0,void 0,(function*(){if(!window.glue42gd&&!n)throw new Error(`Cannot complete operation: ${t} with args: ${JSON.stringify(r)}, because the environment is Glue42 Core and no frame target was provided`);const e=Object.values(Ne).find(e=>e.name===t);if(!e)throw new Error("Cannot find definition for operation name: "+t);if(e.argsDecoder)try{e.argsDecoder.runWithException(r)}catch(e){throw new Error(`Unexpected internal outgoing validation error: ${e.message}, for input: ${JSON.stringify(e.input)}`)}let i;try{const t=yield this.transport.transmitControl(e.name,r,n);i=e.resultDecoder.runWithException(t)}catch(e){if(e.kind)throw console.log("Pre exception",t,r),new Error(`Unexpected internal incoming validation error: ${e.message}, for input: ${JSON.stringify(e.input)}`);throw new Error(e.message)}return i}))}subscribe(t){return e(this,void 0,void 0,(function*(){let e=this.getActiveSubscription(t);const r=this.getRegistryKey(t);if(!e){console.log("no active sub will subscribe",t);const r=Fe[t.streamType],n=yield this.transport.subscribe(r.name,this.getBranchKey(t),t.streamType);n.onData(e=>{console.log("received from stream",e);const t=e.data,r=V.run(e.requestArguments),n=X.run(t.action);if(!r.ok||!n.ok)return void console.log("the requested arguments weren't ok",e,r,n);const i=r.result.type,o=r.result.branch,s=Fe[i].payloadDecoder.run(t.payload);if(!s.ok)return void console.log("the payload wasn't ok",e,s);const a=`${i}-${o}-${n.result}`;console.log("will execute callback",a),this.registry.execute(a,s.result)}),e={streamType:t.streamType,level:t.level,levelId:t.levelId,callbacksCount:0,gdSub:n},this.activeSubscriptions.push(e)}const n=this.registry.add(r,t.callback);return++e.callbacksCount,()=>{n(),--e.callbacksCount,0===e.callbacksCount&&(e.gdSub.close(),this.activeSubscriptions.splice(this.activeSubscriptions.indexOf(e),1))}}))}getBranchKey(e){return"global"===e.level?e.level:`${e.level}_${e.levelId}`}getRegistryKey(e){return`${e.streamType}-${this.getBranchKey(e)}-${e.action}`}getActiveSubscription(e){return this.activeSubscriptions.find(t=>t.streamType===e.streamType&&t.level===e.level&&t.levelId===e.levelId)}}class ze{constructor(e){this.agm=e,this.defaultTransportTimeout=3e4}initiate(){return e(this,void 0,void 0,(function*(){window.glue42gd&&(yield Promise.all(Object.values(Re).map(e=>this.verifyMethodLive(e.name,e.isStream))))}))}subscribe(t,r,n){return e(this,void 0,void 0,(function*(){const e={branch:r,type:n};let i;try{i=yield this.agm.subscribe(t,{arguments:e})}catch(e){const n=`Internal subscription error! Error details: stream - ${t}, branch: ${r}. Internal message: ${e.message}`;throw new Error(n)}return i}))}transmitControl(t,r,n){return e(this,void 0,void 0,(function*(){if(!this.agm.methods().find(e=>e.name===Re.control.name))throw new Error(`Cannot complete operation: ${t}, because no control method was found`);const e={operation:t,operationArguments:r};let i;const o=`Internal Swimlane Communication Error. Attempted operation: ${JSON.stringify(e)}. `;try{if(i=yield this.agm.invoke(Re.control.name,e,n,{methodResponseTimeoutMs:this.defaultTransportTimeout}),!i)throw new Error("Received unsupported result from GD - empty result");if(!Array.isArray(i.all_return_values)||0===i.all_return_values.length)throw new Error("Received unsupported result from GD - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${o} -> Inner message: ${t}`)}throw new Error(`${o} -> Inner message: ${e.message}`)}return i.all_return_values[0].returned}))}verifyMethodLive(e,t){return r=()=>new Promise(r=>{if(this.agm.methods().find(r=>r.name===e&&r.supportsStreaming===t))return void r();let n=this.agm.methodAdded(i=>{i.name===e&&i.supportsStreaming===t&&(n?(n(),n=null):setTimeout(()=>{n&&n()},0),r())})}),n=15e3,i="Timeout waiting for the Swimlane communication channels",new Promise((e,t)=>{let o=!0;const s=setTimeout(()=>{o&&(o=!1,t(i||"Promise timeout hit: "+n))},n);r().then(t=>{o&&(o=!1,clearTimeout(s),e(t))}).catch(e=>{o&&(o=!1,clearTimeout(s),t(e))})});var r,n,i}}const Ge=new WeakMap;class qe{constructor(e,t){const r=t.wrapChildren(e.children);delete e.children,Ge.set(this,{base:t,children:r,definition:e})}get type(){return Ge.get(this).definition.type}addColumn(e){return Ge.get(this).base.add("column",Ge.get(this).children,e)}addRow(e){return Ge.get(this).base.add("row",Ge.get(this).children,e)}addGroup(e){return Ge.get(this).base.add("group",Ge.get(this).children,e)}addWindow(e){return Ge.get(this).base.addWindow(Ge.get(this).children,e),this}serialize(){const e=Ge.get(this).definition;return e.children=Ge.get(this).base.serializeChildren(Ge.get(this).children),e}}class He{constructor(e){this.getBuilder=e}wrapChildren(e){return e.map(e=>"window"===e.type?e:this.getBuilder({type:e.type,definition:e}))}add(e,t,r){const n=N.runWithException(r),i=this.getBuilder({type:e,definition:n});return t.push(i),i}addWindow(e,t){const r=F.runWithException(t);r.type="window",e.push(r)}serializeChildren(e){return e.map(e=>e instanceof qe?e.serialize():e)}}const Je=new WeakMap;class Ke{constructor(e,t,r){const n=t.wrapChildren(e.children);delete e.children,Je.set(this,{base:t,children:n,definition:e,controller:r})}addColumn(e){const t=Je.get(this).children;if(!t.every(e=>e instanceof qe&&"column"===e.type))throw new Error("Cannot add a column to this workspace, because there are already children of another type");return Je.get(this).base.add("column",t,e)}addRow(e){const t=Je.get(this).children;if(!t.every(e=>e instanceof qe&&"row"===e.type))throw new Error("Cannot add a row to this workspace, because there are already children of another type");return Je.get(this).base.add("row",t,e)}addGroup(e){const t=Je.get(this).children;if(0!==t.length)throw new Error("Cannot add a group to this workspace, because there are already defined children.");return Je.get(this).base.add("group",t,e)}addWindow(e){const t=Je.get(this).children;if(0!==t.length)throw new Error("Cannot add a window to this workspace, because there are already defined children.");return Je.get(this).base.addWindow(t,e),this}getChildAt(e){return A.runWithException(e),Je.get(this).children[e]}create(t){return e(this,void 0,void 0,(function*(){const e=O.runWithException(t),r=Je.get(this).definition;return r.children=Je.get(this).base.serializeChildren(Je.get(this).children),Je.get(this).controller.createWorkspace(r,e)}))}}const $e=new WeakMap,Ye=e=>$e.get(e).base;class Ve{constructor(e){$e.set(this,{base:e})}get type(){return"row"}get id(){return Ye(this).getId(this)}get frameId(){return Ye(this).getFrameId(this)}get workspaceId(){return Ye(this).getWorkspaceId(this)}get positionIndex(){return Ye(this).getPositionIndex(this)}get children(){return Ye(this).getAllChildren(this)}get parent(){return Ye(this).getMyParent(this)}get frame(){return Ye(this).getMyFrame(this)}get workspace(){return Ye(this).getMyWorkspace(this)}getChild(e){return Ye(this).getChild(this,e)}addWindow(e){return Ye(this).addWindow(this,e,"row")}addGroup(t){return e(this,void 0,void 0,(function*(){if((null==t?void 0:t.type)&&"group"!==t.type)throw new Error("Expected a group definition, but received "+t.type);return Ye(this).addParent(this,"group","row",t)}))}addColumn(t){return e(this,void 0,void 0,(function*(){if((null==t?void 0:t.type)&&"column"!==t.type)throw new Error("Expected a column definition, but received "+t.type);return Ye(this).addParent(this,"column","row",t)}))}addRow(){return e(this,void 0,void 0,(function*(){throw new Error("Adding rows as row children is not supported")}))}removeChild(e){return console.log("in row close will remove child"),Ye(this).removeChild(this,e)}maximize(){return Ye(this).maximize(this)}restore(){return Ye(this).restore(this)}close(){return Ye(this).close(this)}}const Xe=new WeakMap,Ze=e=>Xe.get(e).base;class Qe{constructor(e){Xe.set(this,{base:e})}get type(){return"column"}get id(){return Ze(this).getId(this)}get frameId(){return Ze(this).getFrameId(this)}get workspaceId(){return Ze(this).getWorkspaceId(this)}get positionIndex(){return Ze(this).getPositionIndex(this)}get children(){return Ze(this).getAllChildren(this)}get parent(){return Ze(this).getMyParent(this)}get frame(){return Ze(this).getMyFrame(this)}get workspace(){return Ze(this).getMyWorkspace(this)}getChild(e){return Ze(this).getChild(this,e)}addWindow(e){return Ze(this).addWindow(this,e,"column")}addGroup(t){return e(this,void 0,void 0,(function*(){if((null==t?void 0:t.type)&&"group"!==t.type)throw new Error("Expected a group definition, but received "+t.type);return Ze(this).addParent(this,"group","column",t)}))}addColumn(t){return e(this,void 0,void 0,(function*(){throw new Error("Adding columns as column children is not supported")}))}addRow(t){return e(this,void 0,void 0,(function*(){if((null==t?void 0:t.type)&&"row"!==t.type)throw new Error("Expected a row definition, but received "+t.type);return Ze(this).addParent(this,"row","column",t)}))}removeChild(e){return Ze(this).removeChild(this,e)}maximize(){return Ze(this).maximize(this)}restore(){return Ze(this).restore(this)}close(){return Ze(this).close(this)}}const et=new WeakMap,tt=e=>et.get(e).base;class rt{constructor(e){et.set(this,{base:e})}get type(){return"group"}get id(){return tt(this).getId(this)}get frameId(){return tt(this).getFrameId(this)}get workspaceId(){return tt(this).getWorkspaceId(this)}get positionIndex(){return tt(this).getPositionIndex(this)}get children(){return tt(this).getAllChildren(this)}get parent(){return tt(this).getMyParent(this)}get frame(){return tt(this).getMyFrame(this)}get workspace(){return tt(this).getMyWorkspace(this)}getChild(e){return tt(this).getChild(this,e)}addWindow(e){return tt(this).addWindow(this,e,"group")}addGroup(){return e(this,void 0,void 0,(function*(){throw new Error("Adding groups as group child is not supported")}))}addColumn(){return e(this,void 0,void 0,(function*(){throw new Error("Adding columns as group child is not supported")}))}addRow(){return e(this,void 0,void 0,(function*(){throw new Error("Adding rows as group child is not supported")}))}removeChild(e){return tt(this).removeChild(this,e)}maximize(){return tt(this).maximize(this)}restore(){return tt(this).restore(this)}close(){return tt(this).close(this)}}const nt=new WeakMap,it=e=>nt.get(e).manager.getWorkspaceData(e),ot=e=>nt.get(e).manager;class st{constructor(e){nt.set(this,{manager:e})}get id(){return it(this).id}get frameId(){return it(this).config.frameId}get positionIndex(){return it(this).config.positionIndex}get title(){return it(this).config.title}get children(){return it(this).children}get frame(){return it(this).frame}removeChild(t){return e(this,void 0,void 0,(function*(){j(t);const e=this.getChild(t);e&&(yield e.close(),yield this.refreshReference())}))}remove(t){return e(this,void 0,void 0,(function*(){j(t);const e=it(this).controller.iterateFindChild(this.children,t);yield e.close(),yield this.refreshReference()}))}focus(){return e(this,void 0,void 0,(function*(){yield it(this).controller.focusItem(this.id),yield this.refreshReference()}))}close(){return e(this,void 0,void 0,(function*(){const e=it(this).controller,t=1===(yield it(this).frame.workspaces()).length;yield e.closeItem(this.id),t&&(yield it(this).frame.close())}))}snapshot(){return it(this).controller.getSnapshot(this.id,"workspace")}saveLayout(t){return e(this,void 0,void 0,(function*(){M.runWithException(t),yield it(this).controller.saveLayout({name:t,workspaceId:this.id})}))}setTitle(t){return e(this,void 0,void 0,(function*(){M.runWithException(t);const e=it(this).controller;yield e.setItemTitle(this.id,t),yield this.refreshReference()}))}refreshReference(){return e(this,void 0,void 0,(function*(){const e=yield it(this).controller.getSnapshot(this.id,"workspace");console.log("new workspace snapshot",e);const t=e.children.reduce((e,t)=>{let r;return r="window"===t.type?this.getWindow(e=>e.id===t.id):this.getParent(e=>e.id===t.id),r&&e.push(r),e},[]),r=it(this).controller.refreshChildren({existingChildren:t,workspace:this,parent:this,children:e.children}),n=this.frame;let i;if(n.id===e.config.frameId)ot(this).remapFrame(n,e.frameSummary),i=n;else{const t={summary:e.frameSummary};i=it(this).ioc.getModel("frame",t)}ot(this).remapWorkspace(this,{config:e.config,children:r,frame:i})}))}getChild(e){return j(e),it(this).children.find(e)}getParent(e){j(e);const t=it(this).children;return it(this).controller.iterateFindChild(t,t=>"window"!==t.type&&e(t))}getAllParents(e){j(e,!0);const t=it(this).children,r=it(this).controller.iterateFilterChildren(t,e=>"window"!==e.type);return e?r.filter(e):r}getRow(e){return j(e),this.getParent(t=>"row"===t.type&&e(t))}getAllRows(e){return j(e,!0),e?this.getAllParents(t=>"row"===t.type&&e(t)):this.getAllParents(e=>"row"===e.type)}getColumn(e){return j(e),this.getParent(t=>"column"===t.type&&e(t))}getAllColumns(e){return j(e,!0),e?this.getAllParents(t=>"column"===t.type&&e(t)):this.getAllParents(e=>"column"===e.type)}getGroup(e){return j(e),this.getParent(t=>"group"===t.type&&e(t))}getAllGroups(e){return j(e,!0),e?this.getAllParents(t=>"group"===t.type&&e(t)):this.getAllParents(e=>"group"===e.type)}getWindow(e){j(e);const t=it(this).children;return it(this).controller.iterateFindChild(t,t=>"window"===t.type&&e(t))}getAllWindows(e){j(e,!0);const t=it(this).children,r=it(this).controller.iterateFilterChildren(t,e=>"window"===e.type);return e?r.filter(e):r}addRow(e){return it(this).base.addParent(this,"row","workspace",e)}addColumn(e){return it(this).base.addParent(this,"column","workspace",e)}addGroup(e){return it(this).base.addParent(this,"group","workspace",e)}addWindow(e){return it(this).base.addWindow(this,e,"workspace")}bundleToRow(){return e(this,void 0,void 0,(function*(){yield it(this).controller.bundleTo("row",this.id),yield this.refreshReference()}))}bundleToColumn(){return e(this,void 0,void 0,(function*(){yield it(this).controller.bundleTo("column",this.id),yield this.refreshReference()}))}onClosing(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"closing",streamType:"workspace",level:"workspace",levelId:r,callback:()=>e(this,void 0,void 0,(function*(){yield this.refreshReference(),t()}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onClosed(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"closed",streamType:"workspace",level:"workspace",levelId:r,callback:()=>e(this,void 0,void 0,(function*(){t()}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onFocusChange(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"focus",streamType:"workspace",level:"workspace",levelId:r,callback:()=>e(this,void 0,void 0,(function*(){yield this.refreshReference(),t()}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onWindowAdded(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"added",streamType:"window",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference();const e=this.getParent(e=>e.id===r.windowSummary.parentId);console.log("workspace window added payload",r);const n=e.getChild(e=>(console.log("checking child",e),"window"===e.type&&e.positionIndex===r.windowSummary.config.positionIndex));t(n)}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onWindowRemoved(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"removed",streamType:"window",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference();const{windowId:e,workspaceId:n,frameId:i}=r.windowSummary.config;t({windowId:e,workspaceId:n,frameId:i})}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onWindowLoaded(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"loaded",streamType:"window",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference(),console.log("payload for window loaded",r);const e=this.getWindow(e=>(console.log("Window checked",e),e.id&&e.id===r.windowSummary.config.windowId));console.log("found window",e),t(e)}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onWindowFocusChange(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"focus",streamType:"window",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){this.refreshReference();const e=this.getWindow(e=>e.id&&e.id===r.windowSummary.config.windowId);t(e)}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onParentAdded(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"added",streamType:"container",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference();const e=this.getParent(e=>e.id===r.containerSummary.itemId);t(e)}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onParentRemoved(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"removed",streamType:"container",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference();const{workspaceId:e,frameId:n}=r.containerSummary.config;t({id:r.containerSummary.itemId,workspaceId:e,frameId:n})}))};return yield it(this).controller.processLocalSubscription(n,r)}))}onParentUpdated(t){return e(this,void 0,void 0,(function*(){j(t);const r=it(this).id,n={action:"childrenUpdate",streamType:"container",level:"workspace",levelId:r,callback:r=>e(this,void 0,void 0,(function*(){yield this.refreshReference();const e=this.getParent(e=>e.id===r.containerSummary.itemId);t(e)}))};return yield it(this).controller.processLocalSubscription(n,r)}))}}const at=new WeakMap,ct=e=>at.get(e).manager.getWindowData(e);class ut{constructor(e){at.set(this,{manager:e}),console.log("private data for window",ct(this))}get id(){return ct(this).config.windowId}get type(){return"window"}get frameId(){return ct(this).frame.id}get workspaceId(){return ct(this).workspace.id}get positionIndex(){return ct(this).config.positionIndex}get isMaximized(){return ct(this).config.isMaximized}get isLoaded(){return ct(this).config.isLoaded}get focused(){return ct(this).config.isFocused}get title(){return ct(this).config.title}get workspace(){return ct(this).workspace}get frame(){return ct(this).frame}get parent(){return ct(this).parent}forceLoad(){return e(this,void 0,void 0,(function*(){if(this.isLoaded)return;const e=ct(this).controller,t=ct(this).id,r=yield e.forceLoadWindow(t);console.log("Private data for window",r),ct(this).config.windowId=r,ct(this).config.isLoaded=!0}))}focus(){return e(this,void 0,void 0,(function*(){const e=ct(this).id,t=ct(this).controller;yield t.focusItem(e)}))}close(){return e(this,void 0,void 0,(function*(){const e=ct(this).id,t=ct(this).controller;yield t.closeItem(e),yield ct(this).parent.removeChild(t=>t.id===e)}))}setTitle(t){return e(this,void 0,void 0,(function*(){M.runWithException(t);const e=ct(this).id,r=ct(this).controller;yield r.setItemTitle(e,t)}))}maximize(){return e(this,void 0,void 0,(function*(){const e=ct(this).id,t=ct(this).controller;yield t.maximizeItem(e)}))}restore(){return e(this,void 0,void 0,(function*(){const e=ct(this).id,t=ct(this).controller;yield t.restoreItem(e)}))}eject(){return e(this,void 0,void 0,(function*(){if(!this.isLoaded)throw new Error("Cannot eject this window, because it is not loaded yet");const e=ct(this).id;return yield ct(this).controller.ejectWindow(e),this.getGdWindow()}))}getGdWindow(){if(!this.isLoaded)throw new Error("Cannot fetch this GD window, because the window is not yet loaded");const e=ct(this).config.windowId;return ct(this).controller.getGDWindow(e)}moveTo(t){return e(this,void 0,void 0,(function*(){if(!(t instanceof Ve||t instanceof Qe||t instanceof rt))throw new Error("Cannot add to the provided parent, because the provided parent is not an instance of Row, Column or Group");const e=ct(this).id,r=ct(this).controller;if(!(yield r.getParent(e=>e.id===t.id)))throw new Error("Cannot move the window to the selected parent, because this parent does not exist.");return r.moveWindowTo(e,t.id)}))}onAdded(t){return e(this,void 0,void 0,(function*(){j(t);const r=ct(this).id,n={callback:()=>e(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),t()})),action:"added",streamType:"window",level:"window"};return yield ct(this).controller.processLocalSubscription(n,r)}))}onLoaded(t){return e(this,void 0,void 0,(function*(){j(t);const r=ct(this).id,n={callback:()=>e(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),t()})),action:"loaded",streamType:"window",level:"window"};return yield ct(this).controller.processLocalSubscription(n,r)}))}onParentChanged(t){return e(this,void 0,void 0,(function*(){j(t);const r=ct(this).id,n={callback:()=>e(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),t(this.parent)})),action:"containerChange",streamType:"window",level:"window"};return yield ct(this).controller.processLocalSubscription(n,r)}))}onRemoved(t){return e(this,void 0,void 0,(function*(){j(t);const r=ct(this).id,n={callback:()=>e(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),t()})),action:"removed",streamType:"window",level:"window"};return yield ct(this).controller.processLocalSubscription(n,r)}))}}const dt=new WeakMap,lt=e=>dt.get(e).manager.getFrameData(e),ht=e=>dt.get(e).manager;class pt{constructor(e){dt.set(this,{manager:e})}get id(){return lt(this).summary.id}resize(e){const t=be.runWithException(e),r=lt(this).summary.id;return lt(this).controller.resizeItem(r,t)}move(e){const t=Ie.runWithException(e),r=lt(this).summary.id;return lt(this).controller.moveFrame(r,t)}focus(){const e=lt(this).summary.id;return lt(this).controller.focusItem(e)}close(){const e=lt(this).summary.id;return lt(this).controller.closeItem(e)}snapshot(){const e=lt(this).summary.id;return lt(this).controller.getSnapshot(e,"frame")}workspaces(){return e(this,void 0,void 0,(function*(){return lt(this).controller.getWorkspaces(e=>e.frameId===this.id)}))}restoreWorkspace(t,r){return e(this,void 0,void 0,(function*(){M.runWithException(t);const e=G.runWithException(r);return lt(this).controller.restoreWorkspace(t,e)}))}createWorkspace(e,t){const r=H.runWithException(e),n=O.runWithException(t);return lt(this).controller.createWorkspace(r,n)}onClosing(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{ht(this).remapFrame(this,e.frameSummary),t(this)},action:"closing",streamType:"frame",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onClosed(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{t({frameId:e.frameSummary.id})},action:"closed",streamType:"frame",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onFocusChange(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{ht(this).remapFrame(this,e.frameSummary),t(this)},action:"focus",streamType:"frame",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onWorkspaceOpened(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=yield lt(this).controller.getWorkspace(e=>e.id===r.workspaceSummary.id);t(e)})),action:"added",streamType:"workspace",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onWorkspaceFocusChange(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=yield lt(this).controller.getWorkspace(e=>e.id===r.workspaceSummary.id);t(e)})),action:"focus",streamType:"workspace",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onWorkspaceClosing(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=yield lt(this).controller.getWorkspace(e=>e.id===r.workspaceSummary.id);t(e)})),action:"focus",streamType:"workspace",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onWorkspaceClosed(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{console.log("workspace closed callback invoked"),t({frameId:e.frameSummary.id,workspaceId:e.workspaceSummary.id})},action:"closed",streamType:"workspace",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onWindowAdded(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=(yield lt(this).controller.getParent(e=>e.id===r.windowSummary.parentId)).getChild(e=>"window"===e.type&&e.positionIndex===r.windowSummary.config.positionIndex);t(e)})),action:"added",streamType:"window",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onWindowRemoved(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{const{windowId:r,workspaceId:n,frameId:i}=e.windowSummary.config;t({windowId:r,workspaceId:n,frameId:i})},action:"removed",streamType:"window",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onWindowLoaded(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=(yield lt(this).controller.getParent(e=>(console.log("Parent checked",e),e.id===r.windowSummary.parentId))).getChild(e=>"window"===e.type&&e.positionIndex===r.windowSummary.config.positionIndex);t(e)})),action:"loaded",streamType:"window",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onWindowFocusChange(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=(yield lt(this).controller.getParent(e=>e.id===r.windowSummary.parentId)).getChild(e=>"window"===e.type&&e.positionIndex===r.windowSummary.config.positionIndex);t(e)})),action:"focus",streamType:"window",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onParentAdded(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=yield lt(this).controller.getParent(e=>e.id===r.containerSummary.itemId);t(e)})),action:"added",streamType:"container",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}onParentRemoved(t){return e(this,void 0,void 0,(function*(){j(t);const e=lt(this).summary.id,r={callback:e=>{const{workspaceId:r,frameId:n}=e.containerSummary.config;t({id:e.containerSummary.itemId,workspaceId:r,frameId:n})},action:"removed",streamType:"container",level:"frame"};return yield lt(this).controller.processLocalSubscription(r,e)}))}onParentUpdated(t){return e(this,void 0,void 0,(function*(){j(t);const r=lt(this).summary.id,n={callback:r=>e(this,void 0,void 0,(function*(){const e=yield lt(this).controller.getParent(e=>e.id===r.containerSummary.itemId);t(e)})),action:"childrenUpdate",streamType:"container",level:"frame"};return yield lt(this).controller.processLocalSubscription(n,r)}))}}class ft{constructor(){this.parentsData=new WeakMap,this.workspacesData=new WeakMap,this.windowsData=new WeakMap,this.framesData=new WeakMap,this.windowPlacementIdData={}}deleteData(e){if(e instanceof ut){const t=Object.keys(this.windowPlacementIdData).find(t=>this.windowPlacementIdData[t]===e);t&&delete this.windowPlacementIdData[t],this.windowsData.delete(e)}e instanceof st&&this.workspacesData.delete(e),(e instanceof Ve||e instanceof Qe||e instanceof rt)&&this.parentsData.delete(e),e instanceof pt&&this.framesData.delete(e)}setWindowData(e,t){console.log("setting window data",t),this.windowPlacementIdData[t.id]=e,this.windowsData.set(e,t)}setWorkspaceData(e,t){this.workspacesData.set(e,t)}setParentData(e,t){this.parentsData.set(e,t)}setFrameData(e,t){this.framesData.set(e,t)}getWindowData(e){return this.windowsData.get(e)}getWindowByPlacementId(e){return this.windowPlacementIdData[e]}getWorkspaceData(e){return this.workspacesData.get(e)}getParentData(e){return this.parentsData.get(e)}getFrameData(e){return this.framesData.get(e)}remapChild(e,t){if(e instanceof ut){const r=this.windowsData.get(e);r.parent=t.parent||r.parent,r.config=t.config||r.config}if(e instanceof Ve||e instanceof Qe||e instanceof rt){const r=this.parentsData.get(e);r.parent=t.parent||r.parent,r.config=t.config||r.config,r.children=t.children||r.children}}remapFrame(e,t){this.framesData.get(e).summary=t}remapWorkspace(e,t){const r=this.workspacesData.get(e);r.frame=t.frame||r.frame,r.config=t.config||r.config,r.children=t.children||r.children}}const mt=new WeakMap,gt=(e,t)=>{const r=mt.get(e).manager;return t instanceof st?r.getWorkspaceData(t):mt.get(e).manager.getParentData(t)},vt=(e,t)=>mt.get(e).manager.getWindowByPlacementId(t);class yt{constructor(e){mt.set(this,{manager:e})}getId(e){return gt(this,e).id}getPositionIndex(e){return gt(this,e).config.positionIndex}getWorkspaceId(e){const t=gt(this,e);return t.config.workspaceId||t.workspace.id}getFrameId(e){return gt(this,e).frame.id}getChild(e,t){return j(t),gt(this,e).children.find(t)}getAllChildren(e,t){j(t,!0);const r=gt(this,e).children;return void 0===t?r:r.filter(t)}getMyParent(e){if(!(e instanceof st))return gt(this,e).parent}getMyFrame(e){return gt(this,e).frame}getMyWorkspace(e){if(!(e instanceof st))return gt(this,e).workspace}addWindow(t,r,n){return e(this,void 0,void 0,(function*(){if(!r.appName&&!r.windowId)throw new Error("The window definition should contain either an appName or a windowId");const e=F.runWithException(r),i=gt(this,t).controller,o=yield i.add("window",gt(this,t).id,n,e);return console.log("add window operation reuslt",o),t instanceof st?(yield t.refreshReference(),vt(this,o.itemId)):(yield this.getMyWorkspace(t).refreshReference(),vt(this,o.itemId))}))}addParent(t,r,n,i){return e(this,void 0,void 0,(function*(){const e=this.transformDefinition(r,i),o=gt(this,t).controller,s=(yield o.add("container",gt(this,t).id,n,e)).itemId;if(t instanceof st)return yield t.refreshReference(),t.getParent(e=>e.id===s);const a=this.getMyWorkspace(t);return yield a.refreshReference(),a.getParent(e=>e.id===s)}))}removeChild(t,r){return e(this,void 0,void 0,(function*(){j(r);const e=this.getChild(t,r);if(e){if(console.log("will close child"),yield e.close(),t instanceof st)return console.log("will get reference 1",t.children),yield t.refreshReference(),void console.log("allchildren",t.children);console.log("will get reference",t.children),yield this.getMyWorkspace(t).refreshReference(),console.log("allchildren",t.children)}}))}maximize(t){return e(this,void 0,void 0,(function*(){const e=gt(this,t).controller;yield e.maximizeItem(gt(this,t).id)}))}restore(t){return e(this,void 0,void 0,(function*(){const e=gt(this,t).controller;yield e.restoreItem(gt(this,t).id)}))}close(t){return e(this,void 0,void 0,(function*(){const e=gt(this,t),r=gt(this,t).controller;yield r.closeItem(e.id),e.parent instanceof st?(yield e.parent.refreshReference(),console.log("workspace reference refreshed",e.parent.children)):(yield this.getMyWorkspace(e.parent).refreshReference(),console.log(" reference refreshed",e.parent.children))}))}transformDefinition(e,t){let r;return void 0===t?r={type:e,children:[]}:t instanceof qe?r=t.serialize():(void 0===t.type&&(t.type=e),r=B.runWithException(t),r.children=r.children||[]),r}}class wt{constructor(e,t,r,n){this.bridge=e,this.frameUtils=t,this.layouts=r,this.base=n}checkIsInSwimlane(t){return e(this,void 0,void 0,(function*(){const e=this.frameUtils.getAllFrameInstances();return!!e.length&&(yield Promise.all(e.map(e=>this.bridge.send(Ne.isWindowInWorkspace.name,{itemId:t},e)))).some(e=>e.inWorkspace)}))}createWorkspace(t,r){var n,i;return e(this,void 0,void 0,(function*(){const e=Object.assign({},t,{saveConfig:r}),o={frameId:null===(n=t.frame)||void 0===n?void 0:n.reuseFrameId,newFrame:null===(i=t.frame)||void 0===i?void 0:i.newFrame},s=yield this.frameUtils.getFrameInstance(o);return yield this.base.createWorkspace(e,s)}))}restoreWorkspace(t,r){return e(this,void 0,void 0,(function*(){if(!(yield this.getLayoutSummaries()).some(e=>e.name===t))throw new Error(`This layout: ${t} cannot be restored, because it doesn't exist.`);const e=yield this.frameUtils.getFrameInstance({frameId:null==r?void 0:r.frameId,newFrame:null==r?void 0:r.newFrame});return yield this.base.restoreWorkspace(t,r,e)}))}add(t,r,n,i){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(r);return yield this.base.add(t,r,n,i,e)}))}processLocalSubscription(){return e(this,void 0,void 0,(function*(){throw new Error("Workspaces events are not supported in Glue42 Core.")}))}processGlobalSubscription(){return e(this,void 0,void 0,(function*(){throw new Error("Workspaces events are not supported in Glue42 Core.")}))}getFrame(t){return e(this,void 0,void 0,(function*(){if(t.windowId){const e=yield this.frameUtils.getFrameInstanceByItemId(t.windowId);return yield this.base.getFrame(t.windowId,e)}if(t.predicate)return(yield this.getFrames(t.predicate))[0];throw new Error("The provided selector is not valid: "+JSON.stringify(t))}))}getFrames(t){return e(this,void 0,void 0,(function*(){const e=this.frameUtils.getAllFrameInstances(),r=yield Promise.all(e.map(e=>this.bridge.send(Ne.getFrameSummary.name,{itemId:e.peerId},e)));return this.base.getFrames(r,t)}))}getWorkspace(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{t(r)&&(e=r,n())}),e}))}getWorkspaces(t){return e(this,void 0,void 0,(function*(){const e=[];return yield this.iterateWorkspaces(r=>{t&&!t(r)||e.push(r)}),e}))}getAllWorkspaceSummaries(){return e(this,void 0,void 0,(function*(){const e=this.frameUtils.getAllFrameInstances(),t=yield Promise.all(e.map(e=>this.bridge.send(Ne.getAllWorkspacesSummaries.name,{},e)));return this.base.getAllWorkspaceSummaries(...t)}))}getWindow(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{const i=r.getWindow(t);i&&(e=i,n())}),e}))}getParent(t){return e(this,void 0,void 0,(function*(){let e;return yield this.iterateWorkspaces((r,n)=>{const i=r.getParent(t);i&&(e=i,n())}),e}))}getLayoutSummaries(){return e(this,void 0,void 0,(function*(){return(yield this.layouts.getAll("Workspace")).map(e=>({name:e.name}))}))}deleteLayout(t){return e(this,void 0,void 0,(function*(){yield this.layouts.remove("Workspace",t)}))}exportLayout(t){return e(this,void 0,void 0,(function*(){return(yield this.layouts.export("Workspace")).reduce((e,r)=>(t&&!t(r)||e.push(r),e),[])}))}importLayout(t){return e(this,void 0,void 0,(function*(){yield this.layouts.import(t)}))}saveLayout(t){return e(this,void 0,void 0,(function*(){if(!this.frameUtils.getAllFrameInstances().length)throw new Error(`Cannot save the layout with config: ${JSON.stringify(t)}, because no active frames were found`);const e=yield this.frameUtils.getFrameInstanceByItemId(t.workspaceId);return yield this.bridge.send(Ne.saveLayout.name,{name:t.name,workspaceId:t.workspaceId},e)}))}bundleTo(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(r);return yield this.base.bundleTo(t,r,e)}))}restoreItem(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);yield this.base.restoreItem(t,e)}))}maximizeItem(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);yield this.base.maximizeItem(t,e)}))}focusItem(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);yield this.base.focusItem(t,e)}))}closeItem(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t),r=t===e.peerId;yield this.base.closeItem(t,e),r&&(yield this.frameUtils.closeFrame(e))}))}resizeItem(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);yield this.base.resizeItem(t,r,e),yield this.frameUtils.resizeFrame(t,r)}))}moveFrame(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);yield this.base.moveFrame(t,r,e),yield this.frameUtils.moveFrame(t,r)}))}getGDWindow(e){return this.base.getGDWindow(e)}forceLoadWindow(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.forceLoadWindow(t,e)}))}ejectWindow(t){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.ejectWindow(t,e)}))}moveWindowTo(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.moveWindowTo(t,r,e)}))}getSnapshot(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.getSnapshot(t,r,e)}))}setItemTitle(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.setItemTitle(t,r,e)}))}refreshChildren(e){return this.base.refreshChildren(e)}iterateFindChild(e,t){return this.base.iterateFindChild(e,t)}iterateFilterChildren(e,t){return this.base.iterateFilterChildren(e,t)}iterateWorkspaces(t){return e(this,void 0,void 0,(function*(){let e=!1;const r=()=>{e=!0},n=yield this.getAllWorkspaceSummaries();for(const i of n){if(e)return;const n=yield this.frameUtils.getFrameInstance({frameId:i.frameId}),o=yield this.base.fetchWorkspace(i.id,n);t(o,r)}}))}}class bt{constructor(e,t,r){this.interop=e,this.windows=t,this.bridge=r,this.workspacesRoute="/glue/workspaces/",this.defaultWidth=1280,this.defaultHeight=720}getAllFrameInstances(){return this.interop.servers().filter(e=>{var t;if(null==e?void 0:e.getMethods)return null===(t=e.getMethods())||void 0===t?void 0:t.some(e=>e.name===Re.control.name)})}getFrameInstance(t){return e(this,void 0,void 0,(function*(){if((null==t?void 0:t.frameId)&&(null==t?void 0:t.newFrame))throw new Error("Cannot retrieve the frame, because of over-specification: both frameId and newFrame were provided.");const e=this.getAllFrameInstances();if(null==t?void 0:t.frameId){const r=e.find(e=>e.peerId===t.frameId);if(!r)throw new Error(`Frame with id: ${t.frameId} was not found`);return r}return(null==t?void 0:t.newFrame)?this.openNewWorkspacesFrame(t.newFrame):e.length?this.getLastFrameInteropInstance():this.openNewWorkspacesFrame()}))}getFrameInstanceByItemId(t){return e(this,void 0,void 0,(function*(){const e=this.getAllFrameInstances(),r=(yield Promise.all(e.map(e=>this.bridge.send(Ne.getFrameSummary.name,{itemId:t},e)))).find(e=>"none"!==e.id);if(!r)throw new Error("Cannot find frame for item: "+t);return yield this.getFrameInstance({frameId:r.id})}))}getLastFrameInteropInstance(){return this.getAllFrameInstances().sort((e,t)=>{const r=(null==e?void 0:e.peerId)?+e.peerId.slice(e.peerId.lastIndexOf("-")+1):0;return((null==t?void 0:t.peerId)?+t.peerId.slice(t.peerId.lastIndexOf("-")+1):0)-r})[0]}openNewWorkspacesFrame(e){return new Promise((t,r)=>{var n,i;const o=this.getAllFrameInstances().length;let s;const a=this.interop.serverMethodAdded(e=>{if(!(null==e?void 0:e.server)||!(null==e?void 0:e.method))return;const r=e.method.name===Re.control.name,n=e.server.windowId===(null==s?void 0:s.id);(null==s?void 0:s.id)&&r&&n&&(a(),t(e.server))}),c={url:this.workspacesRoute+"?emptyFrame=true",width:"object"==typeof e&&(null===(n=e.bounds)||void 0===n?void 0:n.width)||this.defaultWidth,height:"object"==typeof e&&(null===(i=e.bounds)||void 0===i?void 0:i.height)||this.defaultHeight};this.windows.open("frame_"+(o+1),c.url,c).then(e=>{s=e;const r=this.interop.servers().find(e=>{const t=e.windowId===s.id,r=e.getMethods().some(e=>e.name===Re.control.name);return t&&r});r&&(a(),t(r))}).catch(r)})}closeFrame(t){return e(this,void 0,void 0,(function*(){const e=this.windows.list().find(e=>e.id===t.windowId);yield e.close()}))}moveFrame(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.getFrameInstanceByItemId(t);if(t!==e.peerId)return;const n=this.windows.list().find(t=>t.id===e.windowId);r.relative?yield n.moveTo(r.top,r.left):yield n.moveResize({top:r.top,left:r.left})}))}resizeFrame(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.getFrameInstanceByItemId(t);if(t!==e.peerId)return;const n=this.windows.list().find(t=>t.id===e.windowId);r.relative?yield n.resizeTo(r.width,r.height):yield n.moveResize({width:r.width,height:r.height})}))}}class It{constructor(e,t){this.ioc=e,this.windows=t}get bridge(){return this.ioc.bridge}get privateDataManager(){return this.ioc.privateDataManager}createWorkspace(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send(Ne.createWorkspace.name,t,r),n={summary:e.frameSummary},i={frame:this.ioc.getModel("frame",n),snapshot:e};return this.ioc.getModel("workspace",i)}))}restoreWorkspace(t,r,n){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send(Ne.openWorkspace.name,{name:t,restoreOptions:r},n),i={summary:yield this.bridge.send(Ne.getFrameSummary.name,{itemId:e.config.frameId},n)},o={frame:this.ioc.getModel("frame",i),snapshot:e};return this.ioc.getModel("workspace",o)}))}add(t,r,n,i,o){return e(this,void 0,void 0,(function*(){let e;const s={definition:i,parentId:r,parentType:n};if("window"===t)e=Ne.addWindow.name;else{if("container"!==t)throw new Error("Unrecognized add type: "+t);e=Ne.addContainer.name}return yield this.bridge.send(e,s,o)}))}getFrame(t,r){return e(this,void 0,void 0,(function*(){const e={summary:yield this.bridge.send(Ne.getFrameSummary.name,{itemId:t},r)};return this.ioc.getModel("frame",e)}))}getFrames(e,t){return e.reduce((e,r)=>{const n={summary:r},i=this.ioc.getModel("frame",n);return t&&!t(i)||e.push(i),e},[])}getAllWorkspaceSummaries(...e){return e.reduce((e,t)=>(e.push(...t.summaries),e),[]).map(e=>({id:e.id,frameId:e.config.frameId,positionIndex:e.config.positionIndex,title:e.config.title}))}fetchWorkspace(t,r){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send(Ne.getWorkspaceSnapshot.name,{itemId:t},r),n={summary:e.frameSummary},i={frame:this.ioc.getModel("frame",n),snapshot:e};return this.ioc.getModel("workspace",i)}))}bundleTo(t,r,n){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.bundleWorkspace.name,{type:t,workspaceId:r},n)}))}restoreItem(t,r){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.restoreItem.name,{itemId:t},r)}))}maximizeItem(t,r){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.maximizeItem.name,{itemId:t},r)}))}focusItem(t,r){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.focusItem.name,{itemId:t},r)}))}closeItem(t,r){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.closeItem.name,{itemId:t},r)}))}resizeItem(t,r,n){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.resizeItem.name,Object.assign({},{itemId:t},r),n)}))}moveFrame(t,r,n){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.moveFrame.name,Object.assign({},{itemId:t},r),n)}))}getGDWindow(e){return this.windows.list().find(t=>t.id===e)}forceLoadWindow(t,r){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send(Ne.forceLoadWindow.name,{itemId:t},r)).windowId}))}ejectWindow(t,r){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.ejectWindow.name,{itemId:t},r)}))}moveWindowTo(t,r,n){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.moveWindowTo.name,{itemId:t,containerId:r},n)}))}getSnapshot(t,r,n){return e(this,void 0,void 0,(function*(){let e;return"workspace"===r?e=yield this.bridge.send(Ne.getWorkspaceSnapshot.name,{itemId:t},n):"frame"===r&&(e=yield this.bridge.send(Ne.getFrameSnapshot.name,{itemId:t},n)),e}))}setItemTitle(t,r,n){return e(this,void 0,void 0,(function*(){yield this.bridge.send(Ne.setItemTitle.name,{itemId:t,title:r},n)}))}refreshChildren(e){const{parent:t,children:r,existingChildren:n,workspace:i}=e;if(t instanceof ut)return;const o=r.map(e=>{let r=n.find(t=>t.id===e.id);const o=e.type;if(r)this.privateDataManager.remapChild(r,{parent:t,children:[],config:e.config});else if("window"===o){const n={id:e.id,parent:t,frame:i.frame,workspace:i,config:e.config};r=this.ioc.getModel(o,n)}else{const n={id:e.id,children:[],parent:t,frame:i.frame,workspace:i,config:e.config};r=this.ioc.getModel(o,n)}return"window"!==o&&this.refreshChildren({workspace:i,existingChildren:n,children:e.children,parent:r}),r});return t instanceof st||this.privateDataManager.remapChild(t,{children:o}),o}iterateFindChild(e,t){let r=e.find(e=>t(e));return r||(e.some(e=>!(e instanceof ut)&&(r=this.iterateFindChild(e.children,t),!!r||void 0)),r)}iterateFilterChildren(e,t){const r=e.filter(e=>t(e)),n=e.reduce((e,r)=>(r instanceof ut||e.push(...this.iterateFilterChildren(r.children,t)),e),[]);return r.push(...n),r}}class kt{constructor(e,t,r){this.agm=e,this.windows=t,this.layouts=r}get baseController(){return this._baseController||(this._baseController=new It(this,this.windows)),this._baseController}get controller(){return this._controllerInstance||(this._controllerInstance=window.glue42gd?new Be(this.bridge,this.baseController):new wt(this.bridge,new bt(this.agm,this.windows,this.bridge),this.layouts,this.baseController)),this._controllerInstance}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new Ue(this.transport,r())),this._bridgeInstance}get transport(){return this._transportInstance||(this._transportInstance=new ze(this.agm)),this._transportInstance}get privateDataManager(){return this._privateDataManagerInstance||(this._privateDataManagerInstance=new ft),this._privateDataManagerInstance}get parentBase(){return this._parentBaseInstance||(this._parentBaseInstance=new yt(this.privateDataManager)),this._parentBaseInstance}initiate(){return e(this,void 0,void 0,(function*(){yield this.transport.initiate()}))}getModel(e,t){switch(e){case"frame":{const e=new pt(this.privateDataManager),{summary:r}=t,n={summary:r,controller:this.controller};return this.privateDataManager.setFrameData(e,n),e}case"window":{const{id:e,parent:r,frame:n,workspace:i,config:o}=t,s={type:"window",controller:this.controller,config:o,id:e,parent:r,frame:n,workspace:i},a=new ut(this.privateDataManager);return this.privateDataManager.setWindowData(a,s),a}case"row":case"column":case"group":{const{id:r,children:n,parent:i,frame:o,workspace:s,config:a}=t,c="column"===e?new Qe(this.parentBase):"row"===e?new Ve(this.parentBase):new rt(this.parentBase),u=this.buildChildren(n,o,s,c),d={id:r,parent:i,frame:o,workspace:s,config:a,type:e,controller:this.controller,children:u};return this.privateDataManager.setParentData(c,d),c}case"workspace":{const{snapshot:e,frame:r}=t,n=new st(this.privateDataManager);console.log("building children with this snapshot",e);const i=this.buildChildren(e.children,r,n,n),o={id:e.id,type:"workspace",config:e.config,base:this.parentBase,controller:this.controller,children:i,frame:r,ioc:this};return this.privateDataManager.setWorkspaceData(n,o),n}default:throw new Error("Unrecognized type: "+e)}}getBuilder(e){e.definition=e.definition||{},Array.isArray(e.definition.children)||(e.definition.children=[]);const t=new He(this.getBuilder.bind(this));switch(e.type){case"workspace":return new Ke(e.definition,t,this.controller);case"row":case"column":case"group":return e.definition.type=e.type,new qe(e.definition,t);default:throw new Error("Unexpected Builder creation error, provided config: "+JSON.stringify(e))}}buildChildren(e,t,r,n){return e.map(e=>{switch(e.type){case"window":return this.getModel("window",{id:e.id,config:e.config,frame:t,workspace:r,parent:n});case"column":case"row":case"group":return this.getModel(e.type,{id:e.id,config:e.config,children:e.children,frame:t,workspace:r,parent:n});default:throw new Error("Unsupported child type: "+e.type)}})}}const St=t=>e(void 0,void 0,void 0,(function*(){const r=new kt(t.agm,t.windows,t.layouts);yield r.initiate(),t.workspaces=((t,r)=>{const n=r.controller;return{inWorkspace:()=>{const e=t.windows.my().id;if(!e)throw new Error("Cannot get my frame, because my id is undefined.");return n.checkIsInSwimlane(e)},getBuilder:e=>{const t=J.runWithException(e);return r.getBuilder(t)},getMyFrame:()=>e(void 0,void 0,void 0,(function*(){const e=t.windows.my().id;if(!e)throw new Error("Cannot get my frame, because my id is undefined.");if(!(yield n.checkIsInSwimlane(e)))throw new Error("Cannot fetch your frame, because this window is not in a workspace");return n.getFrame({windowId:e})})),getFrame:t=>e(void 0,void 0,void 0,(function*(){return j(t),n.getFrame({predicate:t})})),getAllFrames:t=>e(void 0,void 0,void 0,(function*(){return j(t,!0),n.getFrames(t)})),getAllWorkspacesSummaries:()=>n.getAllWorkspaceSummaries(),getMyWorkspace:()=>e(void 0,void 0,void 0,(function*(){const e=t.windows.my().id;if(!e)throw new Error("Cannot get my workspace, because my id is undefined.");if(!(yield n.checkIsInSwimlane(e)))throw new Error("Cannot fetch your workspace, because this window is not in a workspace");return(yield n.getWorkspaces(t=>!!t.getWindow(t=>t.id===e)))[0]})),getWorkspace:t=>e(void 0,void 0,void 0,(function*(){return j(t),(yield n.getWorkspaces(t))[0]})),getAllWorkspaces:e=>(j(e,!0),n.getWorkspaces(e)),getWindow:t=>e(void 0,void 0,void 0,(function*(){return j(t),n.getWindow(t)})),getParent:t=>e(void 0,void 0,void 0,(function*(){return j(t),n.getParent(t)})),restoreWorkspace:(t,r)=>e(void 0,void 0,void 0,(function*(){M.runWithException(t);const e=G.runWithException(r);return n.restoreWorkspace(t,e)})),createWorkspace:(t,r)=>e(void 0,void 0,void 0,(function*(){const e=H.runWithException(t),i=O.runWithException(r);return n.createWorkspace(e,i)})),layouts:{getSummaries:()=>n.getLayoutSummaries(),delete:t=>e(void 0,void 0,void 0,(function*(){return M.runWithException(t),n.deleteLayout(t)})),export:t=>e(void 0,void 0,void 0,(function*(){return j(t,!0),n.exportLayout(t)})),import:t=>e(void 0,void 0,void 0,(function*(){return t.forEach(e=>ue.runWithException(e)),n.importLayout(t)})),save:t=>e(void 0,void 0,void 0,(function*(){const e=Oe.runWithException(t);return n.saveLayout(e)}))},onFrameOpened:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{const n={summary:e.frameSummary},i=r.getModel("frame",n);t(i)},"frame","opened")})),onFrameClosing:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{const n={summary:e.frameSummary},i=r.getModel("frame",n);t(i)},"frame","closing")})),onFrameClosed:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{t({frameId:e.frameSummary.id})},"frame","closed")})),onFrameFocusChange:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{const n={summary:e.frameSummary},i=r.getModel("frame",n);t(i)},"frame","focus")})),onWorkspaceOpened:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e={summary:i.frameSummary},o={frame:r.getModel("frame",e),snapshot:yield n.getSnapshot(i.workspaceSummary.id,"workspace")},s=r.getModel("workspace",o);t(s)})),"workspace","opened")})),onWorkspaceClosing:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e={summary:i.frameSummary},o={frame:r.getModel("frame",e),snapshot:yield n.getSnapshot(i.workspaceSummary.id,"workspace")},s=r.getModel("workspace",o);t(s)})),"workspace","closing")})),onWorkspaceClosed:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{t({frameId:e.frameSummary.id,workspaceId:e.workspaceSummary.id})},"workspace","closed")})),onWorkspaceFocusChange:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e={summary:i.frameSummary},o={frame:r.getModel("frame",e),snapshot:yield n.getSnapshot(i.workspaceSummary.id,"workspace")},s=r.getModel("workspace",o);t(s)})),"workspace","focus")})),onWindowAdded:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e=yield n.getSnapshot(i.windowSummary.config.workspaceId,"workspace"),o={summary:e.frameSummary},s={frame:r.getModel("frame",o),snapshot:e},a=r.getModel("workspace",s).getParent(e=>e.id===i.windowSummary.parentId).getChild(e=>"window"===e.type&&e.positionIndex===i.windowSummary.config.positionIndex);t(a)})),"window","added")})),onWindowLoaded:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e=yield n.getSnapshot(i.windowSummary.config.workspaceId,"workspace"),o={summary:e.frameSummary},s={frame:r.getModel("frame",o),snapshot:e},a=r.getModel("workspace",s).getWindow(e=>e.id&&e.id===i.windowSummary.config.windowId);t(a)})),"window","loaded")})),onWindowRemoved:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{const{windowId:r,workspaceId:n,frameId:i}=e.windowSummary.config;t({windowId:r,workspaceId:n,frameId:i})},"window","removed")})),onWindowFocusChange:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e=yield n.getSnapshot(i.windowSummary.config.workspaceId,"workspace"),o={summary:e.frameSummary},s={frame:r.getModel("frame",o),snapshot:e},a=r.getModel("workspace",s).getWindow(e=>e.id&&e.id===i.windowSummary.config.windowId);t(a)})),"window","focus")})),onParentAdded:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(i=>e(void 0,void 0,void 0,(function*(){const e=yield n.getSnapshot(i.containerSummary.config.workspaceId,"workspace"),o={summary:e.frameSummary},s={frame:r.getModel("frame",o),snapshot:e},a=r.getModel("workspace",s).getParent(e=>e.id===i.containerSummary.itemId);t(a)})),"container","added")})),onParentRemoved:t=>e(void 0,void 0,void 0,(function*(){return j(t),yield n.processGlobalSubscription(e=>{const{workspaceId:r,frameId:n}=e.containerSummary.config;t({id:e.containerSummary.itemId,workspaceId:r,frameId:n})},"container","removed")}))}})(t,r)}));return"undefined"!=typeof window&&(window.GlueWorkspaces=St),St}()},function(e,t,r){"use strict";r.r(t);var n=r(0),i=r.n(n);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function o(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function s(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t){var n=r[e];return n||(n=[],r[e]=n),n.push(t),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}s.default=s;var a=s,c=function(e){return{ok:!0,result:e}},u=function(e){return{ok:!1,error:e}},d=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},l=function(e,t){return!0===t.ok?t.result:e},h=function(e){if(!0===e.ok)return e.result;throw e.error},p=function(e,t){return!0===t.ok?c(e(t.result)):t},f=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:c(e(t.result,r.result))},m=function(e,t){return!0===t.ok?t:u(e(t.error))},g=function(e,t){return!0===t.ok?e(t.result):t},v=(Object.freeze({ok:c,isOk:function(e){return!0===e.ok},err:u,isErr:function(e){return!1===e.ok},asPromise:d,withDefault:l,withException:h,successes:function(e){return e.reduce((function(e,t){return!0===t.ok?e.concat(t.result):e}),[])},map:p,map2:f,mapError:m,andThen:g}),function(){return(v=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)});var y=function(e){return Array.isArray(e)},w=function(e){return"object"==typeof e&&null!==e&&!y(e)},b=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},I=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},k=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return v({at:e+(r||"")},n)},S=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return m((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return d(r.run(e))},this.runWithException=function(e){return h(r.run(e))},this.map=function(t){return new e((function(e){return p(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return g((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?c(e):u({message:b("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?c(e):u({message:b("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?c(e):u({message:b("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return function e(t,r){if(t===r)return!0;if(null===t&&null===r)return!0;if(typeof t!=typeof r)return!1;if("object"==typeof t){if(Array.isArray(t)){if(!Array.isArray(r))return!1;if(t.length!==r.length)return!1;for(var n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1;return!0}var i=Object.keys(t);if(i.length!==Object.keys(r).length)return!1;for(n=0;n<i.length;n++){if(!r.hasOwnProperty(i[n]))return!1;if(!e(t[i[n]],r[i[n]]))return!1}return!0}}(e,t)?c(t):u({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(w(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?u({message:"the key '"+n+"' is required but was not present"}):u(k("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return c(r)}return w(e)?c(e):u({message:b("an object",e)})}))},e.array=function(t){return new e((function(e){if(y(e)&&t){return e.reduce((function(e,r,n){return f((function(e,t){return e.concat([t])}),e,function(e,r){return m((function(e){return k("["+r+"]",e)}),t.decode(e))}(r,n))}),c([]))}return y(e)?c(e):u({message:b("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(y(e)){if(e.length!==t.length)return u({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return u(k("["+n+"]",i.error));r[n]=i.result}return c(r)}return u({message:b("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return f(Object.assign,t,r.decode(e))}),c({}))}))},e.anyJson=function(){return new e((function(e){return c(e)}))},e.unknownJson=function(){return new e((function(e){return c(e)}))},e.dict=function(t){return new e((function(e){if(w(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return u(k("."+n,i.error));r[n]=i.result}return c(r)}return u({message:b("an object",e)})}))},e.optional=function(t){return new e((function(e){return void 0===e?c(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return u({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return c(l(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return u({at:I(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!w(n))return u({at:I(t.slice(0,i+1)),message:b("an object",n)});if("number"==typeof t[i]&&!y(n))return u({at:I(t.slice(0,i+1)),message:b("an array",n)});n=n[t[i]]}return m((function(e){return void 0===n?{at:I(t),message:"path does not exist"}:k(I(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return c(t)}))},e.fail=function(t){return new e((function(e){return u({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),x=S.string,W=S.number,C=S.boolean,T=S.anyJson,E=S.constant,_=S.object,M=S.array,A=S.optional,P=S.oneOf,L=S.intersection,D=S.lazy;const j=x().where(e=>e.length>0,"Expected a non-empty string"),O=W().where(e=>e>=0,"Expected a non-negative number"),R=_({inWorkspace:C()}),F=P(E("workspace"),E("row"),E("column"),E("group")),N=P(E("row"),E("column"),E("group")),B=(e,t)=>{const r=typeof e;if(t&&"function"!==r&&"undefined"!==r)throw new Error("Provided argument must be either undefined or of type function, provided: "+r);if(!t&&"function"!==r)throw new Error("Provided argument must be of type function, provided: "+r)},U=A(_({saveLayout:A(C())})),z=_({name:j}),G=_({type:A(E("window")),appName:A(j),windowId:A(j)}),q=A(_({type:A(N),children:A(D(()=>M(P(G,q))))})),H=_({type:N,children:A(D(()=>M(P(G,q))))}),J=(P(x().where(e=>"maximized"===e.toLowerCase(),"Expected a case insensitive variation of 'maximized'"),x().where(e=>"normal"===e.toLowerCase(),"Expected a case insensitive variation of 'normal'")),_({bounds:A(_({left:A(W()),top:A(W()),width:A(O),height:A(O)}))})),K=P(E("direct"),E("delayed"),E("lazy")),$=A(_({app:A(j),context:A(T()),restoreType:A(K),title:A(j),reuseWorkspaceId:A(j),frameId:A(j),lockdown:A(C()),activateFrame:A(C()),newFrame:A(P(J,C())),inMemoryLayout:A(C())})),Y=_({name:j,restoreOptions:A($)}),V=_({children:A(M(P(G,q))),context:A(T()),config:A(_({title:A(j),position:A(O),isFocused:A(C())})),frame:A(_({reuseFrameId:A(j),newFrame:A(P(C(),J))}))}),X=_({type:F,definition:A(P(V,q))}),Z=L(V,_({saveConfig:A(_({saveLayout:A(C())}))})),Q=_({itemId:j}),ee=_({id:j}),te=(_({id:j,frameId:j,positionIndex:W(),title:j,focused:C()}),_({type:N,id:j,frameId:j,workspaceId:j,positionIndex:W()}),_({id:A(j),frameId:j,workspaceId:j,positionIndex:W(),isMaximized:C(),title:A(x()),isLoaded:C(),focused:C(),type:E("window")}),_({type:P(E("frame"),E("workspace"),E("container"),E("window")),branch:j})),re=P(E("opened"),E("closing"),E("closed"),E("focus"),E("added"),E("loaded"),E("removed"),E("childrenUpdate"),E("containerChange")),ne=_({frameId:j,title:j,positionIndex:O,name:j}),ie=_({frameId:j,workspaceId:j,positionIndex:O}),oe=T(),se=L(ie,_({windowId:A(j),isMaximized:C(),isLoaded:C(),isFocused:C(),title:A(x())})),ae=_({id:j,config:P(oe,se),children:A(D(()=>M(ae))),type:P(E("window"),E("row"),E("column"),E("group"))}),ce=_({id:j,config:ne,children:M(ae),frameSummary:ee}),ue=_({id:A(j),config:P(oe,se),children:A(D(()=>M(ue))),type:P(E("window"),E("row"),E("column"),E("group"))}),de=(_({id:A(j),children:M(ue)}),_({type:E("window"),config:_({appName:j,url:A(j)})})),le=_({type:E("group"),config:T(),children:M(P(de))}),he=_({type:E("column"),config:T(),children:M(P(le,de,D(()=>he),D(()=>pe)))}),pe=_({type:E("row"),config:T(),children:M(P(he,le,de,D(()=>pe)))}),fe=_({name:j,type:E("Workspace"),metadata:A(T()),components:M(_({type:E("Workspace"),state:_({config:T(),children:M(P(pe,he,le,de))})}))}),me=_({layouts:M(fe)}),ge=_({id:j}),ve=_({summaries:M(ge)}),ye=_({id:j,config:ne}),we=_({summaries:M(ye)}),be=_({id:j,config:T(),workspaces:M(ce)}),Ie=_({name:j}),ke=_({summaries:M(Ie)}),Se=_({windowId:j}),xe=T(),We=_({width:A(O),height:A(O),relative:A(C())}),Ce=_({top:A(W()),left:A(W()),relative:A(C())}),Te=_({itemId:j}),Ee=_({itemId:j,title:j}),_e=_({itemId:j,containerId:j}),Me=L(Te,We),Ae=L(Te,Ce),Pe=(_({id:j,type:N}),_({definition:G,parentId:j,parentType:F})),Le=_({definition:H,parentId:j,parentType:F}),De=_({itemId:j,windowId:A(j)}),je=_({type:P(E("row"),E("column")),workspaceId:j}),Oe=_({itemId:j,config:oe}),Re=_({frameSummary:ee}),Fe=_({workspaceSummary:ye,frameSummary:ee}),Ne=_({containerSummary:Oe}),Be=_({windowSummary:_({itemId:j,parentId:j,config:se})}),Ue=_({name:j,workspaceId:j}),ze={control:{name:"T42.Workspaces.Control",isStream:!1},frameStream:{name:"T42.Workspaces.Stream.Frame",isStream:!0},workspaceStream:{name:"T42.Workspaces.Stream.Workspace",isStream:!0},containerStream:{name:"T42.Workspaces.Stream.Container",isStream:!0},windowStream:{name:"T42.Workspaces.Stream.Window",isStream:!0}},Ge={frame:{name:"T42.Workspaces.Stream.Frame",payloadDecoder:Re},workspace:{name:"T42.Workspaces.Stream.Workspace",payloadDecoder:Fe},container:{name:"T42.Workspaces.Stream.Container",payloadDecoder:Ne},window:{name:"T42.Workspaces.Stream.Window",payloadDecoder:Be}},qe={isWindowInWorkspace:{name:"isWindowInWorkspace",argsDecoder:Te,resultDecoder:R},createWorkspace:{name:"createWorkspace",resultDecoder:ce,argsDecoder:Z},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:ve},getFrameSummary:{name:"getFrameSummary",resultDecoder:ee,argsDecoder:Q},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:we},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",resultDecoder:ce,argsDecoder:Te},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:ke},openWorkspace:{name:"openWorkspace",argsDecoder:Y,resultDecoder:ce},deleteLayout:{name:"deleteLayout",resultDecoder:xe,argsDecoder:z},saveLayout:{name:"saveLayout",resultDecoder:fe,argsDecoder:Ue},importLayout:{name:"importLayout",resultDecoder:xe,argsDecoder:fe},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:me},restoreItem:{name:"restoreItem",argsDecoder:Te,resultDecoder:xe},maximizeItem:{name:"maximizeItem",argsDecoder:Te,resultDecoder:xe},focusItem:{name:"focusItem",argsDecoder:Te,resultDecoder:xe},closeItem:{name:"closeItem",argsDecoder:Te,resultDecoder:xe},resizeItem:{name:"resizeItem",argsDecoder:Me,resultDecoder:xe},moveFrame:{name:"moveFrame",argsDecoder:Ae,resultDecoder:xe},getFrameSnapshot:{name:"getFrameSnapshot",argsDecoder:Te,resultDecoder:be},forceLoadWindow:{name:"forceLoadWindow",argsDecoder:Te,resultDecoder:Se},ejectWindow:{name:"ejectWindow",argsDecoder:Te,resultDecoder:xe},setItemTitle:{name:"setItemTitle",argsDecoder:Ee,resultDecoder:xe},moveWindowTo:{name:"moveWindowTo",argsDecoder:_e,resultDecoder:xe},addWindow:{name:"addWindow",argsDecoder:Pe,resultDecoder:De},addContainer:{name:"addContainer",argsDecoder:Le,resultDecoder:De},bundleWorkspace:{name:"bundleWorkspace",argsDecoder:je,resultDecoder:xe}};class He{constructor(e,t){this.bridge=e,this.base=t}checkIsInSwimlane(e){return o(this,void 0,void 0,(function*(){return(yield this.bridge.send(qe.isWindowInWorkspace.name,{itemId:e})).inWorkspace}))}createWorkspace(e,t){return o(this,void 0,void 0,(function*(){const r=Object.assign({},e,{saveConfig:t});return yield this.base.createWorkspace(r)}))}restoreWorkspace(e,t){return o(this,void 0,void 0,(function*(){if(!(yield this.getLayoutSummaries()).some(t=>t.name===e))throw new Error(`This layout: ${e} cannot be restored, because it doesn't exist.`);if(null==t?void 0:t.frameId){if(!(yield this.bridge.send(qe.getAllFramesSummaries.name)).summaries.some(e=>e.id===t.frameId))throw new Error(`Cannot reuse the frame with id: ${t.frameId}, because there is no frame with that ID found`)}return yield this.base.restoreWorkspace(e,t)}))}add(e,t,r,n){return o(this,void 0,void 0,(function*(){return yield this.base.add(e,t,r,n)}))}processLocalSubscription(e,t){return e.levelId=e.levelId||t,this.bridge.subscribe(e)}processGlobalSubscription(e,t,r){const n={streamType:t,callback:e,action:r,level:"global"};return this.bridge.subscribe(n)}getFrame(e){return o(this,void 0,void 0,(function*(){if(e.windowId)return yield this.base.getFrame(e.windowId);if(e.predicate)return(yield this.getFrames(e.predicate))[0];throw new Error("The provided selector is not valid: "+JSON.stringify(e))}))}getFrames(e){return o(this,void 0,void 0,(function*(){const t=yield this.bridge.send(qe.getAllFramesSummaries.name);return this.base.getFrames(t.summaries,e)}))}getWorkspace(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{e(r)&&(t=r,n())}),t}))}getWorkspaces(e){return o(this,void 0,void 0,(function*(){const t=[];return yield this.iterateWorkspaces(r=>{e&&!e(r)||t.push(r)}),t}))}getAllWorkspaceSummaries(){return o(this,void 0,void 0,(function*(){const e=yield this.bridge.send(qe.getAllWorkspacesSummaries.name,{});return this.base.getAllWorkspaceSummaries(e)}))}getWindow(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{const i=r.getWindow(e);i&&(t=i,n())}),t}))}getParent(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{const i=r.getParent(e);i&&(t=i,n())}),t}))}getLayoutSummaries(){return o(this,void 0,void 0,(function*(){return(yield this.bridge.send(qe.getAllLayoutsSummaries.name)).summaries}))}deleteLayout(e){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.deleteLayout.name,{name:e})}))}exportLayout(e){return o(this,void 0,void 0,(function*(){return(yield this.bridge.send(qe.exportAllLayouts.name)).layouts.reduce((t,r)=>(e&&!e(r)||t.push(r),t),[])}))}saveLayout(e){return o(this,void 0,void 0,(function*(){return yield this.bridge.send(qe.saveLayout.name,{name:e.name,workspaceId:e.workspaceId})}))}importLayout(e){return o(this,void 0,void 0,(function*(){yield Promise.all(e.map(e=>this.bridge.send(qe.importLayout.name,e)))}))}bundleTo(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.bundleTo(e,t)}))}restoreItem(e){return o(this,void 0,void 0,(function*(){return yield this.base.restoreItem(e)}))}maximizeItem(e){return o(this,void 0,void 0,(function*(){return yield this.base.maximizeItem(e)}))}focusItem(e){return o(this,void 0,void 0,(function*(){return yield this.base.focusItem(e)}))}closeItem(e){return o(this,void 0,void 0,(function*(){return yield this.base.closeItem(e)}))}resizeItem(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.resizeItem(e,t)}))}moveFrame(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.moveFrame(e,t)}))}getGDWindow(e){return this.base.getGDWindow(e)}forceLoadWindow(e){return o(this,void 0,void 0,(function*(){return yield this.base.forceLoadWindow(e)}))}ejectWindow(e){return o(this,void 0,void 0,(function*(){return yield this.base.ejectWindow(e)}))}moveWindowTo(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.moveWindowTo(e,t)}))}getSnapshot(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.getSnapshot(e,t)}))}setItemTitle(e,t){return o(this,void 0,void 0,(function*(){return yield this.base.setItemTitle(e,t)}))}refreshChildren(e){return this.base.refreshChildren(e)}iterateFindChild(e,t){return this.base.iterateFindChild(e,t)}iterateFilterChildren(e,t){return this.base.iterateFilterChildren(e,t)}iterateWorkspaces(e){return o(this,void 0,void 0,(function*(){let t=!1;const r=()=>{t=!0},n=yield this.getAllWorkspaceSummaries();for(const i of n){if(t)return;const n=yield this.base.fetchWorkspace(i.id);e(n,r)}}))}}class Je{constructor(e,t){this.transport=e,this.registry=t,this.activeSubscriptions=[]}send(e,t,r){return o(this,void 0,void 0,(function*(){if(!window.glue42gd&&!r)throw new Error(`Cannot complete operation: ${e} with args: ${JSON.stringify(t)}, because the environment is Glue42 Core and no frame target was provided`);const n=Object.values(qe).find(t=>t.name===e);if(!n)throw new Error("Cannot find definition for operation name: "+e);if(n.argsDecoder)try{n.argsDecoder.runWithException(t)}catch(e){throw new Error(`Unexpected internal outgoing validation error: ${e.message}, for input: ${JSON.stringify(e.input)}`)}let i;try{const e=yield this.transport.transmitControl(n.name,t,r);i=n.resultDecoder.runWithException(e)}catch(r){if(r.kind)throw console.log("Pre exception",e,t),new Error(`Unexpected internal incoming validation error: ${r.message}, for input: ${JSON.stringify(r.input)}`);throw new Error(r.message)}return i}))}subscribe(e){return o(this,void 0,void 0,(function*(){let t=this.getActiveSubscription(e);const r=this.getRegistryKey(e);if(!t){console.log("no active sub will subscribe",e);const r=Ge[e.streamType],n=yield this.transport.subscribe(r.name,this.getBranchKey(e),e.streamType);n.onData(e=>{console.log("received from stream",e);const t=e.data,r=te.run(e.requestArguments),n=re.run(t.action);if(!r.ok||!n.ok)return void console.log("the requested arguments weren't ok",e,r,n);const i=r.result.type,o=r.result.branch,s=Ge[i].payloadDecoder.run(t.payload);if(!s.ok)return void console.log("the payload wasn't ok",e,s);const a=`${i}-${o}-${n.result}`;console.log("will execute callback",a),this.registry.execute(a,s.result)}),t={streamType:e.streamType,level:e.level,levelId:e.levelId,callbacksCount:0,gdSub:n},this.activeSubscriptions.push(t)}const n=this.registry.add(r,e.callback);return++t.callbacksCount,()=>{n(),--t.callbacksCount,0===t.callbacksCount&&(t.gdSub.close(),this.activeSubscriptions.splice(this.activeSubscriptions.indexOf(t),1))}}))}getBranchKey(e){return"global"===e.level?e.level:`${e.level}_${e.levelId}`}getRegistryKey(e){return`${e.streamType}-${this.getBranchKey(e)}-${e.action}`}getActiveSubscription(e){return this.activeSubscriptions.find(t=>t.streamType===e.streamType&&t.level===e.level&&t.levelId===e.levelId)}}class Ke{constructor(e){this.agm=e,this.defaultTransportTimeout=3e4}initiate(){return o(this,void 0,void 0,(function*(){window.glue42gd&&(yield Promise.all(Object.values(ze).map(e=>this.verifyMethodLive(e.name,e.isStream))))}))}subscribe(e,t,r){return o(this,void 0,void 0,(function*(){const n={branch:t,type:r};let i;try{i=yield this.agm.subscribe(e,{arguments:n})}catch(r){const n=`Internal subscription error! Error details: stream - ${e}, branch: ${t}. Internal message: ${r.message}`;throw new Error(n)}return i}))}transmitControl(e,t,r){return o(this,void 0,void 0,(function*(){if(!this.agm.methods().find(e=>e.name===ze.control.name))throw new Error(`Cannot complete operation: ${e}, because no control method was found`);const n={operation:e,operationArguments:t};let i;const o=`Internal Swimlane Communication Error. Attempted operation: ${JSON.stringify(n)}. `;try{if(i=yield this.agm.invoke(ze.control.name,n,r,{methodResponseTimeoutMs:this.defaultTransportTimeout}),!i)throw new Error("Received unsupported result from GD - empty result");if(!Array.isArray(i.all_return_values)||0===i.all_return_values.length)throw new Error("Received unsupported result from GD - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${o} -> Inner message: ${t}`)}throw new Error(`${o} -> Inner message: ${e.message}`)}return i.all_return_values[0].returned}))}verifyMethodLive(e,t){return r=()=>new Promise(r=>{if(this.agm.methods().find(r=>r.name===e&&r.supportsStreaming===t))return void r();let n=this.agm.methodAdded(i=>{i.name===e&&i.supportsStreaming===t&&(n?(n(),n=null):setTimeout(()=>{n&&n()},0),r())})}),n=15e3,i="Timeout waiting for the Swimlane communication channels",new Promise((e,t)=>{let o=!0;const s=setTimeout(()=>{o&&(o=!1,t(i||"Promise timeout hit: "+n))},n);r().then(t=>{o&&(o=!1,clearTimeout(s),e(t))}).catch(e=>{o&&(o=!1,clearTimeout(s),t(e))})});var r,n,i}}const $e=new WeakMap;class Ye{constructor(e,t){const r=t.wrapChildren(e.children);delete e.children,$e.set(this,{base:t,children:r,definition:e})}get type(){return $e.get(this).definition.type}addColumn(e){return $e.get(this).base.add("column",$e.get(this).children,e)}addRow(e){return $e.get(this).base.add("row",$e.get(this).children,e)}addGroup(e){return $e.get(this).base.add("group",$e.get(this).children,e)}addWindow(e){return $e.get(this).base.addWindow($e.get(this).children,e),this}serialize(){const e=$e.get(this).definition;return e.children=$e.get(this).base.serializeChildren($e.get(this).children),e}}class Ve{constructor(e){this.getBuilder=e}wrapChildren(e){return e.map(e=>"window"===e.type?e:this.getBuilder({type:e.type,definition:e}))}add(e,t,r){const n=q.runWithException(r),i=this.getBuilder({type:e,definition:n});return t.push(i),i}addWindow(e,t){const r=G.runWithException(t);r.type="window",e.push(r)}serializeChildren(e){return e.map(e=>e instanceof Ye?e.serialize():e)}}const Xe=new WeakMap;class Ze{constructor(e,t,r){const n=t.wrapChildren(e.children);delete e.children,Xe.set(this,{base:t,children:n,definition:e,controller:r})}addColumn(e){const t=Xe.get(this).children;if(!t.every(e=>e instanceof Ye&&"column"===e.type))throw new Error("Cannot add a column to this workspace, because there are already children of another type");return Xe.get(this).base.add("column",t,e)}addRow(e){const t=Xe.get(this).children;if(!t.every(e=>e instanceof Ye&&"row"===e.type))throw new Error("Cannot add a row to this workspace, because there are already children of another type");return Xe.get(this).base.add("row",t,e)}addGroup(e){const t=Xe.get(this).children;if(0!==t.length)throw new Error("Cannot add a group to this workspace, because there are already defined children.");return Xe.get(this).base.add("group",t,e)}addWindow(e){const t=Xe.get(this).children;if(0!==t.length)throw new Error("Cannot add a window to this workspace, because there are already defined children.");return Xe.get(this).base.addWindow(t,e),this}getChildAt(e){O.runWithException(e);return Xe.get(this).children[e]}create(e){return o(this,void 0,void 0,(function*(){const t=U.runWithException(e),r=Xe.get(this).definition;r.children=Xe.get(this).base.serializeChildren(Xe.get(this).children);return Xe.get(this).controller.createWorkspace(r,t)}))}}const Qe=new WeakMap,et=e=>Qe.get(e).base;class tt{constructor(e){Qe.set(this,{base:e})}get type(){return"row"}get id(){return et(this).getId(this)}get frameId(){return et(this).getFrameId(this)}get workspaceId(){return et(this).getWorkspaceId(this)}get positionIndex(){return et(this).getPositionIndex(this)}get children(){return et(this).getAllChildren(this)}get parent(){return et(this).getMyParent(this)}get frame(){return et(this).getMyFrame(this)}get workspace(){return et(this).getMyWorkspace(this)}addWindow(e){return et(this).addWindow(this,e,"row")}addGroup(e){return o(this,void 0,void 0,(function*(){if((null==e?void 0:e.type)&&"group"!==e.type)throw new Error("Expected a group definition, but received "+e.type);return et(this).addParent(this,"group","row",e)}))}addColumn(e){return o(this,void 0,void 0,(function*(){if((null==e?void 0:e.type)&&"column"!==e.type)throw new Error("Expected a column definition, but received "+e.type);return et(this).addParent(this,"column","row",e)}))}addRow(){return o(this,void 0,void 0,(function*(){throw new Error("Adding rows as row children is not supported")}))}removeChild(e){return console.log("in row close will remove child"),et(this).removeChild(this,e)}maximize(){return et(this).maximize(this)}restore(){return et(this).restore(this)}close(){return et(this).close(this)}}const rt=new WeakMap,nt=e=>rt.get(e).base;class it{constructor(e){rt.set(this,{base:e})}get type(){return"column"}get id(){return nt(this).getId(this)}get frameId(){return nt(this).getFrameId(this)}get workspaceId(){return nt(this).getWorkspaceId(this)}get positionIndex(){return nt(this).getPositionIndex(this)}get children(){return nt(this).getAllChildren(this)}get parent(){return nt(this).getMyParent(this)}get frame(){return nt(this).getMyFrame(this)}get workspace(){return nt(this).getMyWorkspace(this)}addWindow(e){return nt(this).addWindow(this,e,"column")}addGroup(e){return o(this,void 0,void 0,(function*(){if((null==e?void 0:e.type)&&"group"!==e.type)throw new Error("Expected a group definition, but received "+e.type);return nt(this).addParent(this,"group","column",e)}))}addColumn(e){return o(this,void 0,void 0,(function*(){throw new Error("Adding columns as column children is not supported")}))}addRow(e){return o(this,void 0,void 0,(function*(){if((null==e?void 0:e.type)&&"row"!==e.type)throw new Error("Expected a row definition, but received "+e.type);return nt(this).addParent(this,"row","column",e)}))}removeChild(e){return nt(this).removeChild(this,e)}maximize(){return nt(this).maximize(this)}restore(){return nt(this).restore(this)}close(){return nt(this).close(this)}}const ot=new WeakMap,st=e=>ot.get(e).base;class at{constructor(e){ot.set(this,{base:e})}get type(){return"group"}get id(){return st(this).getId(this)}get frameId(){return st(this).getFrameId(this)}get workspaceId(){return st(this).getWorkspaceId(this)}get positionIndex(){return st(this).getPositionIndex(this)}get children(){return st(this).getAllChildren(this)}get parent(){return st(this).getMyParent(this)}get frame(){return st(this).getMyFrame(this)}get workspace(){return st(this).getMyWorkspace(this)}addWindow(e){return st(this).addWindow(this,e,"group")}addGroup(){return o(this,void 0,void 0,(function*(){throw new Error("Adding groups as group child is not supported")}))}addColumn(){return o(this,void 0,void 0,(function*(){throw new Error("Adding columns as group child is not supported")}))}addRow(){return o(this,void 0,void 0,(function*(){throw new Error("Adding rows as group child is not supported")}))}removeChild(e){return st(this).removeChild(this,e)}maximize(){return st(this).maximize(this)}restore(){return st(this).restore(this)}close(){return st(this).close(this)}}const ct=new WeakMap,ut=e=>ct.get(e).manager.getWorkspaceData(e),dt=e=>ct.get(e).manager;class lt{constructor(e){ct.set(this,{manager:e})}get id(){return ut(this).id}get frameId(){return ut(this).config.frameId}get positionIndex(){return ut(this).config.positionIndex}get title(){return ut(this).config.title}get children(){return ut(this).children}get frame(){return ut(this).frame}removeChild(e){return o(this,void 0,void 0,(function*(){B(e);const t=this.children.find(e);t&&(yield t.close(),yield this.refreshReference())}))}remove(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).controller.iterateFindChild(this.children,e);yield t.close(),yield this.refreshReference()}))}focus(){return o(this,void 0,void 0,(function*(){yield ut(this).controller.focusItem(this.id),yield this.refreshReference()}))}close(){return o(this,void 0,void 0,(function*(){const e=ut(this).controller,t=1===(yield ut(this).frame.workspaces()).length?ut(this).frame:null;yield e.closeItem(this.id,t)}))}snapshot(){return ut(this).controller.getSnapshot(this.id,"workspace")}saveLayout(e){return o(this,void 0,void 0,(function*(){j.runWithException(e),yield ut(this).controller.saveLayout({name:e,workspaceId:this.id})}))}setTitle(e){return o(this,void 0,void 0,(function*(){j.runWithException(e);const t=ut(this).controller;yield t.setItemTitle(this.id,e),yield this.refreshReference()}))}refreshReference(){return o(this,void 0,void 0,(function*(){const e=yield ut(this).controller.getSnapshot(this.id,"workspace");console.log("new workspace snapshot",e);const t=e.children.reduce((e,t)=>{let r;return r="window"===t.type?this.getWindow(e=>e.id===t.id):this.getParent(e=>e.id===t.id),r&&e.push(r),e},[]),r=ut(this).controller.refreshChildren({existingChildren:t,workspace:this,parent:this,children:e.children}),n=this.frame;let i;if(n.id===e.config.frameId)dt(this).remapFrame(n,e.frameSummary),i=n;else{const t={summary:e.frameSummary};i=ut(this).ioc.getModel("frame",t)}dt(this).remapWorkspace(this,{config:e.config,children:r,frame:i})}))}getParent(e){B(e);const t=ut(this).children;return ut(this).controller.iterateFindChild(t,t=>"window"!==t.type&&e(t))}getAllParents(e){B(e,!0);const t=ut(this).children,r=ut(this).controller.iterateFilterChildren(t,e=>"window"!==e.type);return e?r.filter(e):r}getRow(e){return B(e),this.getParent(t=>"row"===t.type&&e(t))}getAllRows(e){return B(e,!0),e?this.getAllParents(t=>"row"===t.type&&e(t)):this.getAllParents(e=>"row"===e.type)}getColumn(e){return B(e),this.getParent(t=>"column"===t.type&&e(t))}getAllColumns(e){return B(e,!0),e?this.getAllParents(t=>"column"===t.type&&e(t)):this.getAllParents(e=>"column"===e.type)}getGroup(e){return B(e),this.getParent(t=>"group"===t.type&&e(t))}getAllGroups(e){return B(e,!0),e?this.getAllParents(t=>"group"===t.type&&e(t)):this.getAllParents(e=>"group"===e.type)}getWindow(e){B(e);const t=ut(this).children;return ut(this).controller.iterateFindChild(t,t=>"window"===t.type&&e(t))}getAllWindows(e){B(e,!0);const t=ut(this).children,r=ut(this).controller.iterateFilterChildren(t,e=>"window"===e.type);return e?r.filter(e):r}addRow(e){return ut(this).base.addParent(this,"row","workspace",e)}addColumn(e){return ut(this).base.addParent(this,"column","workspace",e)}addGroup(e){return ut(this).base.addParent(this,"group","workspace",e)}addWindow(e){return ut(this).base.addWindow(this,e,"workspace")}bundleToRow(){return o(this,void 0,void 0,(function*(){yield ut(this).controller.bundleTo("row",this.id),yield this.refreshReference()}))}bundleToColumn(){return o(this,void 0,void 0,(function*(){yield ut(this).controller.bundleTo("column",this.id),yield this.refreshReference()}))}onClosing(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"closing",streamType:"workspace",level:"workspace",levelId:t,callback:()=>o(this,void 0,void 0,(function*(){yield this.refreshReference(),e()}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onClosed(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"closed",streamType:"workspace",level:"workspace",levelId:t,callback:()=>o(this,void 0,void 0,(function*(){e()}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onFocusChange(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"focus",streamType:"workspace",level:"workspace",levelId:t,callback:()=>o(this,void 0,void 0,(function*(){yield this.refreshReference(),e()}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onWindowAdded(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"added",streamType:"window",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference();const r=this.getParent(e=>e.id===t.windowSummary.parentId);console.log("workspace window added payload",t);const n=r.children.find(e=>(console.log("checking child",e),"window"===e.type&&e.positionIndex===t.windowSummary.config.positionIndex));e(n)}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onWindowRemoved(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"removed",streamType:"window",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference();const{windowId:r,workspaceId:n,frameId:i}=t.windowSummary.config;e({windowId:r,workspaceId:n,frameId:i})}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onWindowLoaded(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"loaded",streamType:"window",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference(),console.log("payload for window loaded",t);const r=this.getWindow(e=>(console.log("Window checked",e),e.id&&e.id===t.windowSummary.config.windowId));console.log("found window",r),e(r)}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onWindowFocusChange(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"focus",streamType:"window",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){this.refreshReference();const r=this.getWindow(e=>e.id&&e.id===t.windowSummary.config.windowId);e(r)}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onParentAdded(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"added",streamType:"container",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference();const r=this.getParent(e=>e.id===t.containerSummary.itemId);e(r)}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onParentRemoved(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"removed",streamType:"container",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference();const{workspaceId:r,frameId:n}=t.containerSummary.config;e({id:t.containerSummary.itemId,workspaceId:r,frameId:n})}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}onParentUpdated(e){return o(this,void 0,void 0,(function*(){B(e);const t=ut(this).id,r={action:"childrenUpdate",streamType:"container",level:"workspace",levelId:t,callback:t=>o(this,void 0,void 0,(function*(){yield this.refreshReference();const r=this.getParent(e=>e.id===t.containerSummary.itemId);e(r)}))};return yield ut(this).controller.processLocalSubscription(r,t)}))}}const ht=new WeakMap,pt=e=>ht.get(e).manager.getWindowData(e);class ft{constructor(e){ht.set(this,{manager:e}),console.log("private data for window",pt(this))}get id(){return pt(this).config.windowId}get type(){return"window"}get frameId(){return pt(this).frame.id}get workspaceId(){return pt(this).workspace.id}get positionIndex(){return pt(this).config.positionIndex}get isMaximized(){return pt(this).config.isMaximized}get isLoaded(){return pt(this).config.isLoaded}get focused(){return pt(this).config.isFocused}get title(){return pt(this).config.title}get workspace(){return pt(this).workspace}get frame(){return pt(this).frame}get parent(){return pt(this).parent}forceLoad(){return o(this,void 0,void 0,(function*(){if(this.isLoaded)return;const e=pt(this).controller,t=pt(this).id,r=yield e.forceLoadWindow(t);console.log("Private data for window",r),pt(this).config.windowId=r,pt(this).config.isLoaded=!0}))}focus(){return o(this,void 0,void 0,(function*(){const e=pt(this).id,t=pt(this).controller;yield t.focusItem(e)}))}close(){return o(this,void 0,void 0,(function*(){const e=pt(this).id,t=pt(this).controller;yield t.closeItem(e),yield pt(this).parent.removeChild(t=>t.id===e)}))}setTitle(e){return o(this,void 0,void 0,(function*(){j.runWithException(e);const t=pt(this).id,r=pt(this).controller;yield r.setItemTitle(t,e)}))}maximize(){return o(this,void 0,void 0,(function*(){const e=pt(this).id,t=pt(this).controller;yield t.maximizeItem(e)}))}restore(){return o(this,void 0,void 0,(function*(){const e=pt(this).id,t=pt(this).controller;yield t.restoreItem(e)}))}eject(){return o(this,void 0,void 0,(function*(){if(!this.isLoaded)throw new Error("Cannot eject this window, because it is not loaded yet");const e=pt(this).id;return yield pt(this).controller.ejectWindow(e),this.getGdWindow()}))}getGdWindow(){if(!this.isLoaded)throw new Error("Cannot fetch this GD window, because the window is not yet loaded");const e=pt(this).config.windowId;return pt(this).controller.getGDWindow(e)}moveTo(e){return o(this,void 0,void 0,(function*(){if(!(e instanceof tt||e instanceof it||e instanceof at))throw new Error("Cannot add to the provided parent, because the provided parent is not an instance of Row, Column or Group");const t=pt(this).id,r=pt(this).controller;if(!(yield r.getParent(t=>t.id===e.id)))throw new Error("Cannot move the window to the selected parent, because this parent does not exist.");return r.moveWindowTo(t,e.id)}))}onAdded(e){return o(this,void 0,void 0,(function*(){B(e);const t=pt(this).id,r={callback:()=>o(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),e()})),action:"added",streamType:"window",level:"window"};return yield pt(this).controller.processLocalSubscription(r,t)}))}onLoaded(e){return o(this,void 0,void 0,(function*(){B(e);const t=pt(this).id,r={callback:()=>o(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),e()})),action:"loaded",streamType:"window",level:"window"};return yield pt(this).controller.processLocalSubscription(r,t)}))}onParentChanged(e){return o(this,void 0,void 0,(function*(){B(e);const t=pt(this).id,r={callback:()=>o(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),e(this.parent)})),action:"containerChange",streamType:"window",level:"window"};return yield pt(this).controller.processLocalSubscription(r,t)}))}onRemoved(e){return o(this,void 0,void 0,(function*(){B(e);const t=pt(this).id,r={callback:()=>o(this,void 0,void 0,(function*(){yield this.workspace.refreshReference(),e()})),action:"removed",streamType:"window",level:"window"};return yield pt(this).controller.processLocalSubscription(r,t)}))}}const mt=new WeakMap,gt=e=>mt.get(e).manager.getFrameData(e),vt=e=>mt.get(e).manager;class yt{constructor(e){mt.set(this,{manager:e})}get id(){return gt(this).summary.id}resize(e){const t=We.runWithException(e),r=gt(this).summary.id;return gt(this).controller.resizeItem(r,t)}move(e){const t=Ce.runWithException(e),r=gt(this).summary.id;return gt(this).controller.moveFrame(r,t)}focus(){const e=gt(this).summary.id;return gt(this).controller.focusItem(e)}close(){const e=gt(this).summary.id;return gt(this).controller.closeItem(e)}snapshot(){const e=gt(this).summary.id;return gt(this).controller.getSnapshot(e,"frame")}workspaces(){return o(this,void 0,void 0,(function*(){return gt(this).controller.getWorkspaces(e=>e.frameId===this.id)}))}restoreWorkspace(e,t){return o(this,void 0,void 0,(function*(){j.runWithException(e);const r=$.runWithException(t);return gt(this).controller.restoreWorkspace(e,r)}))}createWorkspace(e,t){const r=V.runWithException(e),n=U.runWithException(t);return gt(this).controller.createWorkspace(r,n)}onClosing(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{vt(this).remapFrame(this,t.frameSummary),e(this)},action:"closing",streamType:"frame",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onClosed(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{e({frameId:t.frameSummary.id})},action:"closed",streamType:"frame",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onFocusChange(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{vt(this).remapFrame(this,t.frameSummary),e(this)},action:"focus",streamType:"frame",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWorkspaceOpened(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=yield gt(this).controller.getWorkspace(e=>e.id===t.workspaceSummary.id);e(r)})),action:"added",streamType:"workspace",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWorkspaceFocusChange(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=yield gt(this).controller.getWorkspace(e=>e.id===t.workspaceSummary.id);e(r)})),action:"focus",streamType:"workspace",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWorkspaceClosing(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=yield gt(this).controller.getWorkspace(e=>e.id===t.workspaceSummary.id);e(r)})),action:"focus",streamType:"workspace",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWorkspaceClosed(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{console.log("workspace closed callback invoked"),e({frameId:t.frameSummary.id,workspaceId:t.workspaceSummary.id})},action:"closed",streamType:"workspace",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWindowAdded(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=(yield gt(this).controller.getParent(e=>e.id===t.windowSummary.parentId)).children.find(e=>"window"===e.type&&e.positionIndex===t.windowSummary.config.positionIndex);e(r)})),action:"added",streamType:"window",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWindowRemoved(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{const{windowId:r,workspaceId:n,frameId:i}=t.windowSummary.config;e({windowId:r,workspaceId:n,frameId:i})},action:"removed",streamType:"window",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWindowLoaded(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=(yield gt(this).controller.getParent(e=>(console.log("Parent checked",e),e.id===t.windowSummary.parentId))).children.find(e=>"window"===e.type&&e.positionIndex===t.windowSummary.config.positionIndex);e(r)})),action:"loaded",streamType:"window",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onWindowFocusChange(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=(yield gt(this).controller.getParent(e=>e.id===t.windowSummary.parentId)).children.find(e=>"window"===e.type&&e.positionIndex===t.windowSummary.config.positionIndex);e(r)})),action:"focus",streamType:"window",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onParentAdded(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=yield gt(this).controller.getParent(e=>e.id===t.containerSummary.itemId);e(r)})),action:"added",streamType:"container",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onParentRemoved(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>{const{workspaceId:r,frameId:n}=t.containerSummary.config;e({id:t.containerSummary.itemId,workspaceId:r,frameId:n})},action:"removed",streamType:"container",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}onParentUpdated(e){return o(this,void 0,void 0,(function*(){B(e);const t=gt(this).summary.id,r={callback:t=>o(this,void 0,void 0,(function*(){const r=yield gt(this).controller.getParent(e=>e.id===t.containerSummary.itemId);e(r)})),action:"childrenUpdate",streamType:"container",level:"frame"};return yield gt(this).controller.processLocalSubscription(r,t)}))}}class wt{constructor(){this.parentsData=new WeakMap,this.workspacesData=new WeakMap,this.windowsData=new WeakMap,this.framesData=new WeakMap,this.windowPlacementIdData={}}deleteData(e){if(e instanceof ft){const t=Object.keys(this.windowPlacementIdData).find(t=>this.windowPlacementIdData[t]===e);t&&delete this.windowPlacementIdData[t],this.windowsData.delete(e)}e instanceof lt&&this.workspacesData.delete(e),(e instanceof tt||e instanceof it||e instanceof at)&&this.parentsData.delete(e),e instanceof yt&&this.framesData.delete(e)}setWindowData(e,t){console.log("setting window data",t),this.windowPlacementIdData[t.id]=e,this.windowsData.set(e,t)}setWorkspaceData(e,t){this.workspacesData.set(e,t)}setParentData(e,t){this.parentsData.set(e,t)}setFrameData(e,t){this.framesData.set(e,t)}getWindowData(e){return this.windowsData.get(e)}getWindowByPlacementId(e){return this.windowPlacementIdData[e]}getWorkspaceData(e){return this.workspacesData.get(e)}getParentData(e){return this.parentsData.get(e)}getFrameData(e){return this.framesData.get(e)}remapChild(e,t){if(e instanceof ft){const r=this.windowsData.get(e);r.parent=t.parent||r.parent,r.config=t.config||r.config}if(e instanceof tt||e instanceof it||e instanceof at){const r=this.parentsData.get(e);r.parent=t.parent||r.parent,r.config=t.config||r.config,r.children=t.children||r.children}}remapFrame(e,t){this.framesData.get(e).summary=t}remapWorkspace(e,t){const r=this.workspacesData.get(e);r.frame=t.frame||r.frame,r.config=t.config||r.config,r.children=t.children||r.children}}const bt=new WeakMap,It=(e,t)=>{const r=bt.get(e).manager;return t instanceof lt?r.getWorkspaceData(t):bt.get(e).manager.getParentData(t)},kt=(e,t)=>bt.get(e).manager.getWindowByPlacementId(t);class St{constructor(e){bt.set(this,{manager:e})}getId(e){return It(this,e).id}getPositionIndex(e){return It(this,e).config.positionIndex}getWorkspaceId(e){const t=It(this,e);return t.config.workspaceId||t.workspace.id}getFrameId(e){return It(this,e).frame.id}getAllChildren(e,t){B(t,!0);const r=It(this,e).children;return void 0===t?r:r.filter(t)}getMyParent(e){if(!(e instanceof lt))return It(this,e).parent}getMyFrame(e){return It(this,e).frame}getMyWorkspace(e){if(!(e instanceof lt))return It(this,e).workspace}addWindow(e,t,r){return o(this,void 0,void 0,(function*(){if(!t.appName&&!t.windowId)throw new Error("The window definition should contain either an appName or a windowId");const n=G.runWithException(t),i=It(this,e).controller,o=yield i.add("window",It(this,e).id,r,n);return console.log("add window operation reuslt",o),e instanceof lt?(yield e.refreshReference(),kt(this,o.itemId)):(yield this.getMyWorkspace(e).refreshReference(),kt(this,o.itemId))}))}addParent(e,t,r,n){return o(this,void 0,void 0,(function*(){const i=this.transformDefinition(t,n),o=It(this,e).controller,s=(yield o.add("container",It(this,e).id,r,i)).itemId;if(e instanceof lt)return yield e.refreshReference(),e.getParent(e=>e.id===s);const a=this.getMyWorkspace(e);return yield a.refreshReference(),a.getParent(e=>e.id===s)}))}removeChild(e,t){return o(this,void 0,void 0,(function*(){B(t);const r=this.getAllChildren(e).find(t);if(r){if(console.log("will close child"),yield r.close(),e instanceof lt)return console.log("will get reference 1",e.children),yield e.refreshReference(),void console.log("allchildren",e.children);console.log("will get reference",e.children),yield this.getMyWorkspace(e).refreshReference(),console.log("allchildren",e.children)}}))}maximize(e){return o(this,void 0,void 0,(function*(){const t=It(this,e).controller;yield t.maximizeItem(It(this,e).id)}))}restore(e){return o(this,void 0,void 0,(function*(){const t=It(this,e).controller;yield t.restoreItem(It(this,e).id)}))}close(e){return o(this,void 0,void 0,(function*(){const t=It(this,e),r=It(this,e).controller;yield r.closeItem(t.id),t.parent instanceof lt?(yield t.parent.refreshReference(),console.log("workspace reference refreshed",t.parent.children)):(yield this.getMyWorkspace(t.parent).refreshReference(),console.log(" reference refreshed",t.parent.children))}))}transformDefinition(e,t){let r;return void 0===t?r={type:e,children:[]}:t instanceof Ye?r=t.serialize():(void 0===t.type&&(t.type=e),r=H.runWithException(t),r.children=r.children||[]),r}}class xt{constructor(e,t,r,n){this.bridge=e,this.frameUtils=t,this.layouts=r,this.base=n}checkIsInSwimlane(e){return o(this,void 0,void 0,(function*(){const t=this.frameUtils.getAllFrameInstances();if(!t.length)return!1;return(yield Promise.all(t.map(t=>this.bridge.send(qe.isWindowInWorkspace.name,{itemId:e},t)))).some(e=>e.inWorkspace)}))}createWorkspace(e,t){var r,n;return o(this,void 0,void 0,(function*(){const i=Object.assign({},e,{saveConfig:t}),o={frameId:null===(r=e.frame)||void 0===r?void 0:r.reuseFrameId,newFrame:null===(n=e.frame)||void 0===n?void 0:n.newFrame},s=yield this.frameUtils.getFrameInstance(o),a=yield this.base.createWorkspace(i,s);return yield this.frameUtils.focusFrame(s),a}))}restoreWorkspace(e,t){return o(this,void 0,void 0,(function*(){if(!(yield this.getLayoutSummaries()).some(t=>t.name===e))throw new Error(`This layout: ${e} cannot be restored, because it doesn't exist.`);const r=yield this.frameUtils.getFrameInstance({frameId:null==t?void 0:t.frameId,newFrame:null==t?void 0:t.newFrame}),n=yield this.base.restoreWorkspace(e,t,r);return yield this.frameUtils.focusFrame(r),n}))}add(e,t,r,n){return o(this,void 0,void 0,(function*(){const i=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.add(e,t,r,n,i)}))}processLocalSubscription(){return o(this,void 0,void 0,(function*(){throw new Error("Workspaces events are not supported in Glue42 Core.")}))}processGlobalSubscription(){return o(this,void 0,void 0,(function*(){throw new Error("Workspaces events are not supported in Glue42 Core.")}))}getFrame(e){return o(this,void 0,void 0,(function*(){if(e.windowId){const t=yield this.frameUtils.getFrameInstanceByItemId(e.windowId);return yield this.base.getFrame(e.windowId,t)}if(e.predicate)return(yield this.getFrames(e.predicate))[0];throw new Error("The provided selector is not valid: "+JSON.stringify(e))}))}getFrames(e){return o(this,void 0,void 0,(function*(){const t=this.frameUtils.getAllFrameInstances(),r=yield Promise.all(t.map(e=>this.bridge.send(qe.getFrameSummary.name,{itemId:e.peerId},e)));return this.base.getFrames(r,e)}))}getWorkspace(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{e(r)&&(t=r,n())}),t}))}getWorkspaces(e){return o(this,void 0,void 0,(function*(){const t=[];return yield this.iterateWorkspaces(r=>{e&&!e(r)||t.push(r)}),t}))}getAllWorkspaceSummaries(){return o(this,void 0,void 0,(function*(){const e=this.frameUtils.getAllFrameInstances(),t=yield Promise.all(e.map(e=>this.bridge.send(qe.getAllWorkspacesSummaries.name,{},e)));return this.base.getAllWorkspaceSummaries(...t)}))}getWindow(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{const i=r.getWindow(e);i&&(t=i,n())}),t}))}getParent(e){return o(this,void 0,void 0,(function*(){let t;return yield this.iterateWorkspaces((r,n)=>{const i=r.getParent(e);i&&(t=i,n())}),t}))}getLayoutSummaries(){return o(this,void 0,void 0,(function*(){return(yield this.layouts.getAll("Workspace")).map(e=>({name:e.name}))}))}deleteLayout(e){return o(this,void 0,void 0,(function*(){yield this.layouts.remove("Workspace",e)}))}exportLayout(e){return o(this,void 0,void 0,(function*(){return(yield this.layouts.export("Workspace")).reduce((t,r)=>(e&&!e(r)||t.push(r),t),[])}))}importLayout(e){return o(this,void 0,void 0,(function*(){yield this.layouts.import(e)}))}saveLayout(e){return o(this,void 0,void 0,(function*(){if(!this.frameUtils.getAllFrameInstances().length)throw new Error(`Cannot save the layout with config: ${JSON.stringify(e)}, because no active frames were found`);const t=yield this.frameUtils.getFrameInstanceByItemId(e.workspaceId);return yield this.bridge.send(qe.saveLayout.name,{name:e.name,workspaceId:e.workspaceId},t)}))}bundleTo(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(t);return yield this.base.bundleTo(e,t,r)}))}restoreItem(e){return o(this,void 0,void 0,(function*(){const t=yield this.frameUtils.getFrameInstanceByItemId(e);yield this.base.restoreItem(e,t)}))}maximizeItem(e){return o(this,void 0,void 0,(function*(){const t=yield this.frameUtils.getFrameInstanceByItemId(e);yield this.base.maximizeItem(e,t)}))}focusItem(e){return o(this,void 0,void 0,(function*(){const t=yield this.frameUtils.getFrameInstanceByItemId(e);yield this.base.focusItem(e,t)}))}closeItem(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e),n=e===r.peerId;return yield this.base.closeItem(e,r),n?yield this.frameUtils.closeFrame(r):t?yield t.close():void 0}))}resizeItem(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e);yield this.base.resizeItem(e,t,r),yield this.frameUtils.resizeFrame(e,t)}))}moveFrame(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e);yield this.base.moveFrame(e,t,r),yield this.frameUtils.moveFrame(e,t)}))}getGDWindow(e){return this.base.getGDWindow(e)}forceLoadWindow(e){return o(this,void 0,void 0,(function*(){const t=yield this.frameUtils.getFrameInstanceByItemId(e);return yield this.base.forceLoadWindow(e,t)}))}ejectWindow(e){return o(this,void 0,void 0,(function*(){const t=yield this.frameUtils.getFrameInstanceByItemId(e);return yield this.base.ejectWindow(e,t)}))}moveWindowTo(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e);return yield this.base.moveWindowTo(e,t,r)}))}getSnapshot(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e);return yield this.base.getSnapshot(e,t,r)}))}setItemTitle(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.frameUtils.getFrameInstanceByItemId(e);return yield this.base.setItemTitle(e,t,r)}))}refreshChildren(e){return this.base.refreshChildren(e)}iterateFindChild(e,t){return this.base.iterateFindChild(e,t)}iterateFilterChildren(e,t){return this.base.iterateFilterChildren(e,t)}iterateWorkspaces(e){return o(this,void 0,void 0,(function*(){let t=!1;const r=()=>{t=!0},n=yield this.getAllWorkspaceSummaries();for(const i of n){if(t)return;const n=yield this.frameUtils.getFrameInstance({frameId:i.frameId}),o=yield this.base.fetchWorkspace(i.id,n);e(o,r)}}))}}class Wt{constructor(e,t,r,n){this.interop=e,this.windows=t,this.bridge=r,this.assetsBaseLocation=n,this.workspacesIndex="/workspaces/",this.defaultAssetsBase="/glue",this.defaultWidth=1280,this.defaultHeight=720;const i=location.href.includes("csb.app")?"/index.html":"";this.workspacesRoute=`${this.assetsBaseLocation||this.defaultAssetsBase}${this.workspacesIndex}${i}`}getAllFrameInstances(){return this.interop.servers().filter(e=>{var t;if(null==e?void 0:e.getMethods)return null===(t=e.getMethods())||void 0===t?void 0:t.some(e=>e.name===ze.control.name)})}focusFrame(e){return o(this,void 0,void 0,(function*(){const t=this.windows.list().find(t=>t.id===e.windowId);console.log("calling the undelying window focus"),yield t.focus()}))}getFrameInstance(e){return o(this,void 0,void 0,(function*(){if((null==e?void 0:e.frameId)&&(null==e?void 0:e.newFrame))throw new Error("Cannot retrieve the frame, because of over-specification: both frameId and newFrame were provided.");const t=this.getAllFrameInstances();if(null==e?void 0:e.frameId){const r=t.find(t=>t.peerId===e.frameId);if(!r)throw new Error(`Frame with id: ${e.frameId} was not found`);return r}return(null==e?void 0:e.newFrame)?this.openNewWorkspacesFrame(e.newFrame):t.length?this.getLastFrameInteropInstance():this.openNewWorkspacesFrame()}))}getFrameInstanceByItemId(e){return o(this,void 0,void 0,(function*(){const t=this.getAllFrameInstances(),r=(yield Promise.all(t.map(t=>this.bridge.send(qe.getFrameSummary.name,{itemId:e},t)))).find(e=>"none"!==e.id);if(!r)throw new Error("Cannot find frame for item: "+e);return yield this.getFrameInstance({frameId:r.id})}))}getLastFrameInteropInstance(){return this.getAllFrameInstances().sort((e,t)=>{const r=(null==e?void 0:e.peerId)?+e.peerId.slice(e.peerId.lastIndexOf("-")+1):0;return((null==t?void 0:t.peerId)?+t.peerId.slice(t.peerId.lastIndexOf("-")+1):0)-r})[0]}openNewWorkspacesFrame(e){return new Promise((t,r)=>{var n,i;const o=this.getAllFrameInstances().length;let s;const a=this.interop.serverMethodAdded(e=>{if(!(null==e?void 0:e.server)||!(null==e?void 0:e.method))return;const r=e.method.name===ze.control.name,n=e.server.windowId===(null==s?void 0:s.id);(null==s?void 0:s.id)&&r&&n&&(a(),t(e.server))}),c={url:this.workspacesRoute+"?emptyFrame=true",width:"object"==typeof e&&(null===(n=e.bounds)||void 0===n?void 0:n.width)||this.defaultWidth,height:"object"==typeof e&&(null===(i=e.bounds)||void 0===i?void 0:i.height)||this.defaultHeight};this.windows.open("frame_"+(o+1),c.url,c).then(e=>{s=e;const r=this.interop.servers().find(e=>{const t=e.windowId===s.id,r=e.getMethods().some(e=>e.name===ze.control.name);return t&&r});r&&(a(),t(r))}).catch(r)})}closeFrame(e){return o(this,void 0,void 0,(function*(){const t=this.windows.list().find(t=>t.id===e.windowId);yield t.close()}))}moveFrame(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.getFrameInstanceByItemId(e);if(e!==r.peerId)return;const n=this.windows.list().find(e=>e.id===r.windowId);t.relative?yield n.moveTo(t.top,t.left):yield n.moveResize({top:t.top,left:t.left})}))}resizeFrame(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.getFrameInstanceByItemId(e);if(e!==r.peerId)return;const n=this.windows.list().find(e=>e.id===r.windowId);t.relative?yield n.resizeTo(t.width,t.height):yield n.moveResize({width:t.width,height:t.height})}))}}class Ct{constructor(e,t){this.ioc=e,this.windows=t}get bridge(){return this.ioc.bridge}get privateDataManager(){return this.ioc.privateDataManager}createWorkspace(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.bridge.send(qe.createWorkspace.name,e,t),n={summary:r.frameSummary},i={frame:this.ioc.getModel("frame",n),snapshot:r};return this.ioc.getModel("workspace",i)}))}restoreWorkspace(e,t,r){return o(this,void 0,void 0,(function*(){const n=yield this.bridge.send(qe.openWorkspace.name,{name:e,restoreOptions:t},r),i={summary:yield this.bridge.send(qe.getFrameSummary.name,{itemId:n.config.frameId},r)},o={frame:this.ioc.getModel("frame",i),snapshot:n};return this.ioc.getModel("workspace",o)}))}add(e,t,r,n,i){return o(this,void 0,void 0,(function*(){let o;const s={definition:n,parentId:t,parentType:r};if("window"===e)o=qe.addWindow.name;else{if("container"!==e)throw new Error("Unrecognized add type: "+e);o=qe.addContainer.name}return yield this.bridge.send(o,s,i)}))}getFrame(e,t){return o(this,void 0,void 0,(function*(){const r={summary:yield this.bridge.send(qe.getFrameSummary.name,{itemId:e},t)};return this.ioc.getModel("frame",r)}))}getFrames(e,t){return e.reduce((e,r)=>{const n={summary:r},i=this.ioc.getModel("frame",n);return t&&!t(i)||e.push(i),e},[])}getAllWorkspaceSummaries(...e){return e.reduce((e,t)=>(e.push(...t.summaries),e),[]).map(e=>({id:e.id,frameId:e.config.frameId,positionIndex:e.config.positionIndex,title:e.config.title}))}fetchWorkspace(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.bridge.send(qe.getWorkspaceSnapshot.name,{itemId:e},t),n={summary:r.frameSummary},i={frame:this.ioc.getModel("frame",n),snapshot:r};return this.ioc.getModel("workspace",i)}))}bundleTo(e,t,r){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.bundleWorkspace.name,{type:e,workspaceId:t},r)}))}restoreItem(e,t){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.restoreItem.name,{itemId:e},t)}))}maximizeItem(e,t){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.maximizeItem.name,{itemId:e},t)}))}focusItem(e,t){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.focusItem.name,{itemId:e},t)}))}closeItem(e,t){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.closeItem.name,{itemId:e},t)}))}resizeItem(e,t,r){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.resizeItem.name,Object.assign({},{itemId:e},t),r)}))}moveFrame(e,t,r){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.moveFrame.name,Object.assign({},{itemId:e},t),r)}))}getGDWindow(e){return this.windows.list().find(t=>t.id===e)}forceLoadWindow(e,t){return o(this,void 0,void 0,(function*(){return(yield this.bridge.send(qe.forceLoadWindow.name,{itemId:e},t)).windowId}))}ejectWindow(e,t){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.ejectWindow.name,{itemId:e},t)}))}moveWindowTo(e,t,r){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.moveWindowTo.name,{itemId:e,containerId:t},r)}))}getSnapshot(e,t,r){return o(this,void 0,void 0,(function*(){let n;return"workspace"===t?n=yield this.bridge.send(qe.getWorkspaceSnapshot.name,{itemId:e},r):"frame"===t&&(n=yield this.bridge.send(qe.getFrameSnapshot.name,{itemId:e},r)),n}))}setItemTitle(e,t,r){return o(this,void 0,void 0,(function*(){yield this.bridge.send(qe.setItemTitle.name,{itemId:e,title:t},r)}))}refreshChildren(e){const{parent:t,children:r,existingChildren:n,workspace:i}=e;if(t instanceof ft)return;const o=r.map(e=>{let r=n.find(t=>t.id===e.id);const o=e.type;if(r)this.privateDataManager.remapChild(r,{parent:t,children:[],config:e.config});else if("window"===o){const n={id:e.id,parent:t,frame:i.frame,workspace:i,config:e.config};r=this.ioc.getModel(o,n)}else{const n={id:e.id,children:[],parent:t,frame:i.frame,workspace:i,config:e.config};r=this.ioc.getModel(o,n)}return"window"!==o&&this.refreshChildren({workspace:i,existingChildren:n,children:e.children,parent:r}),r});return t instanceof lt||this.privateDataManager.remapChild(t,{children:o}),o}iterateFindChild(e,t){let r=e.find(e=>t(e));return r||(e.some(e=>!(e instanceof ft)&&(r=this.iterateFindChild(e.children,t),!!r||void 0)),r)}iterateFilterChildren(e,t){const r=e.filter(e=>t(e)),n=e.reduce((e,r)=>(r instanceof ft||e.push(...this.iterateFilterChildren(r.children,t)),e),[]);return r.push(...n),r}}class Tt{constructor(e,t,r,n){this.agm=e,this.windows=t,this.layouts=r,this.assetsBaseLocation=n}get baseController(){return this._baseController||(this._baseController=new Ct(this,this.windows)),this._baseController}get controller(){return this._controllerInstance||(this._controllerInstance=window.glue42gd?new He(this.bridge,this.baseController):new xt(this.bridge,new Wt(this.agm,this.windows,this.bridge,this.assetsBaseLocation),this.layouts,this.baseController)),this._controllerInstance}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new Je(this.transport,a())),this._bridgeInstance}get transport(){return this._transportInstance||(this._transportInstance=new Ke(this.agm)),this._transportInstance}get privateDataManager(){return this._privateDataManagerInstance||(this._privateDataManagerInstance=new wt),this._privateDataManagerInstance}get parentBase(){return this._parentBaseInstance||(this._parentBaseInstance=new St(this.privateDataManager)),this._parentBaseInstance}initiate(){return o(this,void 0,void 0,(function*(){yield this.transport.initiate()}))}getModel(e,t){switch(e){case"frame":{const e=new yt(this.privateDataManager),{summary:r}=t,n={summary:r,controller:this.controller};return this.privateDataManager.setFrameData(e,n),e}case"window":{const{id:e,parent:r,frame:n,workspace:i,config:o}=t,s={type:"window",controller:this.controller,config:o,id:e,parent:r,frame:n,workspace:i},a=new ft(this.privateDataManager);return this.privateDataManager.setWindowData(a,s),a}case"row":case"column":case"group":{const{id:r,children:n,parent:i,frame:o,workspace:s,config:a}=t,c="column"===e?new it(this.parentBase):"row"===e?new tt(this.parentBase):new at(this.parentBase),u=this.buildChildren(n,o,s,c),d={id:r,parent:i,frame:o,workspace:s,config:a,type:e,controller:this.controller,children:u};return this.privateDataManager.setParentData(c,d),c}case"workspace":{const{snapshot:e,frame:r}=t,n=new lt(this.privateDataManager);console.log("building children with this snapshot",e);const i=this.buildChildren(e.children,r,n,n),o={id:e.id,type:"workspace",config:e.config,base:this.parentBase,controller:this.controller,children:i,frame:r,ioc:this};return this.privateDataManager.setWorkspaceData(n,o),n}default:throw new Error("Unrecognized type: "+e)}}getBuilder(e){e.definition=e.definition||{},Array.isArray(e.definition.children)||(e.definition.children=[]);const t=new Ve(this.getBuilder.bind(this));switch(e.type){case"workspace":return new Ze(e.definition,t,this.controller);case"row":case"column":case"group":return e.definition.type=e.type,new Ye(e.definition,t);default:throw new Error("Unexpected Builder creation error, provided config: "+JSON.stringify(e))}}buildChildren(e,t,r,n){return e.map(e=>{switch(e.type){case"window":return this.getModel("window",{id:e.id,config:e.config,frame:t,workspace:r,parent:n});case"column":case"row":case"group":return this.getModel(e.type,{id:e.id,config:e.config,children:e.children,frame:t,workspace:r,parent:n});default:throw new Error("Unsupported child type: "+e.type)}})}}const Et=(e,t)=>o(void 0,void 0,void 0,(function*(){var r;const n=new Tt(e.agm,e.windows,e.layouts,null===(r=null==t?void 0:t.assets)||void 0===r?void 0:r.location);yield n.initiate(),e.workspaces=((e,t)=>{const r=t.controller;return{inWorkspace:()=>{const t=e.windows.my().id;if(!t)throw new Error("Cannot get my frame, because my id is undefined.");return r.checkIsInSwimlane(t)},getBuilder:e=>{const r=X.runWithException(e);return t.getBuilder(r)},getMyFrame:()=>o(void 0,void 0,void 0,(function*(){const t=e.windows.my().id;if(!t)throw new Error("Cannot get my frame, because my id is undefined.");if(!(yield r.checkIsInSwimlane(t)))throw new Error("Cannot fetch your frame, because this window is not in a workspace");return r.getFrame({windowId:t})})),getFrame:e=>o(void 0,void 0,void 0,(function*(){return B(e),r.getFrame({predicate:e})})),getAllFrames:e=>o(void 0,void 0,void 0,(function*(){return B(e,!0),r.getFrames(e)})),getAllWorkspacesSummaries:()=>r.getAllWorkspaceSummaries(),getMyWorkspace:()=>o(void 0,void 0,void 0,(function*(){const t=e.windows.my().id;if(!t)throw new Error("Cannot get my workspace, because my id is undefined.");if(!(yield r.checkIsInSwimlane(t)))throw new Error("Cannot fetch your workspace, because this window is not in a workspace");return(yield r.getWorkspaces(e=>!!e.getWindow(e=>e.id===t)))[0]})),getWorkspace:e=>o(void 0,void 0,void 0,(function*(){return B(e),(yield r.getWorkspaces(e))[0]})),getAllWorkspaces:e=>(B(e,!0),r.getWorkspaces(e)),getWindow:e=>o(void 0,void 0,void 0,(function*(){return B(e),r.getWindow(e)})),getParent:e=>o(void 0,void 0,void 0,(function*(){return B(e),r.getParent(e)})),restoreWorkspace:(e,t)=>o(void 0,void 0,void 0,(function*(){j.runWithException(e);const n=$.runWithException(t);return r.restoreWorkspace(e,n)})),createWorkspace:(e,t)=>o(void 0,void 0,void 0,(function*(){const n=V.runWithException(e),i=U.runWithException(t);return r.createWorkspace(n,i)})),layouts:{getSummaries:()=>r.getLayoutSummaries(),delete:e=>o(void 0,void 0,void 0,(function*(){return j.runWithException(e),r.deleteLayout(e)})),export:e=>o(void 0,void 0,void 0,(function*(){return B(e,!0),r.exportLayout(e)})),import:e=>o(void 0,void 0,void 0,(function*(){if(!Array.isArray(e))throw new Error("The provided layouts argument is not an array: "+JSON.stringify(e));return e.forEach(e=>fe.runWithException(e)),r.importLayout(e)})),save:e=>o(void 0,void 0,void 0,(function*(){const t=Ue.runWithException(e);return r.saveLayout(t)}))},onFrameOpened:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(r=>{const n={summary:r.frameSummary},i=t.getModel("frame",n);e(i)},"frame","opened")})),onFrameClosing:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(r=>{const n={summary:r.frameSummary},i=t.getModel("frame",n);e(i)},"frame","closing")})),onFrameClosed:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(t=>{e({frameId:t.frameSummary.id})},"frame","closed")})),onFrameFocusChange:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(r=>{const n={summary:r.frameSummary},i=t.getModel("frame",n);e(i)},"frame","focus")})),onWorkspaceOpened:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i={summary:n.frameSummary},o={frame:t.getModel("frame",i),snapshot:yield r.getSnapshot(n.workspaceSummary.id,"workspace")},s=t.getModel("workspace",o);e(s)})),"workspace","opened")})),onWorkspaceClosing:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i={summary:n.frameSummary},o={frame:t.getModel("frame",i),snapshot:yield r.getSnapshot(n.workspaceSummary.id,"workspace")},s=t.getModel("workspace",o);e(s)})),"workspace","closing")})),onWorkspaceClosed:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(t=>{e({frameId:t.frameSummary.id,workspaceId:t.workspaceSummary.id})},"workspace","closed")})),onWorkspaceFocusChange:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i={summary:n.frameSummary},o={frame:t.getModel("frame",i),snapshot:yield r.getSnapshot(n.workspaceSummary.id,"workspace")},s=t.getModel("workspace",o);e(s)})),"workspace","focus")})),onWindowAdded:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i=yield r.getSnapshot(n.windowSummary.config.workspaceId,"workspace"),o={summary:i.frameSummary},s={frame:t.getModel("frame",o),snapshot:i},a=t.getModel("workspace",s).getParent(e=>e.id===n.windowSummary.parentId).children.find(e=>"window"===e.type&&e.positionIndex===n.windowSummary.config.positionIndex);e(a)})),"window","added")})),onWindowLoaded:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i=yield r.getSnapshot(n.windowSummary.config.workspaceId,"workspace"),o={summary:i.frameSummary},s={frame:t.getModel("frame",o),snapshot:i},a=t.getModel("workspace",s).getWindow(e=>e.id&&e.id===n.windowSummary.config.windowId);e(a)})),"window","loaded")})),onWindowRemoved:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(t=>{const{windowId:r,workspaceId:n,frameId:i}=t.windowSummary.config;e({windowId:r,workspaceId:n,frameId:i})},"window","removed")})),onWindowFocusChange:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i=yield r.getSnapshot(n.windowSummary.config.workspaceId,"workspace"),o={summary:i.frameSummary},s={frame:t.getModel("frame",o),snapshot:i},a=t.getModel("workspace",s).getWindow(e=>e.id&&e.id===n.windowSummary.config.windowId);e(a)})),"window","focus")})),onParentAdded:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(n=>o(void 0,void 0,void 0,(function*(){const i=yield r.getSnapshot(n.containerSummary.config.workspaceId,"workspace"),o={summary:i.frameSummary},s={frame:t.getModel("frame",o),snapshot:i},a=t.getModel("workspace",s).getParent(e=>e.id===n.containerSummary.itemId);e(a)})),"container","added")})),onParentRemoved:e=>o(void 0,void 0,void 0,(function*(){B(e);return yield r.processGlobalSubscription(t=>{const{workspaceId:r,frameId:n}=t.containerSummary.config;e({id:t.containerSummary.itemId,workspaceId:r,frameId:n})},"container","removed")}))}})(e,n)}));"undefined"!=typeof window&&(window.GlueWorkspaces=Et);const _t={application:"WorkspacesPopup",appManager:!0,libraries:[Et]};i()(_t).then(async e=>{window.interopId=e.interop.instance.peerId;let t={};const r=r=>{const n=e.agm.servers().find(e=>e.peerId===t.peerId);return window.glue.agm.invoke("T42.Workspaces.HidePopup",{type:r},n||"best")},n=()=>{const r=document.body.getBoundingClientRect(),n={width:r.width,height:r.height},i=e.agm.servers().find(e=>e.peerId===t.peerId);return window.glue.agm.invoke("T42.Workspaces.ResizePopup",{size:n},i||"best")},i=n=>{((e,t)=>{const r=e=>e&&-1!==e.toLowerCase().indexOf(t);return e.filter(e=>!t||r(e.title)||r(e.name))})(e.appManager.applications(),n).forEach(n=>{const i=(e=>{const t=document.createElement("template");return t.innerHTML=` \n            <a class="nav-link border-bottom border-secondary pb-2 px-2" href = "#" >\n            <div class="application d-flex flex-row justify-content-between">\n                <div class="application-name">\n                    ${e}\n            </div>\n            </div>\n        </a >`,t.content.children[0]})(n.title||n.name);i.onclick=async()=>{const i=(await e.workspaces.getAllWorkspaces()).find(e=>e.id===t.workspaceId),o=i.getParent(e=>e.id===t.laneId)||i,s=document.getElementById("rowColButton");if(s&&s.classList.contains("active")){const e={type:"group",children:[{type:"window",appName:n.name}]},t=o.type?o.parent:o,r={type:"column",children:[e]},i={type:"row",children:[e]};"row"===t.type?await t.addColumn(r):await t.addRow(i)}else await o.addWindow({type:"window",appName:n.name});r()},g.append(i)})},o=async()=>{(await e.layouts.getAll("Workspace")).filter(e=>"Workspace"===e.type).forEach(n=>{const i=((e,t)=>{const r=document.createElement("template");return r.innerHTML=`\n        <a class="nav-link border-bottom border-secondary pb-2 px-2" href="#">\n            <div class="align-items-center workspace d-flex flex-row">\n                <div class="workspace-icon mr-2"></div>\n                <div class="workspace-description">\n                    <h5 class="mb-0 text-truncate">${e}</h5>\n                </div>\n                <div class="close-icon ml-auto"></div>\n            </div>\n        </div>\n        </a>`,r.content.children[0]})(n.name);i.onclick=()=>{e.workspaces.restoreWorkspace(n.name,{frameId:t.frameId}).finally(()=>{r()})};Array.from(i.children[0].children).find(e=>e.classList.contains("close-icon")).onclick=t=>{t.stopPropagation(),e.workspaces.layouts.delete(n.name).then(()=>(Array.from(v.children).forEach(e=>e.remove()),o())).catch(e=>{u(),c(e.message)})},v.appendChild(i)})},s=(e,t)=>{document.getElementById(t).appendChild((e=>{const t=document.createElement("template");return t.innerHTML=`\n        <div class="invalid-feedback mt-0 d-block">\n            ${e||"Please choose a name."}\n        </div>`,t.content.children[0]})(e)),n().catch(e=>console.warn("Could not resize popup because "+JSON.stringify(e)))},a=e=>{const t=document.getElementById(e);Array.from(t.children).forEach(e=>e.remove()),n().catch(e=>console.warn("Could not resize popup because "+JSON.stringify(e)))},c=e=>{s(e,"delete-layout-feedback-container")},u=()=>{a("delete-layout-feedback-container")},d=()=>{a("feedback-container")};window.glue=e;const l=document.getElementsByClassName("add-application")[0],h=document.getElementsByClassName("save-workspace")[0],p=document.getElementsByClassName("add-workspace")[0],f=document.querySelector(".add-application div.row:nth-child(2)"),m=document.getElementById("createNewWorkspaceBtn"),g=document.getElementById("applicationsList"),v=document.getElementById("workspacesList");await e.agm.registerAsync("T42.Workspaces.ShowPopup",async(e,t,r,n)=>{switch(e.type){case"addApplication":await y(e.payload);break;case"saveWorkspace":w(e.payload);break;case"openWorkspace":await b(e.payload);break;default:n("invalid args type")}const i=document.body.getBoundingClientRect();r({width:i.width,height:i.height})}),i(),await o();const y=async r=>{l.style.display="",h.style.display="none",p.style.display="none",Array.from(g.children).forEach(e=>e.remove()),i();const n=(await e.workspaces.getAllWorkspaces()).find(e=>e.id===r.workspaceId),o=n.getParent(e=>e.id===r.laneId)||n;t=r;const s=document.getElementById("rowColButton"),a=document.getElementById("tabGroupButton");document.getElementById("appSearch").oninput=e=>{const t=e.target.value;Array.from(g.children).forEach(e=>e.remove()),i(t.toLowerCase())},s.onclick=()=>{a.classList.remove("active"),s.classList.add("active")},a.onclick=()=>{s.classList.remove("active"),a.classList.add("active")};let c=o.type||"workspace";"group"===c&&(c=o.parent.type||"workspace"),s.innerText="This "+(c.substring(0,1).toUpperCase()+c.substring(1)),"group"!==o.type?f.style.display="none":f.style.display=""},w=n=>{l.style.display="none",h.style.display="",p.style.display="none";const i=document.getElementById("saveWorkspaceButton"),o=document.getElementById("saveWorkspaceName");d(),o.onclick=()=>{d()},i.innerHTML=n.buildMode?"Download":"Save";i.onclick=async()=>{const i=o.value;if(i)try{if(n.buildMode){((e,t)=>{const r=document.createElement("a"),n="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e));document.body.append(r),r.setAttribute("href","data:"+n),r.setAttribute("download",t+".txt"),r.click(),r.remove()})(await(async(r,n)=>{const i=e.agm.servers().find(e=>e.peerId===t.peerId);return(await e.agm.invoke("T42.Workspaces.Control",{operation:r,operationArguments:n},i||"best")).returned})("generateLayout",{name:i,workspaceId:n.workspaceId}),i)}else await e.workspaces.layouts.save({name:i,workspaceId:n.workspaceId});o.value="",r()}catch(e){d(),a=e.message,s(a,"feedback-container")}var a}},b=async n=>{l.style.display="none",h.style.display="none",p.style.display="",t=n,u(),p.onclick=()=>{u()},Array.from(v.children).forEach(e=>e.remove()),await o(),m.onclick=()=>{e.workspaces.createWorkspace({children:[],frame:{newFrame:!1,reuseFrameId:t.frameId}}).finally(()=>{r()})}}})}]);